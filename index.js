"use strict";var Dt=Object.defineProperty;var It=(t,e,n)=>e in t?Dt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var ce=(t,e,n)=>It(t,typeof e!="symbol"?e+"":e,n);const Be=require("siyuan");function Q(){}function ut(t){return t()}function ze(){return Object.create(null)}function ue(t){t.forEach(ut)}function dt(t){return typeof t=="function"}function Ae(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Ct(t){return Object.keys(t).length===0}function ft(t,...e){if(t==null){for(const o of e)o(void 0);return Q}const n=t.subscribe(...e);return n.unsubscribe?()=>n.unsubscribe():n}function x(t){let e;return ft(t,n=>e=n)(),e}function gt(t,e,n){t.$$.on_destroy.push(ft(e,n))}const St=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function g(t,e){t.appendChild(e)}function H(t,e,n){t.insertBefore(e,n||null)}function U(t){t.parentNode&&t.parentNode.removeChild(t)}function _(t){return document.createElement(t)}function ae(t){return document.createTextNode(t)}function R(){return ae(" ")}function xe(){return ae("")}function G(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function h(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function Et(t){return Array.from(t.childNodes)}function Pe(t,e){e=""+e,t.data!==e&&(t.data=e)}function te(t,e){t.value=e??""}let ve;function ke(t){ve=t}function ht(){if(!ve)throw new Error("Function called outside component initialization");return ve}function pt(t){ht().$$.on_mount.push(t)}function At(t){ht().$$.on_destroy.push(t)}const me=[],Re=[];let we=[];const Ye=[],mt=Promise.resolve();let $e=!1;function bt(){$e||($e=!0,mt.then(wt))}function ge(){return bt(),mt}function Oe(t){we.push(t)}const Te=new Set;let he=0;function wt(){if(he!==0)return;const t=ve;do{try{for(;he<me.length;){const e=me[he];he++,ke(e),Ft(e.$$)}}catch(e){throw me.length=0,he=0,e}for(ke(null),me.length=0,he=0;Re.length;)Re.pop()();for(let e=0;e<we.length;e+=1){const n=we[e];Te.has(n)||(Te.add(n),n())}we.length=0}while(me.length);for(;Ye.length;)Ye.pop()();$e=!1,Te.clear(),ke(t)}function Ft(t){if(t.fragment!==null){t.update(),ue(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Oe)}}function Bt(t){const e=[],n=[];we.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),we=e}const Ie=new Set;let Tt;function qe(t,e){t&&t.i&&(Ie.delete(t),t.i(e))}function xt(t,e,n,o){if(t&&t.o){if(Ie.has(t))return;Ie.add(t),Tt.c.push(()=>{Ie.delete(t)}),t.o(e)}}function be(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function Ne(t,e){t.d(1),e.delete(t.key)}function Me(t,e,n,o,r,s,l,i,u,c,y,p){let C=t.length,w=s.length,f=C;const F={};for(;f--;)F[t[f].key]=f;const $=[],X=new Map,O=new Map,Y=[];for(f=w;f--;){const D=p(r,s,f),N=n(D);let A=l.get(N);A?Y.push(()=>A.p(D,e)):(A=c(N,D),A.c()),X.set(N,$[f]=A),N in F&&O.set(N,Math.abs(f-F[N]))}const L=new Set,E=new Set;function V(D){qe(D,1),D.m(i,y),l.set(D.key,D),y=D.first,w--}for(;C&&w;){const D=$[w-1],N=t[C-1],A=D.key,j=N.key;D===N?(y=D.first,C--,w--):X.has(j)?!l.has(A)||L.has(A)?V(D):E.has(j)?C--:O.get(A)>O.get(j)?(E.add(A),V(D)):(L.add(j),C--):(u(N,l),C--)}for(;C--;){const D=t[C];X.has(D.key)||u(D,l)}for(;w;)V($[w-1]);return ue(Y),$}function Rt(t){t&&t.c()}function yt(t,e,n){const{fragment:o,after_update:r}=t.$$;o&&o.m(e,n),Oe(()=>{const s=t.$$.on_mount.map(ut).filter(dt);t.$$.on_destroy?t.$$.on_destroy.push(...s):ue(s),t.$$.on_mount=[]}),r.forEach(Oe)}function _t(t,e){const n=t.$$;n.fragment!==null&&(Bt(n.after_update),ue(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function $t(t,e){t.$$.dirty[0]===-1&&(me.push(t),bt(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Ue(t,e,n,o,r,s,l=null,i=[-1]){const u=ve;ke(t);const c=t.$$={fragment:null,ctx:[],props:s,update:Q,not_equal:r,bound:ze(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(u?u.$$.context:[])),callbacks:ze(),dirty:i,skip_bound:!1,root:e.target||u.$$.root};l&&l(c.root);let y=!1;if(c.ctx=n?n(t,e.props||{},(p,C,...w)=>{const f=w.length?w[0]:C;return c.ctx&&r(c.ctx[p],c.ctx[p]=f)&&(!c.skip_bound&&c.bound[p]&&c.bound[p](f),y&&$t(t,p)),C}):[],c.update(),y=!0,ue(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const p=Et(e.target);c.fragment&&c.fragment.l(p),p.forEach(U)}else c.fragment&&c.fragment.c();e.intro&&qe(t.$$.fragment),yt(t,e.target,e.anchor),wt()}ke(u)}class je{constructor(){ce(this,"$$");ce(this,"$$set")}$destroy(){_t(this,1),this.$destroy=Q}$on(e,n){if(!dt(n))return Q;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const r=o.indexOf(n);r!==-1&&o.splice(r,1)}}$set(e){this.$$set&&!Ct(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Ot="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Ot);const pe=[];function ye(t,e=Q){let n;const o=new Set;function r(i){if(Ae(t,i)&&(t=i,n)){const u=!pe.length;for(const c of o)c[1](),pe.push(c,t);if(u){for(let c=0;c<pe.length;c+=2)pe[c][0](pe[c+1]);pe.length=0}}}function s(i){r(i(t))}function l(i,u=Q){const c=[i,u];return o.add(c),o.size===1&&(n=e(r,s)||Q),i(t),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:r,update:s,subscribe:l}}const Ee=ye({apiKey:"",modelName:"deepseek-chat"}),Le=ye([]),Ce=ye(null),Se=ye(null),ee=ye([]);async function Nt(t){const e=x(Ee);if(!e.apiKey||!e.apiUrl)throw new Error("API Key 或 API URL 未配置");const n=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:t,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!n.ok){const r=await n.text();throw new Error(`API 请求失败: ${n.status} ${r}`)}const o=await n.json();if(!o.choices||o.choices.length===0)throw new Error("API 返回数据格式错误");return o.choices[0].message.content}function re(t){return window.Lute.New().Md2HTML(t)}function We(t,e,n){const o=t.slice();return o[3]=e[n],o}function Ge(t){let e,n,o,r,s=[],l=new Map,i=be(t[0]);const u=c=>c[3].id;for(let c=0;c<i.length;c+=1){let y=We(t,i,c),p=u(y);l.set(p,s[c]=Ve(p,y))}return{c(){e=_("div"),n=_("span"),n.textContent="引用内容:",o=R(),r=_("div");for(let c=0;c<s.length;c+=1)s[c].c();h(n,"class","svelte-m85l6"),h(r,"class","reference-tags svelte-m85l6"),h(e,"class","reference-context-bar svelte-m85l6")},m(c,y){H(c,e,y),g(e,n),g(e,o),g(e,r);for(let p=0;p<s.length;p+=1)s[p]&&s[p].m(r,null)},p(c,y){y&3&&(i=be(c[0]),s=Me(s,y,u,1,c,i,l,r,Ne,Ve,null,We))},d(c){c&&U(e);for(let y=0;y<s.length;y+=1)s[y].d()}}}function Qe(t){let e,n,o;function r(){return t[2](t[3])}return{c(){e=_("button"),e.textContent="×",h(e,"class","remove-tag-button svelte-m85l6"),h(e,"title","移除引用")},m(s,l){H(s,e,l),n||(o=G(e,"click",r),n=!0)},p(s,l){t=s},d(s){s&&U(e),n=!1,o()}}}function Ve(t,e){let n,o=e[3].label+"",r,s,l,i=e[3].type==="selection"&&Qe(e);return{key:t,first:null,c(){n=_("span"),r=ae(o),s=R(),i&&i.c(),l=R(),h(n,"class","reference-tag svelte-m85l6"),this.first=n},m(u,c){H(u,n,c),g(n,r),g(n,s),i&&i.m(n,null),g(n,l)},p(u,c){e=u,c&1&&o!==(o=e[3].label+"")&&Pe(r,o),e[3].type==="selection"?i?i.p(e,c):(i=Qe(e),i.c(),i.m(n,l)):i&&(i.d(1),i=null)},d(u){u&&U(n),i&&i.d()}}}function Mt(t){let e,n=t[0].length>0&&Ge(t);return{c(){n&&n.c(),e=xe()},m(o,r){n&&n.m(o,r),H(o,e,r)},p(o,[r]){o[0].length>0?n?n.p(o,r):(n=Ge(o),n.c(),n.m(e.parentNode,e)):n&&(n.d(1),n=null)},i:Q,o:Q,d(o){o&&U(e),n&&n.d(o)}}}function Lt(t,e,n){let o;gt(t,ee,l=>n(0,o=l));function r(l){ee.update(i=>i.filter(u=>u.id!==l))}return[o,r,l=>r(l.id)]}class Pt extends je{constructor(e){super(),Ue(this,e,Lt,Mt,Ae,{})}}const{Map:Xe}=St;function Ze(t,e,n){const o=t.slice();return o[37]=e[n],o}function et(t,e,n){const o=t.slice();return o[40]=e[n],o}function tt(t){let e,n,o;return{c(){e=_("button"),e.textContent="保存当前对话",h(e,"class","b3-button b3-button--outline svelte-t2qwxc")},m(r,s){H(r,e,s),n||(o=G(e,"click",t[9]),n=!0)},p:Q,d(r){r&&U(e),n=!1,o()}}}function nt(t,e){let n,o=e[40].name+"",r,s;return{key:t,first:null,c(){n=_("option"),r=ae(o),n.__value=s=e[40].id,te(n,n.__value),this.first=n},m(l,i){H(l,n,i),g(n,r)},p(l,i){e=l,i[0]&8&&o!==(o=e[40].name+"")&&Pe(r,o),i[0]&8&&s!==(s=e[40].id)&&(n.__value=s,te(n,n.__value))},d(l){l&&U(n)}}}function ot(t){let e,n,o;return{c(){e=_("button"),e.textContent="删除当前",h(e,"class","b3-button b3-button--error svelte-t2qwxc"),h(e,"title","删除当前对话")},m(r,s){H(r,e,s),n||(o=G(e,"click",t[16]),n=!0)},p:Q,d(r){r&&U(e),n=!1,o()}}}function qt(t){let e,n=(t[37].html||t[37].content)+"";return{c(){e=_("div"),h(e,"class","message ai svelte-t2qwxc")},m(o,r){H(o,e,r),e.innerHTML=n},p(o,r){r[0]&64&&n!==(n=(o[37].html||o[37].content)+"")&&(e.innerHTML=n)},d(o){o&&U(e)}}}function Ut(t){let e,n,o=t[37].content.replace(/\n/g,"<br/>")+"";return{c(){e=_("div"),n=_("div"),h(e,"class","message user svelte-t2qwxc")},m(r,s){H(r,e,s),g(e,n),n.innerHTML=o},p(r,s){s[0]&64&&o!==(o=r[37].content.replace(/\n/g,"<br/>")+"")&&(n.innerHTML=o)},d(r){r&&U(e)}}}function st(t,e){let n,o;function r(i,u){if(i[37].role==="user")return Ut;if(i[37].role==="assistant")return qt}let s=r(e),l=s&&s(e);return{key:t,first:null,c(){n=xe(),l&&l.c(),o=xe(),this.first=n},m(i,u){H(i,n,u),l&&l.m(i,u),H(i,o,u)},p(i,u){e=i,s===(s=r(e))&&l?l.p(e,u):(l&&l.d(1),l=s&&s(e),l&&(l.c(),l.m(o.parentNode,o)))},d(i){i&&(U(n),U(o)),l&&l.d(i)}}}function rt(t){let e;return{c(){e=_("div"),e.innerHTML='<p class="svelte-t2qwxc">AI 正在思考...</p>',h(e,"class","message ai loading svelte-t2qwxc")},m(n,o){H(n,e,o)},d(n){n&&U(e)}}}function jt(t){let e,n,o,r,s=x(t[7]).length>1&&!t[4]&&!t[2],l,i,u,c=[],y=new Xe,p,C,w,f=[],F=new Xe,$,X,O,Y,L,E,V,D,N,A,j,W,oe,J,B,M,Z,P=s&&tt(t),de=be(t[3]);const De=a=>a[40].id;for(let a=0;a<de.length;a+=1){let b=et(t,de,a),v=De(b);y.set(v,c[a]=nt(v,b))}let q=t[4]&&ot(t),d=be(t[6]);const k=a=>a[37].id;for(let a=0;a<d.length;a+=1){let b=Ze(t,d,a),v=k(b);F.set(v,f[a]=st(v,b))}let m=t[2]&&rt();return O=new Pt({}),{c(){e=_("div"),n=_("div"),o=_("button"),o.textContent="新建对话",r=R(),P&&P.c(),l=R(),i=_("select"),u=_("option"),u.textContent="加载历史对话";for(let a=0;a<c.length;a+=1)c[a].c();p=R(),q&&q.c(),C=R(),w=_("div");for(let a=0;a<f.length;a+=1)f[a].c();$=R(),m&&m.c(),X=R(),Rt(O.$$.fragment),Y=R(),L=_("div"),E=_("textarea"),V=R(),D=_("button"),N=ae("发送"),j=R(),W=_("button"),oe=ae("引用选区"),h(o,"class","b3-button svelte-t2qwxc"),u.__value="",te(u,u.__value),u.disabled=!0,u.selected=!0,h(i,"class","b3-select svelte-t2qwxc"),h(i,"title","加载历史对话"),h(n,"class","conversation-controls svelte-t2qwxc"),h(w,"class","chat-history svelte-t2qwxc"),h(E,"placeholder","在此输入您的问题或指令..."),h(E,"rows","3"),E.disabled=t[2],h(E,"class","svelte-t2qwxc"),D.disabled=A=!t[0].trim()||t[2],h(D,"class","svelte-t2qwxc"),h(W,"class","add-reference-button svelte-t2qwxc"),h(W,"title","添加当前选中文本作为引用"),W.disabled=J=!t[5]||t[2],h(L,"class","input-area svelte-t2qwxc"),h(e,"class","ai-chat-panel svelte-t2qwxc")},m(a,b){H(a,e,b),g(e,n),g(n,o),g(n,r),P&&P.m(n,null),g(n,l),g(n,i),g(i,u);for(let v=0;v<c.length;v+=1)c[v]&&c[v].m(i,null);g(n,p),q&&q.m(n,null),g(e,C),g(e,w);for(let v=0;v<f.length;v+=1)f[v]&&f[v].m(w,null);g(w,$),m&&m.m(w,null),t[17](w),g(e,X),yt(O,e,null),g(e,Y),g(e,L),g(L,E),te(E,t[0]),g(L,V),g(L,D),g(D,N),g(L,j),g(L,W),g(W,oe),B=!0,M||(Z=[G(o,"click",t[8]),G(i,"change",t[15]),G(E,"input",t[18]),G(E,"keydown",t[19]),G(D,"click",t[12]),G(W,"click",t[13])],M=!0)},p(a,b){b[0]&20&&(s=x(a[7]).length>1&&!a[4]&&!a[2]),s?P?P.p(a,b):(P=tt(a),P.c(),P.m(n,l)):P&&(P.d(1),P=null),b[0]&8&&(de=be(a[3]),c=Me(c,b,De,1,a,de,y,i,Ne,nt,null,et)),a[4]?q?q.p(a,b):(q=ot(a),q.c(),q.m(n,null)):q&&(q.d(1),q=null),b[0]&64&&(d=be(a[6]),f=Me(f,b,k,1,a,d,F,w,Ne,st,$,Ze)),a[2]?m||(m=rt(),m.c(),m.m(w,null)):m&&(m.d(1),m=null),(!B||b[0]&4)&&(E.disabled=a[2]),b[0]&1&&te(E,a[0]),(!B||b[0]&5&&A!==(A=!a[0].trim()||a[2]))&&(D.disabled=A),(!B||b[0]&36&&J!==(J=!a[5]||a[2]))&&(W.disabled=J)},i(a){B||(qe(O.$$.fragment,a),B=!0)},o(a){xt(O.$$.fragment,a),B=!1},d(a){a&&U(e),P&&P.d();for(let b=0;b<c.length;b+=1)c[b].d();q&&q.d();for(let b=0;b<f.length;b+=1)f[b].d();m&&m.d(),t[17](null),_t(O),M=!1,ue(Z)}}}async function Kt(t){if(!t)return console.log("No docId provided for structured context fetch."),"";console.log(`Fetching structured context for document ID: ${t}`);try{const e=`SELECT id, type, markdown FROM blocks WHERE parent_id = '${t}' ORDER BY sort ASC`,n=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:e})});if(!n.ok){const s=await n.text();throw new Error(`SQL query failed with status ${n.status}: ${s}`)}const o=await n.json();if(o.code!==0)throw new Error(`API returned error code ${o.code}: ${o.msg}`);if(console.log("Raw SQL query result data:",o.data),!o.data||!Array.isArray(o.data))return console.log("No block data returned from SQL query or data is not an array."),"Document is empty or contains no text blocks.";let r=`Current document context (Blocks ordered by position):
`;return o.data.forEach((s,l)=>{r+=`--- Block ${l+1} (ID: ${s.id}, Type: ${s.type}) ---
${s.markdown||"[Block content not directly in markdown field]"}

`}),r+="--- End of Blocks ---",console.log("Formatted structured context length:",r.length),r}catch(e){return console.error("Error fetching or processing structured document context:",e),`Error retrieving document structure: ${e.message}`}}async function Ht(t){if(!t||t.length===0)return"";console.log(`[getReferencedBlocksContext] Fetching context for specific block IDs: ${t.join(", ")}`);try{const n=`SELECT id, type, markdown FROM blocks WHERE id IN (${t.map(u=>`'${u}'`).join(", ")})`;console.log(`[getReferencedBlocksContext] Executing SQL: ${n}`);const o=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:n})});if(!o.ok){const u=await o.text();throw new Error(`SQL query for references failed with status ${o.status}: ${u}`)}const r=await o.json();if(r.code!==0)throw new Error(`API returned error code ${r.code} for references: ${r.msg}`);if(!r.data||!Array.isArray(r.data))return console.log("No block data returned for referenced IDs."),"Could not retrieve content for referenced blocks.";console.log("[getReferencedBlocksContext] Raw SQL query result data for references:",r.data);const s=new Map(r.data.map(u=>[u.id,u])),l=t.map(u=>s.get(u)).filter(Boolean);let i=`Referenced content:
`;return l.forEach((u,c)=>{i+=`--- Referenced Block ${c+1} (ID: ${u.id}, Type: ${u.type}) ---
${u.markdown||"[Block content not directly in markdown field]"}

`}),i+="--- End of Referenced Blocks ---",console.log("[getReferencedBlocksContext] Formatted referenced context string:",i),i}catch(e){return console.error("[getReferencedBlocksContext] Error fetching or processing referenced block context:",e),`Error retrieving referenced content: ${e.message}`}}function Jt(){console.log("Loading messages (ensure format is correct)...")}function it(t){if(!t)return null;if(t instanceof HTMLElement&&t.dataset.nodeId)return t;const e=t.parentElement;return e instanceof HTMLElement&&e.dataset.nodeId?e:t instanceof Element?t.closest("[data-node-id]"):e==null?void 0:e.closest("[data-node-id]")}function zt(){var C,w,f;console.groupCollapsed("[getSelectedBlockIds] Check");const t=window.getSelection();if(!t||t.rangeCount===0||t.isCollapsed||!t.anchorNode||!t.focusNode)return console.log("No valid selection found."),console.groupEnd(),[];const e=t.getRangeAt(0);console.log("Selection range:",e),console.log("Start Container:",e.startContainer,"Offset:",e.startOffset),console.log("End Container:",e.endContainer,"Offset:",e.endOffset);const n=e.startContainer,o=(C=n instanceof Node&&n.nodeType===Node.ELEMENT_NODE?n:n.parentElement)==null?void 0:C.closest(".protyle-wysiwyg");if(!o)return console.log("Selection is not inside a protyle editor."),console.groupEnd(),[];console.log("Selection is inside editor:",o);const r=it(e.startContainer),s=it(e.endContainer);if(console.log("Found start block node:",(w=r==null?void 0:r.dataset)==null?void 0:w.nodeId,r),console.log("Found end block node:",(f=s==null?void 0:s.dataset)==null?void 0:f.nodeId,s),!r&&!s)return console.log("Neither start nor end of selection is inside a block."),console.groupEnd(),[];if(r&&r===s)return console.log("Selection within single block:",r.dataset.nodeId),console.groupEnd(),[r.dataset.nodeId];const l=Array.from(o.querySelectorAll("[data-node-id]"));console.log("All blocks in editor:",l.map(F=>F.dataset.nodeId));const i=[],u=r,c=s;let y=u?l.findIndex(F=>F===u):-1,p=c?l.findIndex(F=>F===c):-1;if(console.log(`Calculated indices: Start=${y}, End=${p}`),y===-1||p===-1)return console.warn("Could not reliably determine selection range indices within editor blocks. Returning found blocks only."),r!=null&&r.dataset.nodeId&&i.push(r.dataset.nodeId),s!=null&&s.dataset.nodeId&&s!==r&&i.push(s.dataset.nodeId),console.log("Final selected block IDs (fallback):",i),console.groupEnd(),Array.from(new Set(i));y>p&&([y,p]=[p,y],console.log("Swapped indices"));for(let F=y;F<=p;F++){const $=l[F];$!=null&&$.dataset.nodeId&&i.push($.dataset.nodeId)}return console.log("Final selected block IDs:",i),console.groupEnd(),Array.from(new Set(i))}function Yt(t,e,n){let o,{pluginData:r}=e,s=ye([]);gt(t,s,d=>n(6,o=d));let l="",i,u=!1,c,y=[],p=null,C=null,w="",f=[],F=!1,$=null;const X=Ee.subscribe(d=>{c=d}),O=Le.subscribe(d=>{n(3,y=d.sort((k,m)=>m.timestamp-k.timestamp))}),Y=Ce.subscribe(d=>{C=d}),L=Se.subscribe(d=>{});ee.subscribe(d=>{}),pt(async()=>{const d="有什么可以帮您？";s.set([{id:Date.now().toString()+"init",role:"assistant",content:d,html:re(d)}]),Jt(),await ge(),J(),document.addEventListener("selectionchange",B)}),At(()=>{X(),O(),Y(),L(),document.removeEventListener("selectionchange",B)});async function E(){x(s).length>1&&!p&&!u&&(console.log("Auto-saving previous conversation..."),await V());const d="新对话已开始，有什么可以帮您？",k=re(d);s.set([{id:Date.now().toString()+"init-new",role:"assistant",content:d,html:k}]),n(4,p=null),n(0,l=""),await ge(),J()}async function V(){if(u||x(s).length<=1||p)return;const d=Date.now(),k=d.toString(),m=`对话 ${new Date(d).toLocaleString()}`,b=[{id:k,name:m,timestamp:d,messages:x(s).filter(v=>v.role==="user"||v.role==="assistant").map(({role:v,content:ne})=>({role:v,content:ne}))},...y];await r.saveConversations(b),n(4,p=k),console.log("Conversation saved with ID:",k)}function D(d){const k=y.find(m=>m.id===d);k&&(s.update(m=>k.messages.map((a,b)=>({...a,id:b,html:a.role==="assistant"?re(a.content):void 0}))),n(4,p=k.id),x(s).length,n(0,l=""),ge().then(J),console.log("Conversation loaded:",d))}async function N(d,k){if(k.stopPropagation(),confirm("确定要删除这个对话吗？")){const m=y.filter(a=>a.id!==d);await r.saveConversations(m),p===d&&E(),console.log("Conversation deleted:",d)}}async function A(d){console.log(`Attempting to delete block: ${d}`);try{const k=await fetch("/api/block/deleteBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:d})});if(!k.ok){const a=await k.text();throw new Error(`API deleteBlock failed (${k.status}): ${a}`)}const m=await k.json();if(m.code!==0)throw new Error(`API deleteBlock returned error code ${m.code}: ${m.msg}`);console.log(`Block ${d} deleted successfully.`)}catch(k){throw console.error(`Error executing deleteBlock for ${d}:`,k),w=`删除块 ${d} 失败: ${k.message}`,k}}async function j(d,k){console.log(`Attempting to update block ${d} with new markdown:`,k);try{const m=await fetch("/api/block/updateBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:d,dataType:"markdown",data:k})});if(!m.ok){const b=await m.text();throw new Error(`API updateBlock failed (${m.status}): ${b}`)}const a=await m.json();if(a.code!==0)throw new Error(`API updateBlock returned error code ${a.code}: ${a.msg}`);console.log(`Block ${d} updated successfully.`)}catch(m){throw console.error(`Error executing updateBlock for ${d}:`,m),w=`更新块 ${d} 失败: ${m.message}`,m}}async function W(d,k,m){console.log(`Attempting to insert block after ${d||"start"} with parent ${m||"unknown"}, content:
${k}`);const a={dataType:"markdown",data:k};d!==null?a.previousID=d:(m!==null&&(a.parentID=m),a.previousID="");try{console.log("Executing insert with payload:",a);const b=await fetch("/api/block/insertBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!b.ok){const ne=await b.text();throw new Error(`API Error (${b.status}): ${ne}`)}const v=await b.json();if(v.code!==0)throw new Error(`API returned error code ${v.code}: ${v.msg}`);console.log(`Block inserted successfully after ${d||"start"}.`)}catch(b){throw console.error("Error executing insert block command:",b),w=`插入块失败: ${b.message}`,b}}async function oe(){const d=l.trim();if(!d||u)return;w="",n(2,u=!0);const k=d.match(/^(删除|修改)选区(\d+)$/i);let m=!1;if(k){const S=k[1],T=parseInt(k[2],10);console.log(`[Frontend Command] Matched: action=${S}, index=${T}`);const se=x(ee);console.log("[Frontend Command] Current references in store:",JSON.stringify(se,null,2));const I=se.filter(K=>K.type==="selection");if(console.log("[Frontend Command] Filtered selection references:",JSON.stringify(I,null,2)),T>0&&T<=I.length){const K=I[T-1];console.log(`[Frontend Command] Target reference (at index ${T-1}):`,JSON.stringify(K,null,2));const z=K.blockIds;if(console.log(`[Frontend Command] Target Block IDs for ${S}:`,JSON.stringify(z)),S.toLowerCase()==="删除")try{for(const le of z)await A(le);const fe=Date.now().toString()+"fe-del";s.update(le=>[...le,{id:fe,role:"assistant",content:`已执行删除选区 ${T} (块: ${z.join(", ")}) 的操作。`,html:re(`已执行删除选区 **${T}** (块: ${z.join(", ")}) 的操作。`)}]),s.set([...x(s)]);const _e=K.id;console.log(`[Frontend Command] Removing reference with ID: ${_e}`),ee.update(le=>{const Je=le.filter(vt=>vt.id!==_e);return console.log("[Frontend Command] References after removal:",JSON.stringify(Je,null,2)),Je}),m=!0}catch(fe){console.error("[Frontend Command] Error executing frontend delete command:",fe),w=`执行删除选区 ${T} 失败: ${fe.message}`,m=!0}else S.toLowerCase()==="修改"&&(console.log("Frontend modification command recognized, but not fully implemented."),w='通过 "修改选区N" 指令修改内容的功能尚未完全实现。请尝试选中内容后，直接向 AI 提出修改要求。',m=!0)}else console.warn(`[Frontend Command] Invalid index ${T} for ${I.length} selection references.`),w=`无效的选区编号: ${T}。请确保编号在 1 到 ${I.length} 之间。`,m=!0}if(m){n(0,l=""),n(2,u=!1),await ge(),J();return}const b={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:d};s.update(S=>[...S,b]),s.set([...x(s)]),console.log("User message added to store:",x(s)),n(0,l=""),await ge(),J();let v="",ne="";const Fe=x(ee).filter(S=>S.type==="selection");if(C){console.log("Fetching structured context for document ID:",C);try{v=await Kt(C),console.log("Fetched main document context length:",(v==null?void 0:v.length)??0)}catch(S){console.error("Error fetching structured document context:",S),w=`获取文档结构上下文失败: ${S.message}`}}else console.log("No currentDocId, skipping main document context fetch.");if(Fe.length>0){const S=Array.from(new Set(Fe.flatMap(T=>T.blockIds)));console.log("[sendMessage] Found selection references, preparing to fetch context for IDs:",S);try{ne=await Ht(S),console.log("[sendMessage] Fetched referenced context length:",(ne==null?void 0:ne.length)??0)}catch(T){console.error("[sendMessage] Error fetching referenced block context:",T),w=`获取引用块上下文失败: ${T.message}`}}let ie="";C&&(ie+=`--- Document Root (ID: ${C}) ---

`),v&&(ie+=v),ne&&(ie&&v&&(ie+=`

`),ie+=ne),console.log("[sendMessage] Combined context string prepared for system prompt:",ie);const kt=x(s).filter(S=>S.role==="user"||S.role==="assistant").slice(-20).map(S=>({role:S.role,content:S.content}));let Ke=`You are a helpful AI assistant integrated into Siyuan Note.\\nYou can interact with the document content based on the provided context.\\n\\n**Understanding the Context:**\\nThe context below shows the structure and content of the current document or specific blocks selected by the user.\\nEach block is listed with its sequential number, unique ID, and type, like this:\\n--- Block N (ID: yyyy-mmdd-xxxxxx, Type: p) ---\\n[Markdown content of the block]\\n---\\n+(Referenced blocks, if any, will be listed under \\"Referenced content:\\")\\n\\n**Performing Actions (Delete/Update):**\\nWhen the user asks you to modify the document (e.g., \\"delete the second paragraph\\", \\"update the list item with ID xxx\\"):\\n1. Carefully identify the **exact block ID** (e.g., yyyy-mmdd-xxxxxx) from the context that corresponds to the user\\'s request.\\n2. Output **only** a single JSON command block using one of the following formats. **You MUST use the specific block ID found in the context.**\\n\\n   *   To delete a block: \\\`\\\`\\\`json {\\"action\\": \\"delete\\", \\"block_id\\": \\"TARGET_BLOCK_ID_FROM_CONTEXT\\"} \\\`\\\`\\\`\\
   *   To update a block: \\\`\\\`\\\`json {\\"action\\": \\"update\\", \\"block_id\\": \\"TARGET_BLOCK_ID_FROM_CONTEXT\\", \\"new_markdown\\": \\"NEW_MARKDOWN_CONTENT\\"} \\\`\\\`\\\`\\
   *   To insert a block: \\\`\\\`\\\`json {\\"action\\": \\"insert\\", \\"previousID\\": \\"ID_OF_BLOCK_BEFORE\\", \\"parentID\\": null, \\"markdown\\": \\"NEW_MARKDOWN_CONTENT\\"} \\\`\\\`\\\` (Note: parentID is usually null for insertions relative to existing blocks)\\
\\n**IMPORTANT RULES:**\\n*   **Action Intent:** Determine the user\\'s core goal:\\
    *   \\'update\\': User wants to *modify, update, or replace* content of an *existing* block.\\
    *   \\'delete\\': User wants to *remove or delete* an *existing* block.\\
    *   \\'insert\\': User wants to *add, insert, create, or write* *new* content/blocks.\\
    *   **If unsure about intent, ASK the user.**\\
*   **Handling Multi-Block References (CRITICAL - READ CAREFULLY!):** When a reference label (e.g., "Selection 1") points to multiple block IDs in the \\\`Referenced content\\\`:\\n    *   **Information Requests:** If asked for information (e.g., "What is in Selection 1?", "Summarize Selection 1"), you **MUST** address or summarize the content of **ALL** associated blocks in your response.\\n    *   **Action Requests (e.g., "delete", "update", "insert after Selection 1"):** \\n        1.  You **MUST NOT** generate multiple commands for this single user request.\\n        2.  You **MUST NOT** guess which block to act upon.\\n        3.  You **MUST ALWAYS ask the user for clarification FIRST**. \\n        4.  **Your clarification response MUST be ONLY natural language**, asking which specific block ID they want the action performed on. Example: \\"Selection 1 includes Block ID xxx and Block ID yyy. Which one do you want to [action]?\\" **DO NOT include any JSON command block in your clarification response.**\\n        5.  **Only AFTER** the user responds specifying a single ID, you can then generate a **single** command targeting that user-specified ID.\\n*   **Insert Command - How to Set IDs (ONLY relative to specific Block IDs):**\\
    *   **Goal: Insert AFTER Block A?** (e.g., \\"add below Block A\\", \\"insert after selection 1\\")\\
        *   Find Block A\\'s ID in the context (\\'BLOCK_A_ID\\').\\
        *   Set \\'previousID\\' = \\'BLOCK_A_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Goal: Insert BEFORE Block B?** (e.g., \\"insert before Block B\\", \\"add above selection 1\\")\\
        *   Find the ID of the block *immediately preceding* Block B in the context (\\'BLOCK_B_minus_1_ID\\'). **There MUST be a preceding block.**\\
        *   Set \\'previousID\\' = \\'BLOCK_B_minus_1_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Goal: Insert BETWEEN Block A and Block B?** (e.g., \\"put this between block 1 and 2\\")\\
        *   Treat this as \\"Insert AFTER Block A\\".\\
        *   Find Block A\\'s ID (\\'BLOCK_A_ID\\').\\
        *   Set \\'previousID\\' = \\'BLOCK_A_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Content:** The \\'markdown\\' field must contain the complete Markdown content for the new block(s).\\
*   **NO Fuzzy Locations:** Requests like \\"insert at the beginning\\", \\"insert at the end\\", or \\"insert here\\" are **NOT SUPPORTED** for direct action. See \\"Ask If Unsure\\".\\
*   **Referenced Context First:** If \\'Referenced content\\' is provided and the user\\'s request mentions the selection/reference (e.g., \\"update selection 1\\", \\"insert after the selected paragraph\\"), **MUST** use the block ID(s) from the \\'Referenced content\\' section for targeting.\\
*   **Use Exact IDs:** Always use the exact block IDs shown in parentheses (ID: ...) from the context. Never guess IDs or use block numbers like \\"Block 3\\".\\
*   **Ask If Unsure (CRITICAL):** If the user\\'s request is ambiguous about the action (update/delete/insert), the target block/location, or if you cannot confidently find the necessary IDs in the context according to these rules (including the multi-block clarification rule), **you MUST ask the user for clarification**. \\
    *   **Specifically:** If the user asks to insert at the beginning, end, or uses vague terms without specifying a block ID, you MUST reply asking them to provide the **ID of the block** they want to insert **before** or **after**.\\
    *   Example clarifying question: \\"To insert the content, please tell me the ID of the block you want to insert it before or after.\\"\\
    *   Do NOT guess or make assumptions.\\
*   **Normal Chat:** For general questions, summaries, or explanations that don\\'t involve changing the document, respond normally in natural language without any JSON command block.\\
\\
--- Context Starts Below:`;ie&&(Ke+=`

${ie}`);const He=[{role:"system",content:Ke},...kt];console.log("Messages being sent to API (final format):",He);try{const S=await Nt(He,c);let T=!1;const se=S.match(/```json\n({.*?})\n```/s);if(se&&se[1])try{const I=JSON.parse(se[1]);if(console.log("Parsed AI command:",I),I.action==="delete"&&I.block_id){await A(I.block_id),T=!0;const K=Date.now().toString()+"cmd-del";s.update(z=>[...z,{id:K,role:"assistant",content:`已执行删除块 ${I.block_id} 的操作。`,html:re(`已执行删除块 **${I.block_id}** 的操作。`)}]),s.set([...x(s)])}else if(I.action==="update"&&I.block_id&&typeof I.new_markdown=="string"){await j(I.block_id,I.new_markdown),T=!0;const K=Date.now().toString()+"cmd-upd";s.update(z=>[...z,{id:K,role:"assistant",content:`已执行更新块 ${I.block_id} 的操作。`,html:re(`已执行更新块 **${I.block_id}** 的操作。`)}]),s.set([...x(s)])}else if(I.action==="insert"&&typeof I.markdown=="string"&&(typeof I.previousID=="string"||typeof I.parentID=="string"&&I.parentID!=="")){const K=I.previousID===""?null:I.previousID,z=I.parentID||null;await W(K,I.markdown,z),T=!0;const fe=Date.now().toString()+"cmd-ins",_e=K?`块 ${K} 之后`:z?`文档 ${z} 开头`:"文档开头";s.update(le=>[...le,{id:fe,role:"assistant",content:`已在 ${_e} 插入新块。`,html:re(`已在 **${_e}** 插入新块。`)}]),s.set([...x(s)])}else console.warn("Parsed command JSON has invalid action or missing/invalid parameters:",I)}catch(I){console.error("Failed to parse command JSON:",I,"Raw content:",se[1])}if(!T){const K={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:S,html:re(S)};s.update(z=>[...z,K]),s.set([...x(s)]),console.log("Assistant message added to store:",x(s))}}catch(S){console.error("Error fetching chat completion:",S),w=`AI 请求失败: ${S.message}`;const se={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`抱歉，请求出错: ${w}`,html:re(`抱歉，请求出错: ${w}`)};s.update(I=>[...I,se]),s.set([...x(s)]),console.log("Error message added to store:",x(s))}finally{n(2,u=!1),!m&&Fe.length>0&&(console.log("Clearing selection references after AI call."),ee.update(S=>S.filter(T=>T.type!=="selection"))),await ge(),J()}}function J(){i&&requestAnimationFrame(()=>{n(1,i.scrollTop=i.scrollHeight,i)})}function B(){$&&clearTimeout($),$=window.setTimeout(()=>{const d=zt();d.length>0?(f=d,n(5,F=!0),console.log("Selection changed (debounced), FOUND blocks, Enabling button. IDs:",f)):console.log("Selection changed (debounced), NO valid blocks found, button state remains:",F)},150)}function M(){var b;if(!F||f.length===0)return;const d=`sel-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,m=`选区 ${x(ee).filter(v=>v.type==="selection").length+1}`,a={id:d,label:m,blockIds:[...f],type:"selection"};console.log("[addSelectionReference] About to update referenceStore. Current state:",x(ee)),console.log("[addSelectionReference] Adding new reference:",a),ee.update(v=>[...v,a]),console.log("[addSelectionReference] Updated referenceStore state:",x(ee)),f=[],n(5,F=!1),(b=window.getSelection())==null||b.removeAllRanges()}const Z=d=>D(d.currentTarget.value),P=d=>N(p,d);function de(d){Re[d?"unshift":"push"](()=>{i=d,n(1,i)})}function De(){l=this.value,n(0,l)}const q=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),oe())};return t.$$set=d=>{"pluginData"in d&&n(14,r=d.pluginData)},[l,i,u,y,p,F,o,s,E,V,D,N,oe,M,r,Z,P,de,De,q]}class Wt extends je{constructor(e){super(),Ue(this,e,Yt,jt,Ae,{pluginData:14},null,[-1,-1])}}function lt(t){let e,n;return{c(){e=_("span"),n=ae(t[3]),h(e,"class","status-message svelte-136cw2s")},m(o,r){H(o,e,r),g(e,n)},p(o,r){r&8&&Pe(n,o[3])},d(o){o&&U(e)}}}function Gt(t){let e,n,o,r,s,l,i,u,c,y,p,C,w,f,F,$,X,O,Y,L,E,V,D,N,A,j,W,oe,J,B=t[3]&&lt(t);return{c(){e=_("div"),n=_("h2"),n.textContent="AI 助手设置",o=R(),r=_("div"),s=_("label"),s.textContent="AI API Endpoint URL:",l=R(),i=_("input"),u=R(),c=_("p"),c.textContent="请输入您要使用的 AI 服务的完整 URL。",y=R(),p=_("div"),C=_("label"),C.textContent="API Key:",w=R(),f=_("input"),F=R(),$=_("p"),$.textContent="您的 API Key 将被保存在本地配置文件中。",X=R(),O=_("div"),Y=_("label"),Y.textContent="模型名称:",L=R(),E=_("input"),V=R(),D=_("p"),D.textContent="请输入要调用的具体模型名称。",N=R(),A=_("div"),j=_("button"),j.textContent="保存设置",W=R(),B&&B.c(),h(n,"class","svelte-136cw2s"),h(s,"for","api-url"),h(s,"class","svelte-136cw2s"),h(i,"id","api-url"),h(i,"type","text"),h(i,"placeholder","例如: https://api.openai.com/v1/chat/completions"),h(i,"class","b3-text-field svelte-136cw2s"),h(c,"class","description svelte-136cw2s"),h(r,"class","form-item svelte-136cw2s"),h(C,"for","api-key"),h(C,"class","svelte-136cw2s"),h(f,"id","api-key"),h(f,"type","password"),h(f,"placeholder","请输入您的 API Key"),h(f,"class","b3-text-field svelte-136cw2s"),h($,"class","description svelte-136cw2s"),h(p,"class","form-item svelte-136cw2s"),h(Y,"for","model-name"),h(Y,"class","svelte-136cw2s"),h(E,"id","model-name"),h(E,"type","text"),h(E,"placeholder","例如: deepseek-chat, gpt-4o, ..."),h(E,"class","b3-text-field svelte-136cw2s"),h(D,"class","description svelte-136cw2s"),h(O,"class","form-item svelte-136cw2s"),h(j,"class","b3-button b3-button--primary"),h(A,"class","actions svelte-136cw2s"),h(e,"class","settings-panel svelte-136cw2s")},m(M,Z){H(M,e,Z),g(e,n),g(e,o),g(e,r),g(r,s),g(r,l),g(r,i),te(i,t[0]),g(r,u),g(r,c),g(e,y),g(e,p),g(p,C),g(p,w),g(p,f),te(f,t[1]),g(p,F),g(p,$),g(e,X),g(e,O),g(O,Y),g(O,L),g(O,E),te(E,t[2]),g(O,V),g(O,D),g(e,N),g(e,A),g(A,j),g(A,W),B&&B.m(A,null),oe||(J=[G(i,"input",t[8]),G(f,"input",t[9]),G(E,"input",t[10]),G(j,"click",t[4])],oe=!0)},p(M,[Z]){Z&1&&i.value!==M[0]&&te(i,M[0]),Z&2&&f.value!==M[1]&&te(f,M[1]),Z&4&&E.value!==M[2]&&te(E,M[2]),M[3]?B?B.p(M,Z):(B=lt(M),B.c(),B.m(A,null)):B&&(B.d(1),B=null)},i:Q,o:Q,d(M){M&&U(e),B&&B.d(),oe=!1,ue(J)}}}function Qt(t,e,n){let{loadSettings:o}=e,{saveSettings:r}=e,{currentSettings:s}=e,l="",i="",u="",c="";pt(async()=>{if(s)n(0,l=s.apiUrl||""),n(1,i=s.apiKey||""),n(2,u=s.modelName||"deepseek-chat");else{const f=await o();n(0,l=f.apiUrl||""),n(1,i=f.apiKey||""),n(2,u=f.modelName||"deepseek-chat")}});async function y(){try{await r({apiUrl:l,apiKey:i,modelName:u}),n(3,c="设置已保存！"),setTimeout(()=>n(3,c=""),3e3)}catch(f){n(3,c=`保存失败: ${f.message}`)}}function p(){l=this.value,n(0,l)}function C(){i=this.value,n(1,i)}function w(){u=this.value,n(2,u)}return t.$$set=f=>{"loadSettings"in f&&n(5,o=f.loadSettings),"saveSettings"in f&&n(6,r=f.saveSettings),"currentSettings"in f&&n(7,s=f.currentSettings)},[l,i,u,c,y,o,r,s,p,C,w]}class Vt extends je{constructor(e){super(),Ue(this,e,Qt,Gt,Ae,{loadSettings:5,saveSettings:6,currentSettings:7})}}const ct="ai-assistant-config",at="ai-assistant-conversations",Xt={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},Zt="ai_assistant_dock";class en extends Be.Plugin{constructor(){super(...arguments);ce(this,"isMobile");ce(this,"settings");ce(this,"settingsDialog",null);ce(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const n=Be.getFrontend();this.isMobile=n==="mobile"||n==="browser-mobile",await this.loadSettings(),await this.loadConversations(),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this,saveConversations:this.saveConversations.bind(this)},type:Zt,init(o){new Wt({target:o.element,props:{pluginData:o.data}}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:n}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",n),n&&n.protyle&&n.protyle.block&&n.protyle.block.rootID){const o=n.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${o}`),Ce.set(o),console.log(`Current document ID updated via switch-protyle: ${o}`),n.protyle.path){const r=n.protyle.path;console.log(`Doc Path found in protyle.path: ${r}`),Se.set(r),console.log(`Current document Path updated via switch-protyle: ${r}`)}else console.warn("Doc Path not found in protyle detail."),Se.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),Ce.set(null),Se.set(null)}updateCurrentDocIdFromActiveTab(){var n;console.log("Attempting to get doc ID from active tab...");try{const o=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(o){console.log("Active protyle tab element found.");let r=o,s=r==null?void 0:r.protyle;for(;r&&!s;)s=r==null?void 0:r.protyle,r=r.parentElement;if((n=s==null?void 0:s.block)!=null&&n.rootID){const l=s.block.rootID;Ce.set(l),console.log(`Updated doc ID from active tab in onLayoutReady: ${l}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:s});const l=o.getAttribute("data-node-id");l&&console.log(`Found node-id on active tab: ${l}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(o){console.error("Error getting doc ID from active tab:",o)}}openSetting(){this.settingsDialog||(this.settingsDialog=new Be.Dialog({title:"AI 助手设置",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new Vt({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const n=await this.loadData(ct);return this.settings=Object.assign({},Xt,n),Ee.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(n){this.settings=n,await this.saveData(ct,this.settings),Ee.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const n=await this.loadData(at)||[];Le.set(n),console.log(`${n.length} conversations loaded.`)}async saveConversations(n){await this.saveData(at,n),Le.set(n),console.log(`Conversations saved (${n.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=en;
