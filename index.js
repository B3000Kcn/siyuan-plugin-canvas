"use strict";var pt=Object.defineProperty;var mt=(t,e,n)=>e in t?pt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var te=(t,e,n)=>mt(t,typeof e!="symbol"?e+"":e,n);const Se=require("siyuan");function Q(){}function ot(t){return t()}function xe(){return Object.create(null)}function ie(t){t.forEach(ot)}function st(t){return typeof t=="function"}function De(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function wt(t){return Object.keys(t).length===0}function it(t,...e){if(t==null){for(const o of e)o(void 0);return Q}const n=t.subscribe(...e);return n.unsubscribe?()=>n.unsubscribe():n}function q(t){let e;return it(t,n=>e=n)(),e}function lt(t,e,n){t.$$.on_destroy.push(it(e,n))}const bt=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function h(t,e){t.appendChild(e)}function K(t,e,n){t.insertBefore(e,n||null)}function H(t){t.parentNode&&t.parentNode.removeChild(t)}function b(t){return document.createElement(t)}function se(t){return document.createTextNode(t)}function T(){return se(" ")}function Ee(){return se("")}function z(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function g(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function _t(t){return Array.from(t.childNodes)}function Ne(t,e){e=""+e,t.data!==e&&(t.data=e)}function X(t,e){t.value=e??""}let be;function we(t){be=t}function rt(){if(!be)throw new Error("Function called outside component initialization");return be}function ct(t){rt().$$.on_mount.push(t)}function yt(t){rt().$$.on_destroy.push(t)}const ue=[],Ie=[];let fe=[];const Oe=[],at=Promise.resolve();let Ae=!1;function ut(){Ae||(Ae=!0,at.then(dt))}function me(){return ut(),at}function Fe(t){fe.push(t)}const Ce=new Set;let ce=0;function dt(){if(ce!==0)return;const t=be;do{try{for(;ce<ue.length;){const e=ue[ce];ce++,we(e),vt(e.$$)}}catch(e){throw ue.length=0,ce=0,e}for(we(null),ue.length=0,ce=0;Ie.length;)Ie.pop()();for(let e=0;e<fe.length;e+=1){const n=fe[e];Ce.has(n)||(Ce.add(n),n())}fe.length=0}while(ue.length);for(;Oe.length;)Oe.pop()();Ae=!1,Ce.clear(),we(t)}function vt(t){if(t.fragment!==null){t.update(),ie(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Fe)}}function kt(t){const e=[],n=[];fe.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),fe=e}const _e=new Set;let Dt;function Pe(t,e){t&&t.i&&(_e.delete(t),t.i(e))}function St(t,e,n,o){if(t&&t.o){if(_e.has(t))return;_e.add(t),Dt.c.push(()=>{_e.delete(t)}),t.o(e)}}function de(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function Te(t,e){t.d(1),e.delete(t.key)}function Be(t,e,n,o,s,i,r,l,a,c,w,p){let D=t.length,_=i.length,f=D;const B={};for(;f--;)B[t[f].key]=f;const N=[],W=new Map,$=new Map,J=[];for(f=_;f--;){const k=p(s,i,f),R=n(k);let C=r.get(R);C?J.push(()=>C.p(k,e)):(C=c(R,k),C.c()),W.set(R,N[f]=C),R in B&&$.set(R,Math.abs(f-B[R]))}const L=new Set,S=new Set;function V(k){Pe(k,1),k.m(l,w),r.set(k.key,k),w=k.first,_--}for(;D&&_;){const k=N[_-1],R=t[D-1],C=k.key,O=R.key;k===R?(w=k.first,D--,_--):W.has(O)?!r.has(C)||L.has(C)?V(k):S.has(O)?D--:$.get(C)>$.get(O)?(S.add(C),V(k)):(L.add(O),D--):(a(R,r),D--)}for(;D--;){const k=t[D];W.has(k.key)||a(k,r)}for(;_;)V(N[_-1]);return ie(J),N}function Ct(t){t&&t.c()}function ft(t,e,n){const{fragment:o,after_update:s}=t.$$;o&&o.m(e,n),Fe(()=>{const i=t.$$.on_mount.map(ot).filter(st);t.$$.on_destroy?t.$$.on_destroy.push(...i):ie(i),t.$$.on_mount=[]}),s.forEach(Fe)}function ht(t,e){const n=t.$$;n.fragment!==null&&(kt(n.after_update),ie(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function Et(t,e){t.$$.dirty[0]===-1&&(ue.push(t),ut(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Me(t,e,n,o,s,i,r=null,l=[-1]){const a=be;we(t);const c=t.$$={fragment:null,ctx:[],props:i,update:Q,not_equal:s,bound:xe(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:xe(),dirty:l,skip_bound:!1,root:e.target||a.$$.root};r&&r(c.root);let w=!1;if(c.ctx=n?n(t,e.props||{},(p,D,..._)=>{const f=_.length?_[0]:D;return c.ctx&&s(c.ctx[p],c.ctx[p]=f)&&(!c.skip_bound&&c.bound[p]&&c.bound[p](f),w&&Et(t,p)),D}):[],c.update(),w=!0,ie(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const p=_t(e.target);c.fragment&&c.fragment.l(p),p.forEach(H)}else c.fragment&&c.fragment.c();e.intro&&Pe(t.$$.fragment),ft(t,e.target,e.anchor),dt()}we(a)}class Re{constructor(){te(this,"$$");te(this,"$$set")}$destroy(){ht(this,1),this.$destroy=Q}$on(e,n){if(!st(n))return Q;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const s=o.indexOf(n);s!==-1&&o.splice(s,1)}}$set(e){this.$$set&&!wt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const It="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(It);const ae=[];function he(t,e=Q){let n;const o=new Set;function s(l){if(De(t,l)&&(t=l,n)){const a=!ae.length;for(const c of o)c[1](),ae.push(c,t);if(a){for(let c=0;c<ae.length;c+=2)ae[c][0](ae[c+1]);ae.length=0}}}function i(l){s(l(t))}function r(l,a=Q){const c=[l,a];return o.add(c),o.size===1&&(n=e(s,i)||Q),l(t),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:s,update:i,subscribe:r}}const ke=he({apiKey:"",modelName:"deepseek-chat"}),$e=he([]),ye=he(null),ve=he(null),oe=he([]);async function At(t){const e=q(ke);if(!e.apiKey||!e.apiUrl)throw new Error("API Key 或 API URL 未配置");const n=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:t,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!n.ok){const s=await n.text();throw new Error(`API 请求失败: ${n.status} ${s}`)}const o=await n.json();if(!o.choices||o.choices.length===0)throw new Error("API 返回数据格式错误");return o.choices[0].message.content}function ne(t){return window.Lute.New().Md2HTML(t)}function je(t,e,n){const o=t.slice();return o[3]=e[n],o}function Ue(t){let e,n,o,s,i=[],r=new Map,l=de(t[0]);const a=c=>c[3].id;for(let c=0;c<l.length;c+=1){let w=je(t,l,c),p=a(w);r.set(p,i[c]=Ke(p,w))}return{c(){e=b("div"),n=b("span"),n.textContent="引用内容:",o=T(),s=b("div");for(let c=0;c<i.length;c+=1)i[c].c();g(n,"class","svelte-m85l6"),g(s,"class","reference-tags svelte-m85l6"),g(e,"class","reference-context-bar svelte-m85l6")},m(c,w){K(c,e,w),h(e,n),h(e,o),h(e,s);for(let p=0;p<i.length;p+=1)i[p]&&i[p].m(s,null)},p(c,w){w&3&&(l=de(c[0]),i=Be(i,w,a,1,c,l,r,s,Te,Ke,null,je))},d(c){c&&H(e);for(let w=0;w<i.length;w+=1)i[w].d()}}}function He(t){let e,n,o;function s(){return t[2](t[3])}return{c(){e=b("button"),e.textContent="×",g(e,"class","remove-tag-button svelte-m85l6"),g(e,"title","移除引用")},m(i,r){K(i,e,r),n||(o=z(e,"click",s),n=!0)},p(i,r){t=i},d(i){i&&H(e),n=!1,o()}}}function Ke(t,e){let n,o=e[3].label+"",s,i,r,l=e[3].type==="selection"&&He(e);return{key:t,first:null,c(){n=b("span"),s=se(o),i=T(),l&&l.c(),r=T(),g(n,"class","reference-tag svelte-m85l6"),this.first=n},m(a,c){K(a,n,c),h(n,s),h(n,i),l&&l.m(n,null),h(n,r)},p(a,c){e=a,c&1&&o!==(o=e[3].label+"")&&Ne(s,o),e[3].type==="selection"?l?l.p(e,c):(l=He(e),l.c(),l.m(n,r)):l&&(l.d(1),l=null)},d(a){a&&H(n),l&&l.d()}}}function Ft(t){let e,n=t[0].length>0&&Ue(t);return{c(){n&&n.c(),e=Ee()},m(o,s){n&&n.m(o,s),K(o,e,s)},p(o,[s]){o[0].length>0?n?n.p(o,s):(n=Ue(o),n.c(),n.m(e.parentNode,e)):n&&(n.d(1),n=null)},i:Q,o:Q,d(o){o&&H(e),n&&n.d(o)}}}function Tt(t,e,n){let o;lt(t,oe,r=>n(0,o=r));function s(r){oe.update(l=>l.filter(a=>a.id!==r))}return[o,s,r=>s(r.id)]}class Bt extends Re{constructor(e){super(),Me(this,e,Tt,Ft,De,{})}}const{Map:Je}=bt;function ze(t,e,n){const o=t.slice();return o[35]=e[n],o}function Qe(t,e,n){const o=t.slice();return o[38]=e[n],o}function Ve(t){let e,n,o;return{c(){e=b("button"),e.textContent="保存当前对话",g(e,"class","b3-button b3-button--outline svelte-t2qwxc")},m(s,i){K(s,e,i),n||(o=z(e,"click",t[9]),n=!0)},p:Q,d(s){s&&H(e),n=!1,o()}}}function We(t,e){let n,o=e[38].name+"",s,i;return{key:t,first:null,c(){n=b("option"),s=se(o),n.__value=i=e[38].id,X(n,n.__value),this.first=n},m(r,l){K(r,n,l),h(n,s)},p(r,l){e=r,l[0]&8&&o!==(o=e[38].name+"")&&Ne(s,o),l[0]&8&&i!==(i=e[38].id)&&(n.__value=i,X(n,n.__value))},d(r){r&&H(n)}}}function Ge(t){let e,n,o;return{c(){e=b("button"),e.textContent="删除当前",g(e,"class","b3-button b3-button--error svelte-t2qwxc"),g(e,"title","删除当前对话")},m(s,i){K(s,e,i),n||(o=z(e,"click",t[16]),n=!0)},p:Q,d(s){s&&H(e),n=!1,o()}}}function $t(t){let e,n=(t[35].html||t[35].content)+"";return{c(){e=b("div"),g(e,"class","message ai svelte-t2qwxc")},m(o,s){K(o,e,s),e.innerHTML=n},p(o,s){s[0]&64&&n!==(n=(o[35].html||o[35].content)+"")&&(e.innerHTML=n)},d(o){o&&H(e)}}}function Nt(t){let e,n,o=t[35].content.replace(/\n/g,"<br/>")+"";return{c(){e=b("div"),n=b("div"),g(e,"class","message user svelte-t2qwxc")},m(s,i){K(s,e,i),h(e,n),n.innerHTML=o},p(s,i){i[0]&64&&o!==(o=s[35].content.replace(/\n/g,"<br/>")+"")&&(n.innerHTML=o)},d(s){s&&H(e)}}}function Ye(t,e){let n,o;function s(l,a){if(l[35].role==="user")return Nt;if(l[35].role==="assistant")return $t}let i=s(e),r=i&&i(e);return{key:t,first:null,c(){n=Ee(),r&&r.c(),o=Ee(),this.first=n},m(l,a){K(l,n,a),r&&r.m(l,a),K(l,o,a)},p(l,a){e=l,i===(i=s(e))&&r?r.p(e,a):(r&&r.d(1),r=i&&i(e),r&&(r.c(),r.m(o.parentNode,o)))},d(l){l&&(H(n),H(o)),r&&r.d(l)}}}function Xe(t){let e;return{c(){e=b("div"),e.innerHTML='<p class="svelte-t2qwxc">AI 正在思考...</p>',g(e,"class","message ai loading svelte-t2qwxc")},m(n,o){K(n,e,o)},d(n){n&&H(e)}}}function Pt(t){let e,n,o,s,i=q(t[7]).length>1&&!t[4]&&!t[2],r,l,a,c=[],w=new Je,p,D,_,f=[],B=new Je,N,W,$,J,L,S,V,k,R,C,O,x,Z,ee,E,P,G,j=i&&Ve(t),le=de(t[3]);const d=u=>u[38].id;for(let u=0;u<le.length;u+=1){let y=Qe(t,le,u),U=d(y);w.set(U,c[u]=We(U,y))}let m=t[4]&&Ge(t),v=de(t[6]);const I=u=>u[35].id;for(let u=0;u<v.length;u+=1){let y=ze(t,v,u),U=I(y);B.set(U,f[u]=Ye(U,y))}let F=t[2]&&Xe();return $=new Bt({}),{c(){e=b("div"),n=b("div"),o=b("button"),o.textContent="新建对话",s=T(),j&&j.c(),r=T(),l=b("select"),a=b("option"),a.textContent="加载历史对话";for(let u=0;u<c.length;u+=1)c[u].c();p=T(),m&&m.c(),D=T(),_=b("div");for(let u=0;u<f.length;u+=1)f[u].c();N=T(),F&&F.c(),W=T(),Ct($.$$.fragment),J=T(),L=b("div"),S=b("textarea"),V=T(),k=b("button"),R=se("发送"),O=T(),x=b("button"),Z=se("引用选区"),g(o,"class","b3-button svelte-t2qwxc"),a.__value="",X(a,a.__value),a.disabled=!0,a.selected=!0,g(l,"class","b3-select svelte-t2qwxc"),g(l,"title","加载历史对话"),g(n,"class","conversation-controls svelte-t2qwxc"),g(_,"class","chat-history svelte-t2qwxc"),g(S,"placeholder","在此输入您的问题或指令..."),g(S,"rows","3"),S.disabled=t[2],g(S,"class","svelte-t2qwxc"),k.disabled=C=!t[0].trim()||t[2],g(k,"class","svelte-t2qwxc"),g(x,"class","add-reference-button svelte-t2qwxc"),g(x,"title","添加当前选中文本作为引用"),x.disabled=ee=!t[5]||t[2],g(L,"class","input-area svelte-t2qwxc"),g(e,"class","ai-chat-panel svelte-t2qwxc")},m(u,y){K(u,e,y),h(e,n),h(n,o),h(n,s),j&&j.m(n,null),h(n,r),h(n,l),h(l,a);for(let U=0;U<c.length;U+=1)c[U]&&c[U].m(l,null);h(n,p),m&&m.m(n,null),h(e,D),h(e,_);for(let U=0;U<f.length;U+=1)f[U]&&f[U].m(_,null);h(_,N),F&&F.m(_,null),t[17](_),h(e,W),ft($,e,null),h(e,J),h(e,L),h(L,S),X(S,t[0]),h(L,V),h(L,k),h(k,R),h(L,O),h(L,x),h(x,Z),E=!0,P||(G=[z(o,"click",t[8]),z(l,"change",t[15]),z(S,"input",t[18]),z(S,"keydown",t[19]),z(k,"click",t[12]),z(x,"click",t[13])],P=!0)},p(u,y){y[0]&20&&(i=q(u[7]).length>1&&!u[4]&&!u[2]),i?j?j.p(u,y):(j=Ve(u),j.c(),j.m(n,r)):j&&(j.d(1),j=null),y[0]&8&&(le=de(u[3]),c=Be(c,y,d,1,u,le,w,l,Te,We,null,Qe)),u[4]?m?m.p(u,y):(m=Ge(u),m.c(),m.m(n,null)):m&&(m.d(1),m=null),y[0]&64&&(v=de(u[6]),f=Be(f,y,I,1,u,v,B,_,Te,Ye,N,ze)),u[2]?F||(F=Xe(),F.c(),F.m(_,null)):F&&(F.d(1),F=null),(!E||y[0]&4)&&(S.disabled=u[2]),y[0]&1&&X(S,u[0]),(!E||y[0]&5&&C!==(C=!u[0].trim()||u[2]))&&(k.disabled=C),(!E||y[0]&36&&ee!==(ee=!u[5]||u[2]))&&(x.disabled=ee)},i(u){E||(Pe($.$$.fragment,u),E=!0)},o(u){St($.$$.fragment,u),E=!1},d(u){u&&H(e),j&&j.d();for(let y=0;y<c.length;y+=1)c[y].d();m&&m.d();for(let y=0;y<f.length;y+=1)f[y].d();F&&F.d(),t[17](null),ht($),P=!1,ie(G)}}}async function Mt(t){if(!t)return console.log("No docId provided for structured context fetch."),"";console.log(`Fetching structured context for document ID: ${t}`);try{const e=`SELECT id, type, markdown FROM blocks WHERE parent_id = '${t}' ORDER BY sort ASC`,n=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:e})});if(!n.ok){const i=await n.text();throw new Error(`SQL query failed with status ${n.status}: ${i}`)}const o=await n.json();if(o.code!==0)throw new Error(`API returned error code ${o.code}: ${o.msg}`);if(console.log("Raw SQL query result data:",o.data),!o.data||!Array.isArray(o.data))return console.log("No block data returned from SQL query or data is not an array."),"Document is empty or contains no text blocks.";let s=`Current document context (Blocks ordered by position):
`;return o.data.forEach((i,r)=>{s+=`--- Block ${r+1} (ID: ${i.id}, Type: ${i.type}) ---
${i.markdown||"[Block content not directly in markdown field]"}

`}),s+="--- End of Blocks ---",console.log("Formatted structured context length:",s.length),s}catch(e){return console.error("Error fetching or processing structured document context:",e),`Error retrieving document structure: ${e.message}`}}async function Rt(t){if(!t||t.length===0)return"";console.log(`Fetching context for specific block IDs: ${t.join(", ")}`);try{const n=`SELECT id, type, markdown FROM blocks WHERE id IN (${t.map(a=>`'${a}'`).join(", ")})`,o=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:n})});if(!o.ok){const a=await o.text();throw new Error(`SQL query for references failed with status ${o.status}: ${a}`)}const s=await o.json();if(s.code!==0)throw new Error(`API returned error code ${s.code} for references: ${s.msg}`);if(!s.data||!Array.isArray(s.data))return console.log("No block data returned for referenced IDs."),"Could not retrieve content for referenced blocks.";console.log("Raw SQL query result data for references:",s.data);const i=new Map(s.data.map(a=>[a.id,a])),r=t.map(a=>i.get(a)).filter(Boolean);let l=`Referenced content:
`;return r.forEach((a,c)=>{l+=`--- Referenced Block ${c+1} (ID: ${a.id}, Type: ${a.type}) ---
${a.markdown||"[Block content not directly in markdown field]"}

`}),l+="--- End of Referenced Blocks ---",console.log("Formatted referenced context length:",l.length),l}catch(e){return console.error("Error fetching or processing referenced block context:",e),`Error retrieving referenced content: ${e.message}`}}function qt(){console.log("Loading messages (ensure format is correct)...")}function Ze(t){let e=t;for(;e&&e!==document.body;){if(e instanceof HTMLElement&&e.dataset.nodeId)return e;e=e.parentNode}return null}function Lt(){var D,_,f;const t=window.getSelection();if(!t||t.rangeCount===0||t.isCollapsed||!t.anchorNode||!t.focusNode)return[];const e=t.getRangeAt(0),n=e.startContainer,o=(D=n instanceof Node&&n.nodeType===Node.ELEMENT_NODE?n:n.parentElement)==null?void 0:D.closest(".protyle-wysiwyg");if(!o)return[];const s=Ze(e.startContainer),i=Ze(e.endContainer);if(console.log("Found start block node:",(_=s==null?void 0:s.dataset)==null?void 0:_.nodeId,s),console.log("Found end block node:",(f=i==null?void 0:i.dataset)==null?void 0:f.nodeId,i),!s&&!i)return console.log("Neither start nor end of selection is inside a block."),[];if(s&&s===i)return console.log("Selection within single block:",s.dataset.nodeId),[s.dataset.nodeId];const r=Array.from(o.querySelectorAll("[data-node-id]")),l=[],a=s||r[0],c=i||r[r.length-1];let w=r.findIndex(B=>B===a),p=r.findIndex(B=>B===c);if(console.log(`Calculated indices: Start=${w}, End=${p}`),w===-1||p===-1)return console.error("Could not reliably determine selection range indices within editor blocks."),s&&l.push(s.dataset.nodeId),i&&i!==s&&l.push(i.dataset.nodeId),l;w>p&&([w,p]=[p,w],console.log("Swapped indices"));for(let B=w;B<=p;B++){const N=r[B];N!=null&&N.dataset.nodeId&&l.push(N.dataset.nodeId)}return console.log("Final selected block IDs:",l),Array.from(new Set(l))}function xt(t,e,n){let o,{pluginData:s}=e,i=he([]);lt(t,i,d=>n(6,o=d));let r="",l,a=!1,c,w=[],p=null,D=null,_="",f=[],B=!1;const N=ke.subscribe(d=>{c=d}),W=$e.subscribe(d=>{n(3,w=d.sort((m,v)=>v.timestamp-m.timestamp))}),$=ye.subscribe(d=>{D=d}),J=ve.subscribe(d=>{});oe.subscribe(d=>{}),ct(async()=>{const d="有什么可以帮您？";i.set([{id:Date.now().toString()+"init",role:"assistant",content:d,html:ne(d)}]),qt(),await me(),x(),document.addEventListener("mouseup",Z)}),yt(()=>{N(),W(),$(),J(),document.removeEventListener("mouseup",Z)});async function L(){q(i).length>1&&!p&&!a&&(console.log("Auto-saving previous conversation..."),await S());const d="新对话已开始，有什么可以帮您？",m=ne(d);i.set([{id:Date.now().toString()+"init-new",role:"assistant",content:d,html:m}]),n(4,p=null),n(0,r=""),await me(),x()}async function S(){if(a||q(i).length<=1||p)return;const d=Date.now(),m=d.toString(),v=`对话 ${new Date(d).toLocaleString()}`,F=[{id:m,name:v,timestamp:d,messages:q(i).filter(u=>u.role==="user"||u.role==="assistant").map(({role:u,content:y})=>({role:u,content:y}))},...w];await s.saveConversations(F),n(4,p=m),console.log("Conversation saved with ID:",m)}function V(d){const m=w.find(v=>v.id===d);m&&(i.update(v=>m.messages.map((I,F)=>({...I,id:F,html:I.role==="assistant"?ne(I.content):void 0}))),n(4,p=m.id),q(i).length,n(0,r=""),me().then(x),console.log("Conversation loaded:",d))}async function k(d,m){if(m.stopPropagation(),confirm("确定要删除这个对话吗？")){const v=w.filter(I=>I.id!==d);await s.saveConversations(v),p===d&&L(),console.log("Conversation deleted:",d)}}async function R(d){console.log(`Attempting to delete block: ${d}`);try{const m=await fetch("/api/block/deleteBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:d})});if(!m.ok){const I=await m.text();throw new Error(`API deleteBlock failed (${m.status}): ${I}`)}const v=await m.json();if(v.code!==0)throw new Error(`API deleteBlock returned error code ${v.code}: ${v.msg}`);console.log(`Block ${d} deleted successfully.`)}catch(m){throw console.error(`Error executing deleteBlock for ${d}:`,m),_=`删除块 ${d} 失败: ${m.message}`,m}}async function C(d,m){console.log(`Attempting to update block ${d} with new markdown:`,m);try{const v=await fetch("/api/block/updateBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:d,dataType:"markdown",data:m})});if(!v.ok){const F=await v.text();throw new Error(`API updateBlock failed (${v.status}): ${F}`)}const I=await v.json();if(I.code!==0)throw new Error(`API updateBlock returned error code ${I.code}: ${I.msg}`);console.log(`Block ${d} updated successfully.`)}catch(v){throw console.error(`Error executing updateBlock for ${d}:`,v),_=`更新块 ${d} 失败: ${v.message}`,v}}async function O(){if(!r.trim()||a)return;_="",n(2,a=!0);const m={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:r.trim()};i.update(A=>[...A,m]),i.set([...q(i)]),console.log("User message added to store:",q(i)),r.trim(),n(0,r=""),await me(),x();let v="",I="";const u=q(oe).filter(A=>A.type==="selection");if(D){console.log("Fetching structured context for document ID:",D);try{v=await Mt(D),console.log("Fetched main document context length:",(v==null?void 0:v.length)??0)}catch(A){console.error("Error fetching structured document context:",A),_=`获取文档结构上下文失败: ${A.message}`}}else console.log("No currentDocId, skipping main document context fetch.");if(u.length>0){const A=Array.from(new Set(u.flatMap(Y=>Y.blockIds)));console.log("Found selection references, fetching referenced context for IDs:",A);try{I=await Rt(A),console.log("Fetched referenced context length:",(I==null?void 0:I.length)??0)}catch(Y){console.error("Error fetching referenced block context:",Y),_=`获取引用块上下文失败: ${Y.message}`}}let y="";v&&(y+=v),I&&(y&&(y+=`

`),y+=I);const gt=q(i).filter(A=>A.role==="user"||A.role==="assistant").slice(-20).map(A=>({role:A.role,content:A.content}));let qe='You are a helpful AI assistant integrated into Siyuan Note.\nYou can interact with the document content. \nWhen you need to modify the document based on the user\'s request, output **only** a JSON command block with the required action. \nUse the block IDs provided in the context.\n\nAvailable actions:\n1. To delete a block: ```json {"action": "delete", "block_id": "BLOCK_ID_TO_DELETE"} ```\n2. To update a block\'s content: ```json {"action": "update", "block_id": "BLOCK_ID_TO_UPDATE", "new_markdown": "NEW_MARKDOWN_CONTENT"} ```\n\nIf you are just answering a question or providing information, respond normally without the JSON block.';y&&(qe+=`

${y}`);const Le=[{role:"system",content:qe},...gt];console.log("Messages being sent to API (final format):",Le);try{const A=await At(Le,c);let Y=!1;const re=A.match(/```json\n({.*?})\n```/s);if(re&&re[1])try{const M=JSON.parse(re[1]);if(console.log("Parsed AI command:",M),M.action==="delete"&&M.block_id){await R(M.block_id),Y=!0;const ge=Date.now().toString()+"cmd-del";i.update(pe=>[...pe,{id:ge,role:"assistant",content:`已执行删除块 ${M.block_id} 的操作。`,html:ne(`已执行删除块 **${M.block_id}** 的操作。`)}]),i.set([...q(i)])}else if(M.action==="update"&&M.block_id&&typeof M.new_markdown=="string"){await C(M.block_id,M.new_markdown),Y=!0;const ge=Date.now().toString()+"cmd-upd";i.update(pe=>[...pe,{id:ge,role:"assistant",content:`已执行更新块 ${M.block_id} 的操作。`,html:ne(`已执行更新块 **${M.block_id}** 的操作。`)}]),i.set([...q(i)])}else console.warn("Parsed command JSON has invalid action or missing parameters:",M)}catch(M){console.error("Failed to parse command JSON:",M,"Raw content:",re[1])}if(!Y){const ge={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:A,html:ne(A)};i.update(pe=>[...pe,ge]),i.set([...q(i)]),console.log("Assistant message added to store:",q(i))}}catch(A){console.error("Error fetching chat completion:",A),_=`AI 请求失败: ${A.message}`;const re={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`抱歉，请求出错: ${_}`,html:ne(`抱歉，请求出错: ${_}`)};i.update(M=>[...M,re]),i.set([...q(i)]),console.log("Error message added to store:",q(i))}finally{n(2,a=!1),u.length>0&&(console.log("Clearing selection references."),oe.update(A=>A.filter(Y=>Y.type!=="selection"))),await me(),x()}}function x(){l&&requestAnimationFrame(()=>{n(1,l.scrollTop=l.scrollHeight,l)})}function Z(){setTimeout(()=>{f=Lt(),n(5,B=f.length>0)},100)}function ee(){var F;if(!B||f.length===0)return;const d=`sel-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,v=`选区 ${q(oe).filter(u=>u.type==="selection").length+1}`,I={id:d,label:v,blockIds:[...f],type:"selection"};oe.update(u=>[...u,I]),f=[],n(5,B=!1),(F=window.getSelection())==null||F.removeAllRanges()}const E=d=>V(d.currentTarget.value),P=d=>k(p,d);function G(d){Ie[d?"unshift":"push"](()=>{l=d,n(1,l)})}function j(){r=this.value,n(0,r)}const le=d=>{d.key==="Enter"&&!d.shiftKey&&(d.preventDefault(),O())};return t.$$set=d=>{"pluginData"in d&&n(14,s=d.pluginData)},[r,l,a,w,p,B,o,i,L,S,V,k,O,ee,s,E,P,G,j,le]}class Ot extends Re{constructor(e){super(),Me(this,e,xt,Pt,De,{pluginData:14},null,[-1,-1])}}function et(t){let e,n;return{c(){e=b("span"),n=se(t[3]),g(e,"class","status-message svelte-136cw2s")},m(o,s){K(o,e,s),h(e,n)},p(o,s){s&8&&Ne(n,o[3])},d(o){o&&H(e)}}}function jt(t){let e,n,o,s,i,r,l,a,c,w,p,D,_,f,B,N,W,$,J,L,S,V,k,R,C,O,x,Z,ee,E=t[3]&&et(t);return{c(){e=b("div"),n=b("h2"),n.textContent="AI 助手设置",o=T(),s=b("div"),i=b("label"),i.textContent="AI API Endpoint URL:",r=T(),l=b("input"),a=T(),c=b("p"),c.textContent="请输入您要使用的 AI 服务的完整 URL。",w=T(),p=b("div"),D=b("label"),D.textContent="API Key:",_=T(),f=b("input"),B=T(),N=b("p"),N.textContent="您的 API Key 将被保存在本地配置文件中。",W=T(),$=b("div"),J=b("label"),J.textContent="模型名称:",L=T(),S=b("input"),V=T(),k=b("p"),k.textContent="请输入要调用的具体模型名称。",R=T(),C=b("div"),O=b("button"),O.textContent="保存设置",x=T(),E&&E.c(),g(n,"class","svelte-136cw2s"),g(i,"for","api-url"),g(i,"class","svelte-136cw2s"),g(l,"id","api-url"),g(l,"type","text"),g(l,"placeholder","例如: https://api.openai.com/v1/chat/completions"),g(l,"class","b3-text-field svelte-136cw2s"),g(c,"class","description svelte-136cw2s"),g(s,"class","form-item svelte-136cw2s"),g(D,"for","api-key"),g(D,"class","svelte-136cw2s"),g(f,"id","api-key"),g(f,"type","password"),g(f,"placeholder","请输入您的 API Key"),g(f,"class","b3-text-field svelte-136cw2s"),g(N,"class","description svelte-136cw2s"),g(p,"class","form-item svelte-136cw2s"),g(J,"for","model-name"),g(J,"class","svelte-136cw2s"),g(S,"id","model-name"),g(S,"type","text"),g(S,"placeholder","例如: deepseek-chat, gpt-4o, ..."),g(S,"class","b3-text-field svelte-136cw2s"),g(k,"class","description svelte-136cw2s"),g($,"class","form-item svelte-136cw2s"),g(O,"class","b3-button b3-button--primary"),g(C,"class","actions svelte-136cw2s"),g(e,"class","settings-panel svelte-136cw2s")},m(P,G){K(P,e,G),h(e,n),h(e,o),h(e,s),h(s,i),h(s,r),h(s,l),X(l,t[0]),h(s,a),h(s,c),h(e,w),h(e,p),h(p,D),h(p,_),h(p,f),X(f,t[1]),h(p,B),h(p,N),h(e,W),h(e,$),h($,J),h($,L),h($,S),X(S,t[2]),h($,V),h($,k),h(e,R),h(e,C),h(C,O),h(C,x),E&&E.m(C,null),Z||(ee=[z(l,"input",t[8]),z(f,"input",t[9]),z(S,"input",t[10]),z(O,"click",t[4])],Z=!0)},p(P,[G]){G&1&&l.value!==P[0]&&X(l,P[0]),G&2&&f.value!==P[1]&&X(f,P[1]),G&4&&S.value!==P[2]&&X(S,P[2]),P[3]?E?E.p(P,G):(E=et(P),E.c(),E.m(C,null)):E&&(E.d(1),E=null)},i:Q,o:Q,d(P){P&&H(e),E&&E.d(),Z=!1,ie(ee)}}}function Ut(t,e,n){let{loadSettings:o}=e,{saveSettings:s}=e,{currentSettings:i}=e,r="",l="",a="",c="";ct(async()=>{if(i)n(0,r=i.apiUrl||""),n(1,l=i.apiKey||""),n(2,a=i.modelName||"deepseek-chat");else{const f=await o();n(0,r=f.apiUrl||""),n(1,l=f.apiKey||""),n(2,a=f.modelName||"deepseek-chat")}});async function w(){try{await s({apiUrl:r,apiKey:l,modelName:a}),n(3,c="设置已保存！"),setTimeout(()=>n(3,c=""),3e3)}catch(f){n(3,c=`保存失败: ${f.message}`)}}function p(){r=this.value,n(0,r)}function D(){l=this.value,n(1,l)}function _(){a=this.value,n(2,a)}return t.$$set=f=>{"loadSettings"in f&&n(5,o=f.loadSettings),"saveSettings"in f&&n(6,s=f.saveSettings),"currentSettings"in f&&n(7,i=f.currentSettings)},[r,l,a,c,w,o,s,i,p,D,_]}class Ht extends Re{constructor(e){super(),Me(this,e,Ut,jt,De,{loadSettings:5,saveSettings:6,currentSettings:7})}}const tt="ai-assistant-config",nt="ai-assistant-conversations",Kt={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},Jt="ai_assistant_dock";class zt extends Se.Plugin{constructor(){super(...arguments);te(this,"isMobile");te(this,"settings");te(this,"settingsDialog",null);te(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const n=Se.getFrontend();this.isMobile=n==="mobile"||n==="browser-mobile",await this.loadSettings(),await this.loadConversations(),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this,saveConversations:this.saveConversations.bind(this)},type:Jt,init(o){new Ot({target:o.element,props:{pluginData:o.data}}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:n}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",n),n&&n.protyle&&n.protyle.block&&n.protyle.block.rootID){const o=n.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${o}`),ye.set(o),console.log(`Current document ID updated via switch-protyle: ${o}`),n.protyle.path){const s=n.protyle.path;console.log(`Doc Path found in protyle.path: ${s}`),ve.set(s),console.log(`Current document Path updated via switch-protyle: ${s}`)}else console.warn("Doc Path not found in protyle detail."),ve.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),ye.set(null),ve.set(null)}updateCurrentDocIdFromActiveTab(){var n;console.log("Attempting to get doc ID from active tab...");try{const o=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(o){console.log("Active protyle tab element found.");let s=o,i=s==null?void 0:s.protyle;for(;s&&!i;)i=s==null?void 0:s.protyle,s=s.parentElement;if((n=i==null?void 0:i.block)!=null&&n.rootID){const r=i.block.rootID;ye.set(r),console.log(`Updated doc ID from active tab in onLayoutReady: ${r}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:i});const r=o.getAttribute("data-node-id");r&&console.log(`Found node-id on active tab: ${r}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(o){console.error("Error getting doc ID from active tab:",o)}}openSetting(){this.settingsDialog||(this.settingsDialog=new Se.Dialog({title:"AI 助手设置",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new Ht({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const n=await this.loadData(tt);return this.settings=Object.assign({},Kt,n),ke.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(n){this.settings=n,await this.saveData(tt,this.settings),ke.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const n=await this.loadData(nt)||[];$e.set(n),console.log(`${n.length} conversations loaded.`)}async saveConversations(n){await this.saveData(nt,n),$e.set(n),console.log(`Conversations saved (${n.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=zt;
