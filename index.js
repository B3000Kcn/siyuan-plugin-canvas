"use strict";var dt=Object.defineProperty;var ft=(t,e,n)=>e in t?dt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var te=(t,e,n)=>ft(t,typeof e!="symbol"?e+"":e,n);const ke=require("siyuan");function Q(){}function et(t){return t()}function qe(){return Object.create(null)}function se(t){t.forEach(et)}function tt(t){return typeof t=="function"}function _e(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function ht(t){return Object.keys(t).length===0}function nt(t,...e){if(t==null){for(const o of e)o(void 0);return Q}const n=t.subscribe(...e);return n.unsubscribe?()=>n.unsubscribe():n}function x(t){let e;return nt(t,n=>e=n)(),e}function ot(t,e,n){t.$$.on_destroy.push(nt(e,n))}const gt=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function f(t,e){t.appendChild(e)}function U(t,e,n){t.insertBefore(e,n||null)}function O(t){t.parentNode&&t.parentNode.removeChild(t)}function b(t){return document.createElement(t)}function oe(t){return document.createTextNode(t)}function E(){return oe(" ")}function Ie(){return oe("")}function z(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function h(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function pt(t){return Array.from(t.childNodes)}function Be(t,e){e=""+e,t.data!==e&&(t.data=e)}function W(t,e){t.value=e??""}let ge;function he(t){ge=t}function st(){if(!ge)throw new Error("Function called outside component initialization");return ge}function lt(t){st().$$.on_mount.push(t)}function mt(t){st().$$.on_destroy.push(t)}const re=[],De=[];let ae=[];const Le=[],it=Promise.resolve();let Ce=!1;function rt(){Ce||(Ce=!0,it.then(ct))}function de(){return rt(),it}function Ee(t){ae.push(t)}const Se=new Set;let le=0;function ct(){if(le!==0)return;const t=ge;do{try{for(;le<re.length;){const e=re[le];le++,he(e),bt(e.$$)}}catch(e){throw re.length=0,le=0,e}for(he(null),re.length=0,le=0;De.length;)De.pop()();for(let e=0;e<ae.length;e+=1){const n=ae[e];Se.has(n)||(Se.add(n),n())}ae.length=0}while(re.length);for(;Le.length;)Le.pop()();Ce=!1,Se.clear(),he(t)}function bt(t){if(t.fragment!==null){t.update(),se(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(Ee)}}function wt(t){const e=[],n=[];ae.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),ae=e}const pe=new Set;let _t;function Me(t,e){t&&t.i&&(pe.delete(t),t.i(e))}function yt(t,e,n,o){if(t&&t.o){if(pe.has(t))return;pe.add(t),_t.c.push(()=>{pe.delete(t)}),t.o(e)}}function ce(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function Ae(t,e){t.d(1),e.delete(t.key)}function Fe(t,e,n,o,s,l,r,i,a,c,m,p){let y=t.length,w=l.length,d=y;const A={};for(;d--;)A[t[d].key]=d;const M=[],J=new Map,T=new Map,j=[];for(d=w;d--;){const _=p(s,l,d),R=n(_);let k=r.get(R);k?j.push(()=>k.p(_,e)):(k=c(R,_),k.c()),J.set(R,M[d]=k),R in A&&T.set(R,Math.abs(d-A[R]))}const L=new Set,I=new Set;function V(_){Me(_,1),_.m(i,m),r.set(_.key,_),m=_.first,w--}for(;y&&w;){const _=M[w-1],R=t[y-1],k=_.key,$=R.key;_===R?(m=_.first,y--,w--):J.has($)?!r.has(k)||L.has(k)?V(_):I.has($)?y--:T.get(k)>T.get($)?(I.add(k),V(_)):(L.add($),y--):(a(R,r),y--)}for(;y--;){const _=t[y];J.has(_.key)||a(_,r)}for(;w;)V(M[w-1]);return se(j),M}function vt(t){t&&t.c()}function at(t,e,n){const{fragment:o,after_update:s}=t.$$;o&&o.m(e,n),Ee(()=>{const l=t.$$.on_mount.map(et).filter(tt);t.$$.on_destroy?t.$$.on_destroy.push(...l):se(l),t.$$.on_mount=[]}),s.forEach(Ee)}function ut(t,e){const n=t.$$;n.fragment!==null&&(wt(n.after_update),se(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function kt(t,e){t.$$.dirty[0]===-1&&(re.push(t),rt(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Ne(t,e,n,o,s,l,r=null,i=[-1]){const a=ge;he(t);const c=t.$$={fragment:null,ctx:[],props:l,update:Q,not_equal:s,bound:qe(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:qe(),dirty:i,skip_bound:!1,root:e.target||a.$$.root};r&&r(c.root);let m=!1;if(c.ctx=n?n(t,e.props||{},(p,y,...w)=>{const d=w.length?w[0]:y;return c.ctx&&s(c.ctx[p],c.ctx[p]=d)&&(!c.skip_bound&&c.bound[p]&&c.bound[p](d),m&&kt(t,p)),y}):[],c.update(),m=!0,se(c.before_update),c.fragment=o?o(c.ctx):!1,e.target){if(e.hydrate){const p=pt(e.target);c.fragment&&c.fragment.l(p),p.forEach(O)}else c.fragment&&c.fragment.c();e.intro&&Me(t.$$.fragment),at(t,e.target,e.anchor),ct()}he(a)}class Re{constructor(){te(this,"$$");te(this,"$$set")}$destroy(){ut(this,1),this.$destroy=Q}$on(e,n){if(!tt(n))return Q;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const s=o.indexOf(n);s!==-1&&o.splice(s,1)}}$set(e){this.$$set&&!ht(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const St="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(St);const ie=[];function ue(t,e=Q){let n;const o=new Set;function s(i){if(_e(t,i)&&(t=i,n)){const a=!ie.length;for(const c of o)c[1](),ie.push(c,t);if(a){for(let c=0;c<ie.length;c+=2)ie[c][0](ie[c+1]);ie.length=0}}}function l(i){s(i(t))}function r(i,a=Q){const c=[i,a];return o.add(c),o.size===1&&(n=e(s,l)||Q),i(t),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:s,update:l,subscribe:r}}const we=ue({apiKey:"",modelName:"deepseek-chat"}),Te=ue([]),me=ue(null),be=ue(null),ne=ue([]);async function It(t){const e=x(we);if(!e.apiKey||!e.apiUrl)throw new Error("API Key 或 API URL 未配置");const n=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:t,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!n.ok){const s=await n.text();throw new Error(`API 请求失败: ${n.status} ${s}`)}const o=await n.json();if(!o.choices||o.choices.length===0)throw new Error("API 返回数据格式错误");return o.choices[0].message.content}function fe(t){return window.Lute.New().Md2HTML(t)}function $e(t,e,n){const o=t.slice();return o[3]=e[n],o}function xe(t){let e,n,o,s,l=[],r=new Map,i=ce(t[0]);const a=c=>c[3].id;for(let c=0;c<i.length;c+=1){let m=$e(t,i,c),p=a(m);r.set(p,l[c]=He(p,m))}return{c(){e=b("div"),n=b("span"),n.textContent="引用内容:",o=E(),s=b("div");for(let c=0;c<l.length;c+=1)l[c].c();h(n,"class","svelte-m85l6"),h(s,"class","reference-tags svelte-m85l6"),h(e,"class","reference-context-bar svelte-m85l6")},m(c,m){U(c,e,m),f(e,n),f(e,o),f(e,s);for(let p=0;p<l.length;p+=1)l[p]&&l[p].m(s,null)},p(c,m){m&3&&(i=ce(c[0]),l=Fe(l,m,a,1,c,i,r,s,Ae,He,null,$e))},d(c){c&&O(e);for(let m=0;m<l.length;m+=1)l[m].d()}}}function Oe(t){let e,n,o;function s(){return t[2](t[3])}return{c(){e=b("button"),e.textContent="×",h(e,"class","remove-tag-button svelte-m85l6"),h(e,"title","移除引用")},m(l,r){U(l,e,r),n||(o=z(e,"click",s),n=!0)},p(l,r){t=l},d(l){l&&O(e),n=!1,o()}}}function He(t,e){let n,o=e[3].label+"",s,l,r,i=e[3].type==="selection"&&Oe(e);return{key:t,first:null,c(){n=b("span"),s=oe(o),l=E(),i&&i.c(),r=E(),h(n,"class","reference-tag svelte-m85l6"),this.first=n},m(a,c){U(a,n,c),f(n,s),f(n,l),i&&i.m(n,null),f(n,r)},p(a,c){e=a,c&1&&o!==(o=e[3].label+"")&&Be(s,o),e[3].type==="selection"?i?i.p(e,c):(i=Oe(e),i.c(),i.m(n,r)):i&&(i.d(1),i=null)},d(a){a&&O(n),i&&i.d()}}}function Dt(t){let e,n=t[0].length>0&&xe(t);return{c(){n&&n.c(),e=Ie()},m(o,s){n&&n.m(o,s),U(o,e,s)},p(o,[s]){o[0].length>0?n?n.p(o,s):(n=xe(o),n.c(),n.m(e.parentNode,e)):n&&(n.d(1),n=null)},i:Q,o:Q,d(o){o&&O(e),n&&n.d(o)}}}function Ct(t,e,n){let o;ot(t,ne,r=>n(0,o=r));function s(r){ne.update(i=>i.filter(a=>a.id!==r))}return[o,s,r=>s(r.id)]}class Et extends Re{constructor(e){super(),Ne(this,e,Ct,Dt,_e,{})}}const{Map:Ue}=gt;function je(t,e,n){const o=t.slice();return o[33]=e[n],o}function Ke(t,e,n){const o=t.slice();return o[36]=e[n],o}function ze(t){let e,n,o;return{c(){e=b("button"),e.textContent="保存当前对话",h(e,"class","b3-button b3-button--outline svelte-t2qwxc")},m(s,l){U(s,e,l),n||(o=z(e,"click",t[9]),n=!0)},p:Q,d(s){s&&O(e),n=!1,o()}}}function Qe(t,e){let n,o=e[36].name+"",s,l;return{key:t,first:null,c(){n=b("option"),s=oe(o),n.__value=l=e[36].id,W(n,n.__value),this.first=n},m(r,i){U(r,n,i),f(n,s)},p(r,i){e=r,i[0]&8&&o!==(o=e[36].name+"")&&Be(s,o),i[0]&8&&l!==(l=e[36].id)&&(n.__value=l,W(n,n.__value))},d(r){r&&O(n)}}}function Ve(t){let e,n,o;return{c(){e=b("button"),e.textContent="删除当前",h(e,"class","b3-button b3-button--error svelte-t2qwxc"),h(e,"title","删除当前对话")},m(s,l){U(s,e,l),n||(o=z(e,"click",t[16]),n=!0)},p:Q,d(s){s&&O(e),n=!1,o()}}}function At(t){let e,n=(t[33].html||t[33].content)+"";return{c(){e=b("div"),h(e,"class","message ai svelte-t2qwxc")},m(o,s){U(o,e,s),e.innerHTML=n},p(o,s){s[0]&64&&n!==(n=(o[33].html||o[33].content)+"")&&(e.innerHTML=n)},d(o){o&&O(e)}}}function Ft(t){let e,n,o=t[33].content.replace(/\n/g,"<br/>")+"";return{c(){e=b("div"),n=b("div"),h(e,"class","message user svelte-t2qwxc")},m(s,l){U(s,e,l),f(e,n),n.innerHTML=o},p(s,l){l[0]&64&&o!==(o=s[33].content.replace(/\n/g,"<br/>")+"")&&(n.innerHTML=o)},d(s){s&&O(e)}}}function Ge(t,e){let n,o;function s(i,a){if(i[33].role==="user")return Ft;if(i[33].role==="assistant")return At}let l=s(e),r=l&&l(e);return{key:t,first:null,c(){n=Ie(),r&&r.c(),o=Ie(),this.first=n},m(i,a){U(i,n,a),r&&r.m(i,a),U(i,o,a)},p(i,a){e=i,l===(l=s(e))&&r?r.p(e,a):(r&&r.d(1),r=l&&l(e),r&&(r.c(),r.m(o.parentNode,o)))},d(i){i&&(O(n),O(o)),r&&r.d(i)}}}function Je(t){let e;return{c(){e=b("div"),e.innerHTML='<p class="svelte-t2qwxc">AI 正在思考...</p>',h(e,"class","message ai loading svelte-t2qwxc")},m(n,o){U(n,e,o)},d(n){n&&O(e)}}}function Tt(t){let e,n,o,s,l=x(t[7]).length>1&&!t[4]&&!t[2],r,i,a,c=[],m=new Ue,p,y,w,d=[],A=new Ue,M,J,T,j,L,I,V,_,R,k,$,K,Z,X,D,P,Y,u=l&&ze(t),B=ce(t[3]);const N=g=>g[36].id;for(let g=0;g<B.length;g+=1){let S=Ke(t,B,g),q=N(S);m.set(q,c[g]=Qe(q,S))}let v=t[4]&&Ve(t),G=ce(t[6]);const H=g=>g[33].id;for(let g=0;g<G.length;g+=1){let S=je(t,G,g),q=H(S);A.set(q,d[g]=Ge(q,S))}let F=t[2]&&Je();return T=new Et({}),{c(){e=b("div"),n=b("div"),o=b("button"),o.textContent="新建对话",s=E(),u&&u.c(),r=E(),i=b("select"),a=b("option"),a.textContent="加载历史对话";for(let g=0;g<c.length;g+=1)c[g].c();p=E(),v&&v.c(),y=E(),w=b("div");for(let g=0;g<d.length;g+=1)d[g].c();M=E(),F&&F.c(),J=E(),vt(T.$$.fragment),j=E(),L=b("div"),I=b("textarea"),V=E(),_=b("button"),R=oe("发送"),$=E(),K=b("button"),Z=oe("引用选区"),h(o,"class","b3-button svelte-t2qwxc"),a.__value="",W(a,a.__value),a.disabled=!0,a.selected=!0,h(i,"class","b3-select svelte-t2qwxc"),h(i,"title","加载历史对话"),h(n,"class","conversation-controls svelte-t2qwxc"),h(w,"class","chat-history svelte-t2qwxc"),h(I,"placeholder","在此输入您的问题或指令..."),h(I,"rows","3"),I.disabled=t[2],h(I,"class","svelte-t2qwxc"),_.disabled=k=!t[0].trim()||t[2],h(_,"class","svelte-t2qwxc"),h(K,"class","add-reference-button svelte-t2qwxc"),h(K,"title","添加当前选中文本作为引用"),K.disabled=X=!t[5]||t[2],h(L,"class","input-area svelte-t2qwxc"),h(e,"class","ai-chat-panel svelte-t2qwxc")},m(g,S){U(g,e,S),f(e,n),f(n,o),f(n,s),u&&u.m(n,null),f(n,r),f(n,i),f(i,a);for(let q=0;q<c.length;q+=1)c[q]&&c[q].m(i,null);f(n,p),v&&v.m(n,null),f(e,y),f(e,w);for(let q=0;q<d.length;q+=1)d[q]&&d[q].m(w,null);f(w,M),F&&F.m(w,null),t[17](w),f(e,J),at(T,e,null),f(e,j),f(e,L),f(L,I),W(I,t[0]),f(L,V),f(L,_),f(_,R),f(L,$),f(L,K),f(K,Z),D=!0,P||(Y=[z(o,"click",t[8]),z(i,"change",t[15]),z(I,"input",t[18]),z(I,"keydown",t[19]),z(_,"click",t[12]),z(K,"click",t[13])],P=!0)},p(g,S){S[0]&20&&(l=x(g[7]).length>1&&!g[4]&&!g[2]),l?u?u.p(g,S):(u=ze(g),u.c(),u.m(n,r)):u&&(u.d(1),u=null),S[0]&8&&(B=ce(g[3]),c=Fe(c,S,N,1,g,B,m,i,Ae,Qe,null,Ke)),g[4]?v?v.p(g,S):(v=Ve(g),v.c(),v.m(n,null)):v&&(v.d(1),v=null),S[0]&64&&(G=ce(g[6]),d=Fe(d,S,H,1,g,G,A,w,Ae,Ge,M,je)),g[2]?F||(F=Je(),F.c(),F.m(w,null)):F&&(F.d(1),F=null),(!D||S[0]&4)&&(I.disabled=g[2]),S[0]&1&&W(I,g[0]),(!D||S[0]&5&&k!==(k=!g[0].trim()||g[2]))&&(_.disabled=k),(!D||S[0]&36&&X!==(X=!g[5]||g[2]))&&(K.disabled=X)},i(g){D||(Me(T.$$.fragment,g),D=!0)},o(g){yt(T.$$.fragment,g),D=!1},d(g){g&&O(e),u&&u.d();for(let S=0;S<c.length;S+=1)c[S].d();v&&v.d();for(let S=0;S<d.length;S+=1)d[S].d();F&&F.d(),t[17](null),ut(T),P=!1,se(Y)}}}async function Bt(t){if(!t)return console.log("No docId provided for structured context fetch."),"";console.log(`Fetching structured context for document ID: ${t}`);try{const e=`SELECT id, type, markdown FROM blocks WHERE parent_id = '${t}' ORDER BY sort ASC`,n=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:e})});if(!n.ok){const l=await n.text();throw new Error(`SQL query failed with status ${n.status}: ${l}`)}const o=await n.json();if(o.code!==0)throw new Error(`API returned error code ${o.code}: ${o.msg}`);if(console.log("Raw SQL query result data:",o.data),!o.data||!Array.isArray(o.data))return console.log("No block data returned from SQL query or data is not an array."),"Document is empty or contains no text blocks.";let s=`Current document context (Blocks ordered by position):
`;return o.data.forEach((l,r)=>{s+=`--- Block ${r+1} (ID: ${l.id}, Type: ${l.type}) ---
${l.markdown||"[Block content not directly in markdown field]"}

`}),s+="--- End of Blocks ---",console.log("Formatted structured context length:",s.length),s}catch(e){return console.error("Error fetching or processing structured document context:",e),`Error retrieving document structure: ${e.message}`}}async function Mt(t){if(!t||t.length===0)return"";console.log(`Fetching context for specific block IDs: ${t.join(", ")}`);try{const n=`SELECT id, type, markdown FROM blocks WHERE id IN (${t.map(a=>`'${a}'`).join(", ")})`,o=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:n})});if(!o.ok){const a=await o.text();throw new Error(`SQL query for references failed with status ${o.status}: ${a}`)}const s=await o.json();if(s.code!==0)throw new Error(`API returned error code ${s.code} for references: ${s.msg}`);if(!s.data||!Array.isArray(s.data))return console.log("No block data returned for referenced IDs."),"Could not retrieve content for referenced blocks.";console.log("Raw SQL query result data for references:",s.data);const l=new Map(s.data.map(a=>[a.id,a])),r=t.map(a=>l.get(a)).filter(Boolean);let i=`Referenced content:
`;return r.forEach((a,c)=>{i+=`--- Referenced Block ${c+1} (ID: ${a.id}, Type: ${a.type}) ---
${a.markdown||"[Block content not directly in markdown field]"}

`}),i+="--- End of Referenced Blocks ---",console.log("Formatted referenced context length:",i.length),i}catch(e){return console.error("Error fetching or processing referenced block context:",e),`Error retrieving referenced content: ${e.message}`}}function Nt(){console.log("Loading messages (ensure format is correct)...")}function Ye(t){let e=t;for(;e&&e!==document.body;){if(e instanceof HTMLElement&&e.dataset.nodeId)return e;e=e.parentNode}return null}function Rt(){var y,w,d;const t=window.getSelection();if(!t||t.rangeCount===0||t.isCollapsed||!t.anchorNode||!t.focusNode)return[];const e=t.getRangeAt(0),n=e.startContainer,o=(y=n instanceof Node&&n.nodeType===Node.ELEMENT_NODE?n:n.parentElement)==null?void 0:y.closest(".protyle-wysiwyg");if(!o)return[];const s=Ye(e.startContainer),l=Ye(e.endContainer);if(console.log("Found start block node:",(w=s==null?void 0:s.dataset)==null?void 0:w.nodeId,s),console.log("Found end block node:",(d=l==null?void 0:l.dataset)==null?void 0:d.nodeId,l),!s&&!l)return console.log("Neither start nor end of selection is inside a block."),[];if(s&&s===l)return console.log("Selection within single block:",s.dataset.nodeId),[s.dataset.nodeId];const r=Array.from(o.querySelectorAll("[data-node-id]")),i=[],a=s||r[0],c=l||r[r.length-1];let m=r.findIndex(A=>A===a),p=r.findIndex(A=>A===c);if(console.log(`Calculated indices: Start=${m}, End=${p}`),m===-1||p===-1)return console.error("Could not reliably determine selection range indices within editor blocks."),s&&i.push(s.dataset.nodeId),l&&l!==s&&i.push(l.dataset.nodeId),i;m>p&&([m,p]=[p,m],console.log("Swapped indices"));for(let A=m;A<=p;A++){const M=r[A];M!=null&&M.dataset.nodeId&&i.push(M.dataset.nodeId)}return console.log("Final selected block IDs:",i),Array.from(new Set(i))}function Pt(t,e,n){let o,{pluginData:s}=e,l=ue([]);ot(t,l,u=>n(6,o=u));let r="",i,a=!1,c,m=[],p=null,y=null,w="",d=[],A=!1;const M=we.subscribe(u=>{c=u}),J=Te.subscribe(u=>{n(3,m=u.sort((B,N)=>N.timestamp-B.timestamp))}),T=me.subscribe(u=>{y=u}),j=be.subscribe(u=>{});ne.subscribe(u=>{}),lt(async()=>{const u="有什么可以帮您？";l.set([{id:Date.now().toString()+"init",role:"assistant",content:u,html:fe(u)}]),Nt(),await de(),k(),document.addEventListener("mouseup",$)}),mt(()=>{M(),J(),T(),j(),document.removeEventListener("mouseup",$)});async function L(){x(l).length>1&&!p&&!a&&(console.log("Auto-saving previous conversation..."),await I());const u="新对话已开始，有什么可以帮您？",B=fe(u);l.set([{id:Date.now().toString()+"init-new",role:"assistant",content:u,html:B}]),n(4,p=null),n(0,r=""),await de(),k()}async function I(){if(a||x(l).length<=1||p)return;const u=Date.now(),B=u.toString(),N=`对话 ${new Date(u).toLocaleString()}`,G=[{id:B,name:N,timestamp:u,messages:x(l).filter(H=>H.role==="user"||H.role==="assistant").map(({role:H,content:F})=>({role:H,content:F}))},...m];await s.saveConversations(G),n(4,p=B),console.log("Conversation saved with ID:",B)}function V(u){const B=m.find(N=>N.id===u);B&&(l.update(N=>B.messages.map((v,G)=>({...v,id:G,html:v.role==="assistant"?fe(v.content):void 0}))),n(4,p=B.id),x(l).length,n(0,r=""),de().then(k),console.log("Conversation loaded:",u))}async function _(u,B){if(B.stopPropagation(),confirm("确定要删除这个对话吗？")){const N=m.filter(v=>v.id!==u);await s.saveConversations(N),p===u&&L(),console.log("Conversation deleted:",u)}}async function R(){if(!r.trim()||a)return;w="",n(2,a=!0);const B={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:r.trim()};l.update(C=>[...C,B]),l.set([...x(l)]),console.log("User message added to store:",x(l)),r.trim(),n(0,r=""),await de(),k();let N="",v="";const H=x(ne).filter(C=>C.type==="selection");if(y){console.log("Fetching structured context for document ID:",y);try{N=await Bt(y),console.log("Fetched main document context length:",(N==null?void 0:N.length)??0)}catch(C){console.error("Error fetching structured document context:",C),w=`获取文档结构上下文失败: ${C.message}`}}else console.log("No currentDocId, skipping main document context fetch.");if(H.length>0){const C=Array.from(new Set(H.flatMap(ee=>ee.blockIds)));console.log("Found selection references, fetching referenced context for IDs:",C);try{v=await Mt(C),console.log("Fetched referenced context length:",(v==null?void 0:v.length)??0)}catch(ee){console.error("Error fetching referenced block context:",ee),w=`获取引用块上下文失败: ${ee.message}`}}let F="";N&&(F+=N),v&&(F&&(F+=`

`),F+=v);const S=x(l).filter(C=>C.role==="user"||C.role==="assistant").slice(-20).map(C=>({role:C.role,content:C.content}));let q="You are a helpful AI assistant integrated into Siyuan Note.";F&&(q+=`

${F}`);const Pe=[{role:"system",content:q},...S];console.log("Messages being sent to API (final format):",Pe);try{const C=await It(Pe,c),ye={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:C,html:fe(C)};l.update(ve=>[...ve,ye]),l.set([...x(l)]),console.log("Assistant message added to store:",x(l))}catch(C){console.error("Error fetching chat completion:",C),w=`AI 请求失败: ${C.message}`;const ye={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`抱歉，请求出错: ${w}`,html:fe(`抱歉，请求出错: ${w}`)};l.update(ve=>[...ve,ye]),l.set([...x(l)]),console.log("Error message added to store:",x(l))}finally{n(2,a=!1),H.length>0&&(console.log("Clearing selection references."),ne.update(C=>C.filter(ee=>ee.type!=="selection"))),await de(),k()}}function k(){i&&requestAnimationFrame(()=>{n(1,i.scrollTop=i.scrollHeight,i)})}function $(){setTimeout(()=>{d=Rt(),n(5,A=d.length>0)},100)}function K(){var G;if(!A||d.length===0)return;const u=`sel-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,N=`选区 ${x(ne).filter(H=>H.type==="selection").length+1}`,v={id:u,label:N,blockIds:[...d],type:"selection"};ne.update(H=>[...H,v]),d=[],n(5,A=!1),(G=window.getSelection())==null||G.removeAllRanges()}const Z=u=>V(u.currentTarget.value),X=u=>_(p,u);function D(u){De[u?"unshift":"push"](()=>{i=u,n(1,i)})}function P(){r=this.value,n(0,r)}const Y=u=>{u.key==="Enter"&&!u.shiftKey&&(u.preventDefault(),R())};return t.$$set=u=>{"pluginData"in u&&n(14,s=u.pluginData)},[r,i,a,m,p,A,o,l,L,I,V,_,R,K,s,Z,X,D,P,Y]}class qt extends Re{constructor(e){super(),Ne(this,e,Pt,Tt,_e,{pluginData:14},null,[-1,-1])}}function We(t){let e,n;return{c(){e=b("span"),n=oe(t[3]),h(e,"class","status-message svelte-136cw2s")},m(o,s){U(o,e,s),f(e,n)},p(o,s){s&8&&Be(n,o[3])},d(o){o&&O(e)}}}function Lt(t){let e,n,o,s,l,r,i,a,c,m,p,y,w,d,A,M,J,T,j,L,I,V,_,R,k,$,K,Z,X,D=t[3]&&We(t);return{c(){e=b("div"),n=b("h2"),n.textContent="AI 助手设置",o=E(),s=b("div"),l=b("label"),l.textContent="AI API Endpoint URL:",r=E(),i=b("input"),a=E(),c=b("p"),c.textContent="请输入您要使用的 AI 服务的完整 URL。",m=E(),p=b("div"),y=b("label"),y.textContent="API Key:",w=E(),d=b("input"),A=E(),M=b("p"),M.textContent="您的 API Key 将被保存在本地配置文件中。",J=E(),T=b("div"),j=b("label"),j.textContent="模型名称:",L=E(),I=b("input"),V=E(),_=b("p"),_.textContent="请输入要调用的具体模型名称。",R=E(),k=b("div"),$=b("button"),$.textContent="保存设置",K=E(),D&&D.c(),h(n,"class","svelte-136cw2s"),h(l,"for","api-url"),h(l,"class","svelte-136cw2s"),h(i,"id","api-url"),h(i,"type","text"),h(i,"placeholder","例如: https://api.openai.com/v1/chat/completions"),h(i,"class","b3-text-field svelte-136cw2s"),h(c,"class","description svelte-136cw2s"),h(s,"class","form-item svelte-136cw2s"),h(y,"for","api-key"),h(y,"class","svelte-136cw2s"),h(d,"id","api-key"),h(d,"type","password"),h(d,"placeholder","请输入您的 API Key"),h(d,"class","b3-text-field svelte-136cw2s"),h(M,"class","description svelte-136cw2s"),h(p,"class","form-item svelte-136cw2s"),h(j,"for","model-name"),h(j,"class","svelte-136cw2s"),h(I,"id","model-name"),h(I,"type","text"),h(I,"placeholder","例如: deepseek-chat, gpt-4o, ..."),h(I,"class","b3-text-field svelte-136cw2s"),h(_,"class","description svelte-136cw2s"),h(T,"class","form-item svelte-136cw2s"),h($,"class","b3-button b3-button--primary"),h(k,"class","actions svelte-136cw2s"),h(e,"class","settings-panel svelte-136cw2s")},m(P,Y){U(P,e,Y),f(e,n),f(e,o),f(e,s),f(s,l),f(s,r),f(s,i),W(i,t[0]),f(s,a),f(s,c),f(e,m),f(e,p),f(p,y),f(p,w),f(p,d),W(d,t[1]),f(p,A),f(p,M),f(e,J),f(e,T),f(T,j),f(T,L),f(T,I),W(I,t[2]),f(T,V),f(T,_),f(e,R),f(e,k),f(k,$),f(k,K),D&&D.m(k,null),Z||(X=[z(i,"input",t[8]),z(d,"input",t[9]),z(I,"input",t[10]),z($,"click",t[4])],Z=!0)},p(P,[Y]){Y&1&&i.value!==P[0]&&W(i,P[0]),Y&2&&d.value!==P[1]&&W(d,P[1]),Y&4&&I.value!==P[2]&&W(I,P[2]),P[3]?D?D.p(P,Y):(D=We(P),D.c(),D.m(k,null)):D&&(D.d(1),D=null)},i:Q,o:Q,d(P){P&&O(e),D&&D.d(),Z=!1,se(X)}}}function $t(t,e,n){let{loadSettings:o}=e,{saveSettings:s}=e,{currentSettings:l}=e,r="",i="",a="",c="";lt(async()=>{if(l)n(0,r=l.apiUrl||""),n(1,i=l.apiKey||""),n(2,a=l.modelName||"deepseek-chat");else{const d=await o();n(0,r=d.apiUrl||""),n(1,i=d.apiKey||""),n(2,a=d.modelName||"deepseek-chat")}});async function m(){try{await s({apiUrl:r,apiKey:i,modelName:a}),n(3,c="设置已保存！"),setTimeout(()=>n(3,c=""),3e3)}catch(d){n(3,c=`保存失败: ${d.message}`)}}function p(){r=this.value,n(0,r)}function y(){i=this.value,n(1,i)}function w(){a=this.value,n(2,a)}return t.$$set=d=>{"loadSettings"in d&&n(5,o=d.loadSettings),"saveSettings"in d&&n(6,s=d.saveSettings),"currentSettings"in d&&n(7,l=d.currentSettings)},[r,i,a,c,m,o,s,l,p,y,w]}class xt extends Re{constructor(e){super(),Ne(this,e,$t,Lt,_e,{loadSettings:5,saveSettings:6,currentSettings:7})}}const Xe="ai-assistant-config",Ze="ai-assistant-conversations",Ot={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},Ht="ai_assistant_dock";class Ut extends ke.Plugin{constructor(){super(...arguments);te(this,"isMobile");te(this,"settings");te(this,"settingsDialog",null);te(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const n=ke.getFrontend();this.isMobile=n==="mobile"||n==="browser-mobile",await this.loadSettings(),await this.loadConversations(),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this,saveConversations:this.saveConversations.bind(this)},type:Ht,init(o){new qt({target:o.element,props:{pluginData:o.data}}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:n}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",n),n&&n.protyle&&n.protyle.block&&n.protyle.block.rootID){const o=n.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${o}`),me.set(o),console.log(`Current document ID updated via switch-protyle: ${o}`),n.protyle.path){const s=n.protyle.path;console.log(`Doc Path found in protyle.path: ${s}`),be.set(s),console.log(`Current document Path updated via switch-protyle: ${s}`)}else console.warn("Doc Path not found in protyle detail."),be.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),me.set(null),be.set(null)}updateCurrentDocIdFromActiveTab(){var n;console.log("Attempting to get doc ID from active tab...");try{const o=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(o){console.log("Active protyle tab element found.");let s=o,l=s==null?void 0:s.protyle;for(;s&&!l;)l=s==null?void 0:s.protyle,s=s.parentElement;if((n=l==null?void 0:l.block)!=null&&n.rootID){const r=l.block.rootID;me.set(r),console.log(`Updated doc ID from active tab in onLayoutReady: ${r}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:l});const r=o.getAttribute("data-node-id");r&&console.log(`Found node-id on active tab: ${r}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(o){console.error("Error getting doc ID from active tab:",o)}}openSetting(){this.settingsDialog||(this.settingsDialog=new ke.Dialog({title:"AI 助手设置",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new xt({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const n=await this.loadData(Xe);return this.settings=Object.assign({},Ot,n),we.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(n){this.settings=n,await this.saveData(Xe,this.settings),we.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const n=await this.loadData(Ze)||[];Te.set(n),console.log(`${n.length} conversations loaded.`)}async saveConversations(n){await this.saveData(Ze,n),Te.set(n),console.log(`Conversations saved (${n.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=Ut;
