"use strict";var ce=Object.defineProperty;var ue=(e,t,n)=>t in e?ce(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var q=(e,t,n)=>ue(e,typeof t!="symbol"?t+"":t,n);const R=require("siyuan");function M(){}function ee(e){return e()}function Y(){return Object.create(null)}function I(e){e.forEach(ee)}function te(e){return typeof e=="function"}function re(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function ae(e){return Object.keys(e).length===0}function b(e,t){e.appendChild(t)}function ne(e,t,n){e.insertBefore(t,n||null)}function z(e){e.parentNode&&e.parentNode.removeChild(e)}function k(e){return document.createElement(e)}function L(e){return document.createTextNode(e)}function B(){return L(" ")}function D(e,t,n,s){return e.addEventListener(t,n,s),()=>e.removeEventListener(t,n,s)}function $(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function fe(e){return Array.from(e.childNodes)}function de(e,t){t=""+t,e.data!==t&&(e.data=t)}function G(e,t){e.value=t??""}let F;function S(e){F=e}function he(){if(!F)throw new Error("Function called outside component initialization");return F}function _e(e){he().$$.on_mount.push(e)}const A=[],H=[];let E=[];const J=[],se=Promise.resolve();let N=!1;function ie(){N||(N=!0,se.then(le))}function Q(){return ie(),se}function O(e){E.push(e)}const P=new Set;let j=0;function le(){if(j!==0)return;const e=F;do{try{for(;j<A.length;){const t=A[j];j++,S(t),pe(t.$$)}}catch(t){throw A.length=0,j=0,t}for(S(null),A.length=0,j=0;H.length;)H.pop()();for(let t=0;t<E.length;t+=1){const n=E[t];P.has(n)||(P.add(n),n())}E.length=0}while(A.length);for(;J.length;)J.pop()();N=!1,P.clear(),S(e)}function pe(e){if(e.fragment!==null){e.update(),I(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(O)}}function ge(e){const t=[],n=[];E.forEach(s=>e.indexOf(s)===-1?t.push(s):n.push(s)),n.forEach(s=>s()),E=t}const me=new Set;function oe(e,t){e&&e.i&&(me.delete(e),e.i(t))}function W(e){return(e==null?void 0:e.length)!==void 0?e:Array.from(e)}function we(e,t){e.d(1),t.delete(e.key)}function ye(e,t,n,s,l,u,r,a,f,i,m,_){let o=e.length,g=u.length,p=o;const x={};for(;p--;)x[e[p].key]=p;const c=[],h=new Map,w=new Map,V=[];for(p=g;p--;){const d=_(l,u,p),y=n(d);let v=r.get(y);v?V.push(()=>v.p(d,t)):(v=i(y,d),v.c()),h.set(y,c[p]=v),y in x&&w.set(y,Math.abs(p-x[y]))}const U=new Set,K=new Set;function T(d){oe(d,1),d.m(a,m),r.set(d.key,d),m=d.first,g--}for(;o&&g;){const d=c[g-1],y=e[o-1],v=d.key,C=y.key;d===y?(m=d.first,o--,g--):h.has(C)?!r.has(v)||U.has(v)?T(d):K.has(C)?o--:w.get(v)>w.get(C)?(K.add(v),T(d)):(U.add(C),o--):(f(y,r),o--)}for(;o--;){const d=e[o];h.has(d.key)||f(d,r)}for(;g;)T(c[g-1]);return I(V),c}function ve(e,t,n){const{fragment:s,after_update:l}=e.$$;s&&s.m(t,n),O(()=>{const u=e.$$.on_mount.map(ee).filter(te);e.$$.on_destroy?e.$$.on_destroy.push(...u):I(u),e.$$.on_mount=[]}),l.forEach(O)}function be(e,t){const n=e.$$;n.fragment!==null&&(ge(n.after_update),I(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function $e(e,t){e.$$.dirty[0]===-1&&(A.push(e),ie(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function ke(e,t,n,s,l,u,r=null,a=[-1]){const f=F;S(e);const i=e.$$={fragment:null,ctx:[],props:u,update:M,not_equal:l,bound:Y(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(f?f.$$.context:[])),callbacks:Y(),dirty:a,skip_bound:!1,root:t.target||f.$$.root};r&&r(i.root);let m=!1;if(i.ctx=n?n(e,t.props||{},(_,o,...g)=>{const p=g.length?g[0]:o;return i.ctx&&l(i.ctx[_],i.ctx[_]=p)&&(!i.skip_bound&&i.bound[_]&&i.bound[_](p),m&&$e(e,_)),o}):[],i.update(),m=!0,I(i.before_update),i.fragment=s?s(i.ctx):!1,t.target){if(t.hydrate){const _=fe(t.target);i.fragment&&i.fragment.l(_),_.forEach(z)}else i.fragment&&i.fragment.c();t.intro&&oe(e.$$.fragment),ve(e,t.target,t.anchor),le()}S(f)}class xe{constructor(){q(this,"$$");q(this,"$$set")}$destroy(){be(this,1),this.$destroy=M}$on(t,n){if(!te(n))return M;const s=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return s.push(n),()=>{const l=s.indexOf(n);l!==-1&&s.splice(l,1)}}$set(t){this.$$set&&!ae(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}}const je="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(je);function X(e,t,n){const s=e.slice();return s[9]=t[n],s}function Z(e,t){let n,s,l=t[9].text+"",u,r,a;return{key:e,first:null,c(){n=k("div"),s=k("p"),u=L(l),r=B(),$(s,"class","svelte-1jxjhq1"),$(n,"class",a="message "+t[9].sender+" svelte-1jxjhq1"),this.first=n},m(f,i){ne(f,n,i),b(n,s),b(s,u),b(n,r)},p(f,i){t=f,i&1&&l!==(l=t[9].text+"")&&de(u,l),i&1&&a!==(a="message "+t[9].sender+" svelte-1jxjhq1")&&$(n,"class",a)},d(f){f&&z(n)}}}function Ae(e){let t,n,s=[],l=new Map,u,r,a,f,i,m,_,o,g,p=W(e[0]);const x=c=>c[9].id;for(let c=0;c<p.length;c+=1){let h=X(e,p,c),w=x(h);l.set(w,s[c]=Z(w,h))}return{c(){t=k("main"),n=k("div");for(let c=0;c<s.length;c+=1)s[c].c();u=B(),r=k("div"),a=k("textarea"),f=B(),i=k("button"),m=L("发送"),$(n,"class","chat-history svelte-1jxjhq1"),$(a,"placeholder","在此输入您的问题或指令..."),$(a,"rows","3"),$(a,"class","svelte-1jxjhq1"),i.disabled=_=!e[1].trim(),$(i,"class","svelte-1jxjhq1"),$(r,"class","input-area svelte-1jxjhq1"),$(t,"class","ai-chat-panel svelte-1jxjhq1")},m(c,h){ne(c,t,h),b(t,n);for(let w=0;w<s.length;w+=1)s[w]&&s[w].m(n,null);e[4](n),b(t,u),b(t,r),b(r,a),G(a,e[1]),b(r,f),b(r,i),b(i,m),o||(g=[D(a,"input",e[5]),D(a,"keydown",e[6]),D(i,"click",e[3])],o=!0)},p(c,[h]){h&1&&(p=W(c[0]),s=ye(s,h,x,1,c,p,l,n,we,Z,null,X)),h&2&&G(a,c[1]),h&2&&_!==(_=!c[1].trim())&&(i.disabled=_)},i:M,o:M,d(c){c&&z(t);for(let h=0;h<s.length;h+=1)s[h].d();e[4](null),o=!1,I(g)}}}function Ee(e,t,n){let s=[{id:0,sender:"ai",text:"欢迎使用 AI 助手！"}],l="",u,r=1;async function a(){if(!l.trim())return;n(0,s=[...s,{id:r++,sender:"user",text:l}]);const o=l;n(1,l=""),await Q(),f(),await new Promise(g=>setTimeout(g,500)),n(0,s=[...s,{id:r++,sender:"ai",text:`已收到您的消息："${o}"`}]),await Q(),f()}function f(){u&&n(2,u.scrollTop=u.scrollHeight,u)}_e(()=>{f()});function i(o){H[o?"unshift":"push"](()=>{u=o,n(2,u)})}function m(){l=this.value,n(1,l)}return[s,l,u,a,i,m,o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),a())}]}class Ie extends xe{constructor(t){super(),ke(this,t,Ee,Ae,re,{})}}const Se="ai_assistant_dock";class Me extends R.Plugin{constructor(){super(...arguments);q(this,"isMobile")}async onload(){console.log("--- siyuan-plugin-canvas (Simplified) Loaded! ---");const n=R.getFrontend();this.isMobile=n==="mobile"||n==="browser-mobile",this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this},type:Se,init(s){new Ie({target:s.element}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}})}onunload(){console.log("Unloading siyuan-plugin-canvas...")}}module.exports=Me;
