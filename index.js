"use strict";var Vt=Object.defineProperty;var Gt=(t,e,n)=>e in t?Vt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var G=(t,e,n)=>Gt(t,typeof e!="symbol"?e+"":e,n);const dt=require("siyuan");function x(){}function Mt(t){return t()}function _t(){return Object.create(null)}function Q(t){t.forEach(Mt)}function Lt(t){return typeof t=="function"}function bt(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function Qt(t){return Object.keys(t).length===0}function Nt(t,...e){if(t==null){for(const s of e)s(void 0);return x}const n=t.subscribe(...e);return n.unsubscribe?()=>n.unsubscribe():n}function N(t){let e;return Nt(t,n=>e=n)(),e}function Yt(t,e,n){t.$$.on_destroy.push(Nt(e,n))}function h(t,e){t.appendChild(e)}function z(t,e,n){t.insertBefore(e,n||null)}function U(t){t.parentNode&&t.parentNode.removeChild(t)}function y(t){return document.createElement(t)}function st(t){return document.createTextNode(t)}function B(){return st(" ")}function vt(){return st("")}function j(t,e,n,s){return t.addEventListener(e,n,s),()=>t.removeEventListener(e,n,s)}function f(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function Jt(t){return Array.from(t.childNodes)}function xt(t,e){e=""+e,t.data!==e&&(t.data=e)}function K(t,e){t.value=e??""}let nt;function et(t){nt=t}function Rt(){if(!nt)throw new Error("Function called outside component initialization");return nt}function Ut(t){Rt().$$.on_mount.push(t)}function Wt(t){Rt().$$.on_destroy.push(t)}const W=[],ht=[];let X=[];const yt=[],Ht=Promise.resolve();let gt=!1;function Ot(){gt||(gt=!0,Ht.then(qt))}function Z(){return Ot(),Ht}function pt(t){X.push(t)}const ft=new Set;let Y=0;function qt(){if(Y!==0)return;const t=nt;do{try{for(;Y<W.length;){const e=W[Y];Y++,et(e),Xt(e.$$)}}catch(e){throw W.length=0,Y=0,e}for(et(null),W.length=0,Y=0;ht.length;)ht.pop()();for(let e=0;e<X.length;e+=1){const n=X[e];ft.has(n)||(ft.add(n),n())}X.length=0}while(W.length);for(;yt.length;)yt.pop()();gt=!1,ft.clear(),et(t)}function Xt(t){if(t.fragment!==null){t.update(),Q(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(pt)}}function Zt(t){const e=[],n=[];X.forEach(s=>t.indexOf(s)===-1?e.push(s):n.push(s)),n.forEach(s=>s()),X=e}const te=new Set;function Kt(t,e){t&&t.i&&(te.delete(t),t.i(e))}function it(t){return(t==null?void 0:t.length)!==void 0?t:Array.from(t)}function wt(t,e){t.d(1),e.delete(t.key)}function kt(t,e,n,s,o,i,l,r,g,c,F,v){let k=t.length,w=i.length,d=k;const H={};for(;d--;)H[t[d].key]=d;const L=[],O=new Map,E=new Map,A=[];for(d=w;d--;){const m=v(o,i,d),P=n(m);let I=l.get(P);I?A.push(()=>I.p(m,e)):(I=c(P,m),I.c()),O.set(P,L[d]=I),P in H&&E.set(P,Math.abs(d-H[P]))}const q=new Set,C=new Set;function R(m){Kt(m,1),m.m(r,F),l.set(m.key,m),F=m.first,w--}for(;k&&w;){const m=L[w-1],P=t[k-1],I=m.key,S=P.key;m===P?(F=m.first,k--,w--):O.has(S)?!l.has(I)||q.has(I)?R(m):C.has(S)?k--:E.get(I)>E.get(S)?(C.add(I),R(m)):(q.add(S),k--):(g(P,l),k--)}for(;k--;){const m=t[k];O.has(m.key)||g(m,l)}for(;w;)R(L[w-1]);return Q(A),L}function ee(t,e,n){const{fragment:s,after_update:o}=t.$$;s&&s.m(e,n),pt(()=>{const i=t.$$.on_mount.map(Mt).filter(Lt);t.$$.on_destroy?t.$$.on_destroy.push(...i):Q(i),t.$$.on_mount=[]}),o.forEach(pt)}function ne(t,e){const n=t.$$;n.fragment!==null&&(Zt(n.after_update),Q(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function se(t,e){t.$$.dirty[0]===-1&&(W.push(t),Ot(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function jt(t,e,n,s,o,i,l=null,r=[-1]){const g=nt;et(t);const c=t.$$={fragment:null,ctx:[],props:i,update:x,not_equal:o,bound:_t(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(g?g.$$.context:[])),callbacks:_t(),dirty:r,skip_bound:!1,root:e.target||g.$$.root};l&&l(c.root);let F=!1;if(c.ctx=n?n(t,e.props||{},(v,k,...w)=>{const d=w.length?w[0]:k;return c.ctx&&o(c.ctx[v],c.ctx[v]=d)&&(!c.skip_bound&&c.bound[v]&&c.bound[v](d),F&&se(t,v)),k}):[],c.update(),F=!0,Q(c.before_update),c.fragment=s?s(c.ctx):!1,e.target){if(e.hydrate){const v=Jt(e.target);c.fragment&&c.fragment.l(v),v.forEach(U)}else c.fragment&&c.fragment.c();e.intro&&Kt(t.$$.fragment),ee(t,e.target,e.anchor),qt()}et(g)}class zt{constructor(){G(this,"$$");G(this,"$$set")}$destroy(){ne(this,1),this.$destroy=x}$on(e,n){if(!Lt(n))return x;const s=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return s.push(n),()=>{const o=s.indexOf(n);o!==-1&&s.splice(o,1)}}$set(e){this.$$set&&!Qt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const oe="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(oe);const J=[];function ot(t,e=x){let n;const s=new Set;function o(r){if(bt(t,r)&&(t=r,n)){const g=!J.length;for(const c of s)c[1](),J.push(c,t);if(g){for(let c=0;c<J.length;c+=2)J[c][0](J[c+1]);J.length=0}}}function i(r){o(r(t))}function l(r,g=x){const c=[r,g];return s.add(c),s.size===1&&(n=e(o,i)||x),r(t),()=>{s.delete(c),s.size===0&&n&&(n(),n=null)}}return{set:o,update:i,subscribe:l}}const ie={apiKey:"",apiUrl:"",model:"gpt-3.5-turbo",temperature:.7,maxTokens:2e3},at=ot(ie),mt=ot([]),lt=ot(null),rt=ot(null);async function le(t){const e=N(at);if(!e.apiKey||!e.apiUrl)throw new Error("API Key 或 API URL 未配置");const n=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:t,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!n.ok){const o=await n.text();throw new Error(`API 请求失败: ${n.status} ${o}`)}const s=await n.json();if(!s.choices||s.choices.length===0)throw new Error("API 返回数据格式错误");return s.choices[0].message.content}function tt(t){return window.Lute.New().Md2HTML(t)}function Dt(t,e,n){const s=t.slice();return s[28]=e[n],s}function St(t,e,n){const s=t.slice();return s[31]=e[n],s}function Ct(t){let e,n,s;return{c(){e=y("button"),e.textContent="保存当前对话",f(e,"class","b3-button b3-button--outline svelte-t24sax")},m(o,i){z(o,e,i),n||(s=j(e,"click",t[8]),n=!0)},p:x,d(o){o&&U(e),n=!1,s()}}}function At(t,e){let n,s=e[31].name+"",o,i;return{key:t,first:null,c(){n=y("option"),o=st(s),n.__value=i=e[31].id,K(n,n.__value),this.first=n},m(l,r){z(l,n,r),h(n,o)},p(l,r){e=l,r[0]&8&&s!==(s=e[31].name+"")&&xt(o,s),r[0]&8&&i!==(i=e[31].id)&&(n.__value=i,K(n,n.__value))},d(l){l&&U(n)}}}function It(t){let e,n,s;return{c(){e=y("button"),e.textContent="删除当前",f(e,"class","b3-button b3-button--error svelte-t24sax"),f(e,"title","删除当前对话")},m(o,i){z(o,e,i),n||(s=j(e,"click",t[14]),n=!0)},p:x,d(o){o&&U(e),n=!1,s()}}}function re(t){let e,n=(t[28].html||t[28].content)+"";return{c(){e=y("div"),f(e,"class","message ai svelte-t24sax")},m(s,o){z(s,e,o),e.innerHTML=n},p(s,o){o[0]&32&&n!==(n=(s[28].html||s[28].content)+"")&&(e.innerHTML=n)},d(s){s&&U(e)}}}function ae(t){let e,n,s=t[28].content.replace(/\n/g,"<br/>")+"";return{c(){e=y("div"),n=y("div"),f(e,"class","message user svelte-t24sax")},m(o,i){z(o,e,i),h(e,n),n.innerHTML=s},p(o,i){i[0]&32&&s!==(s=o[28].content.replace(/\n/g,"<br/>")+"")&&(n.innerHTML=s)},d(o){o&&U(e)}}}function Et(t,e){let n,s;function o(r,g){if(r[28].role==="user")return ae;if(r[28].role==="assistant")return re}let i=o(e),l=i&&i(e);return{key:t,first:null,c(){n=vt(),l&&l.c(),s=vt(),this.first=n},m(r,g){z(r,n,g),l&&l.m(r,g),z(r,s,g)},p(r,g){e=r,i===(i=o(e))&&l?l.p(e,g):(l&&l.d(1),l=i&&i(e),l&&(l.c(),l.m(s.parentNode,s)))},d(r){r&&(U(n),U(s)),l&&l.d(r)}}}function Ft(t){let e;return{c(){e=y("div"),e.innerHTML='<p class="svelte-t24sax">AI 正在思考...</p>',f(e,"class","message ai loading svelte-t24sax")},m(n,s){z(n,e,s)},d(n){n&&U(e)}}}function ce(t){let e,n,s,o,i=N(t[6]).length>1&&!t[4]&&!t[2],l,r,g,c=[],F=new Map,v,k,w,d=[],H=new Map,L,O,E,A,q,C,R,m,P,I,S=i&&Ct(t),$=it(t[3]);const V=u=>u[31].id;for(let u=0;u<$.length;u+=1){let _=St(t,$,u),T=V(_);F.set(T,c[u]=At(T,_))}let a=t[4]&&It(t),p=it(t[5]);const b=u=>u[28].id;for(let u=0;u<p.length;u+=1){let _=Dt(t,p,u),T=b(_);H.set(T,d[u]=Et(T,_))}let D=t[2]&&Ft();return{c(){e=y("div"),n=y("div"),s=y("button"),s.textContent="新建对话",o=B(),S&&S.c(),l=B(),r=y("select"),g=y("option"),g.textContent="加载历史对话";for(let u=0;u<c.length;u+=1)c[u].c();v=B(),a&&a.c(),k=B(),w=y("div");for(let u=0;u<d.length;u+=1)d[u].c();L=B(),D&&D.c(),O=B(),E=y("div"),A=y("textarea"),q=B(),C=y("button"),R=st("发送"),f(s,"class","b3-button svelte-t24sax"),g.__value="",K(g,g.__value),g.disabled=!0,g.selected=!0,f(r,"class","b3-select svelte-t24sax"),f(r,"title","加载历史对话"),f(n,"class","conversation-controls svelte-t24sax"),f(w,"class","chat-history svelte-t24sax"),f(A,"placeholder","在此输入您的问题或指令..."),f(A,"rows","3"),A.disabled=t[2],f(A,"class","svelte-t24sax"),C.disabled=m=!t[0].trim()||t[2],f(C,"class","svelte-t24sax"),f(E,"class","input-area svelte-t24sax"),f(e,"class","ai-chat-panel svelte-t24sax")},m(u,_){z(u,e,_),h(e,n),h(n,s),h(n,o),S&&S.m(n,null),h(n,l),h(n,r),h(r,g);for(let T=0;T<c.length;T+=1)c[T]&&c[T].m(r,null);h(n,v),a&&a.m(n,null),h(e,k),h(e,w);for(let T=0;T<d.length;T+=1)d[T]&&d[T].m(w,null);h(w,L),D&&D.m(w,null),t[15](w),h(e,O),h(e,E),h(E,A),K(A,t[0]),h(E,q),h(E,C),h(C,R),P||(I=[j(s,"click",t[7]),j(r,"change",t[13]),j(A,"input",t[16]),j(A,"keydown",t[17]),j(C,"click",t[11])],P=!0)},p(u,_){_[0]&20&&(i=N(u[6]).length>1&&!u[4]&&!u[2]),i?S?S.p(u,_):(S=Ct(u),S.c(),S.m(n,l)):S&&(S.d(1),S=null),_[0]&8&&($=it(u[3]),c=kt(c,_,V,1,u,$,F,r,wt,At,null,St)),u[4]?a?a.p(u,_):(a=It(u),a.c(),a.m(n,null)):a&&(a.d(1),a=null),_[0]&32&&(p=it(u[5]),d=kt(d,_,b,1,u,p,H,w,wt,Et,L,Dt)),u[2]?D||(D=Ft(),D.c(),D.m(w,null)):D&&(D.d(1),D=null),_[0]&4&&(A.disabled=u[2]),_[0]&1&&K(A,u[0]),_[0]&5&&m!==(m=!u[0].trim()||u[2])&&(C.disabled=m)},i:x,o:x,d(u){u&&U(e),S&&S.d();for(let _=0;_<c.length;_+=1)c[_].d();a&&a.d();for(let _=0;_<d.length;_+=1)d[_].d();D&&D.d(),t[15](null),P=!1,Q(I)}}}async function ue(t){if(!t)return console.log("No docId provided for structured context fetch."),"";console.log(`Fetching structured context for document ID: ${t}`);try{const e=`SELECT id, type, markdown FROM blocks WHERE parent_id = '${t}' ORDER BY sort ASC`,n=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:e})});if(!n.ok){const i=await n.text();throw new Error(`SQL query failed with status ${n.status}: ${i}`)}const s=await n.json();if(s.code!==0)throw new Error(`API returned error code ${s.code}: ${s.msg}`);if(console.log("Raw SQL query result data:",s.data),!s.data||!Array.isArray(s.data))return console.log("No block data returned from SQL query or data is not an array."),"Document is empty or contains no text blocks.";let o=`Current document context (Blocks ordered by position):
`;return s.data.forEach((i,l)=>{o+=`--- Block ${l+1} (ID: ${i.id}, Type: ${i.type}) ---
${i.markdown||"[Block content not directly in markdown field]"}

`}),o+="--- End of Blocks ---",console.log("Formatted structured context length:",o.length),o}catch(e){return console.error("Error fetching or processing structured document context:",e),`Error retrieving document structure: ${e.message}`}}function de(){console.log("Loading messages (ensure format is correct)...")}function fe(t,e,n){let s,{pluginData:o}=e,i=ot([]);Yt(t,i,a=>n(5,s=a));let l="",r,g=!1,c,F=[],v=null,k=null,w="";const d=at.subscribe(a=>{c=a}),H=mt.subscribe(a=>{n(3,F=a.sort((p,b)=>b.timestamp-p.timestamp))}),L=lt.subscribe(a=>{k=a}),O=rt.subscribe(a=>{});Ut(async()=>{const a="有什么可以帮您？";i.set([{id:Date.now().toString()+"init",role:"assistant",content:a,html:tt(a)}]),de(),await Z(),m()}),Wt(()=>{d(),H(),L(),O()});async function E(){N(i).length>1&&!v&&!g&&(console.log("Auto-saving previous conversation..."),await A());const a="新对话已开始，有什么可以帮您？",p=tt(a);i.update(b=>[...b,{role:"assistant",content:a,html:p}]),n(4,v=null),n(0,l=""),await Z(),m()}async function A(){if(g||N(i).length<=1||v)return;const a=Date.now(),p=a.toString(),b=`对话 ${new Date(a).toLocaleString()}`,u=[{id:p,name:b,timestamp:a,messages:N(i).filter(_=>_.role==="user"||_.role==="assistant").map(({role:_,content:T})=>({role:_,content:T}))},...F];await o.saveConversations(u),n(4,v=p),console.log("Conversation saved with ID:",p)}function q(a){const p=F.find(b=>b.id===a);p&&(i.update(b=>p.messages.map((D,u)=>({...D,id:u,html:D.role==="assistant"?tt(D.content):void 0}))),n(4,v=p.id),N(i).length,n(0,l=""),Z().then(m),console.log("Conversation loaded:",a))}async function C(a,p){if(p.stopPropagation(),confirm("确定要删除这个对话吗？")){const b=F.filter(D=>D.id!==a);await o.saveConversations(b),v===a&&E(),console.log("Conversation deleted:",a)}}async function R(){if(!l.trim()||g)return;w="",n(2,g=!0);const p={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:l.trim()};i.update(M=>[...M,p]),i.set([...N(i)]),console.log("User message added to store:",N(i)),l.trim(),n(0,l=""),await Z(),m();let b="";if(k)try{console.log(`Attempting to fetch structured context for document ID: ${k}`),b=await ue(k),console.log("Fetched structured context length:",(b==null?void 0:b.length)??0)}catch(M){console.error("Error fetching structured document context:",M),w=`获取文档结构上下文失败: ${M.message}`}else console.log("No currentDocId, skipping structured context fetch.");const u=N(i).filter(M=>M.role==="user"||M.role==="assistant").slice(-20).map(M=>({role:M.role,content:M.content}));let _="You are a helpful AI assistant integrated into Siyuan Note.";b&&(_+=`

Current document context (structure and content):
---
${b}
---`);const T=[{role:"system",content:_},...u];console.log("Messages being sent to API (final format):",T);try{const M=await le(T,c),ct={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:M,html:tt(M)};i.update(ut=>[...ut,ct]),i.set([...N(i)]),console.log("Assistant message added to store:",N(i))}catch(M){console.error("Error fetching chat completion:",M),w=`AI 请求失败: ${M.message}`;const ct={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`抱歉，请求出错: ${w}`,html:tt(`抱歉，请求出错: ${w}`)};i.update(ut=>[...ut,ct]),i.set([...N(i)]),console.log("Error message added to store:",N(i))}finally{n(2,g=!1),await Z(),m()}}function m(){r&&requestAnimationFrame(()=>{n(1,r.scrollTop=r.scrollHeight,r)})}const P=a=>q(a.currentTarget.value),I=a=>C(v,a);function S(a){ht[a?"unshift":"push"](()=>{r=a,n(1,r)})}function $(){l=this.value,n(0,l)}const V=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),R())};return t.$$set=a=>{"pluginData"in a&&n(12,o=a.pluginData)},[l,r,g,F,v,s,i,E,A,q,C,R,o,P,I,S,$,V]}class he extends zt{constructor(e){super(),jt(this,e,fe,ce,bt,{pluginData:12},null,[-1,-1])}}function Tt(t){let e,n;return{c(){e=y("span"),n=st(t[3]),f(e,"class","status-message svelte-136cw2s")},m(s,o){z(s,e,o),h(e,n)},p(s,o){o&8&&xt(n,s[3])},d(s){s&&U(e)}}}function ge(t){let e,n,s,o,i,l,r,g,c,F,v,k,w,d,H,L,O,E,A,q,C,R,m,P,I,S,$,V,a,p=t[3]&&Tt(t);return{c(){e=y("div"),n=y("h2"),n.textContent="AI 助手设置",s=B(),o=y("div"),i=y("label"),i.textContent="AI API Endpoint URL:",l=B(),r=y("input"),g=B(),c=y("p"),c.textContent="请输入您要使用的 AI 服务的完整 URL。",F=B(),v=y("div"),k=y("label"),k.textContent="API Key:",w=B(),d=y("input"),H=B(),L=y("p"),L.textContent="您的 API Key 将被保存在本地配置文件中。",O=B(),E=y("div"),A=y("label"),A.textContent="模型名称:",q=B(),C=y("input"),R=B(),m=y("p"),m.textContent="请输入要调用的具体模型名称。",P=B(),I=y("div"),S=y("button"),S.textContent="保存设置",$=B(),p&&p.c(),f(n,"class","svelte-136cw2s"),f(i,"for","api-url"),f(i,"class","svelte-136cw2s"),f(r,"id","api-url"),f(r,"type","text"),f(r,"placeholder","例如: https://api.openai.com/v1/chat/completions"),f(r,"class","b3-text-field svelte-136cw2s"),f(c,"class","description svelte-136cw2s"),f(o,"class","form-item svelte-136cw2s"),f(k,"for","api-key"),f(k,"class","svelte-136cw2s"),f(d,"id","api-key"),f(d,"type","password"),f(d,"placeholder","请输入您的 API Key"),f(d,"class","b3-text-field svelte-136cw2s"),f(L,"class","description svelte-136cw2s"),f(v,"class","form-item svelte-136cw2s"),f(A,"for","model-name"),f(A,"class","svelte-136cw2s"),f(C,"id","model-name"),f(C,"type","text"),f(C,"placeholder","例如: deepseek-chat, gpt-4o, ..."),f(C,"class","b3-text-field svelte-136cw2s"),f(m,"class","description svelte-136cw2s"),f(E,"class","form-item svelte-136cw2s"),f(S,"class","b3-button b3-button--primary"),f(I,"class","actions svelte-136cw2s"),f(e,"class","settings-panel svelte-136cw2s")},m(b,D){z(b,e,D),h(e,n),h(e,s),h(e,o),h(o,i),h(o,l),h(o,r),K(r,t[0]),h(o,g),h(o,c),h(e,F),h(e,v),h(v,k),h(v,w),h(v,d),K(d,t[1]),h(v,H),h(v,L),h(e,O),h(e,E),h(E,A),h(E,q),h(E,C),K(C,t[2]),h(E,R),h(E,m),h(e,P),h(e,I),h(I,S),h(I,$),p&&p.m(I,null),V||(a=[j(r,"input",t[8]),j(d,"input",t[9]),j(C,"input",t[10]),j(S,"click",t[4])],V=!0)},p(b,[D]){D&1&&r.value!==b[0]&&K(r,b[0]),D&2&&d.value!==b[1]&&K(d,b[1]),D&4&&C.value!==b[2]&&K(C,b[2]),b[3]?p?p.p(b,D):(p=Tt(b),p.c(),p.m(I,null)):p&&(p.d(1),p=null)},i:x,o:x,d(b){b&&U(e),p&&p.d(),V=!1,Q(a)}}}function pe(t,e,n){let{loadSettings:s}=e,{saveSettings:o}=e,{currentSettings:i}=e,l="",r="",g="",c="";Ut(async()=>{if(i)n(0,l=i.apiUrl||""),n(1,r=i.apiKey||""),n(2,g=i.modelName||"deepseek-chat");else{const d=await s();n(0,l=d.apiUrl||""),n(1,r=d.apiKey||""),n(2,g=d.modelName||"deepseek-chat")}});async function F(){try{await o({apiUrl:l,apiKey:r,modelName:g}),n(3,c="设置已保存！"),setTimeout(()=>n(3,c=""),3e3)}catch(d){n(3,c=`保存失败: ${d.message}`)}}function v(){l=this.value,n(0,l)}function k(){r=this.value,n(1,r)}function w(){g=this.value,n(2,g)}return t.$$set=d=>{"loadSettings"in d&&n(5,s=d.loadSettings),"saveSettings"in d&&n(6,o=d.saveSettings),"currentSettings"in d&&n(7,i=d.currentSettings)},[l,r,g,c,F,s,o,i,v,k,w]}class me extends zt{constructor(e){super(),jt(this,e,pe,ge,bt,{loadSettings:5,saveSettings:6,currentSettings:7})}}const Pt="ai-assistant-config",Bt="ai-assistant-conversations",be={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},_e="ai_assistant_dock";class ve extends dt.Plugin{constructor(){super(...arguments);G(this,"isMobile");G(this,"settings");G(this,"settingsDialog",null);G(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const n=dt.getFrontend();this.isMobile=n==="mobile"||n==="browser-mobile",await this.loadSettings(),await this.loadConversations(),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this,saveConversations:this.saveConversations.bind(this)},type:_e,init(s){new he({target:s.element,props:{pluginData:s.data}}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:n}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",n),n&&n.protyle&&n.protyle.block&&n.protyle.block.rootID){const s=n.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${s}`),lt.set(s),console.log(`Current document ID updated via switch-protyle: ${s}`),n.protyle.path){const o=n.protyle.path;console.log(`Doc Path found in protyle.path: ${o}`),rt.set(o),console.log(`Current document Path updated via switch-protyle: ${o}`)}else console.warn("Doc Path not found in protyle detail."),rt.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),lt.set(null),rt.set(null)}updateCurrentDocIdFromActiveTab(){var n;console.log("Attempting to get doc ID from active tab...");try{const s=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(s){console.log("Active protyle tab element found.");let o=s,i=o==null?void 0:o.protyle;for(;o&&!i;)i=o==null?void 0:o.protyle,o=o.parentElement;if((n=i==null?void 0:i.block)!=null&&n.rootID){const l=i.block.rootID;lt.set(l),console.log(`Updated doc ID from active tab in onLayoutReady: ${l}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:i});const l=s.getAttribute("data-node-id");l&&console.log(`Found node-id on active tab: ${l}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(s){console.error("Error getting doc ID from active tab:",s)}}openSetting(){this.settingsDialog||(this.settingsDialog=new dt.Dialog({title:"AI 助手设置",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new me({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const n=await this.loadData(Pt);return this.settings=Object.assign({},be,n),at.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(n){this.settings=n,await this.saveData(Pt,this.settings),at.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const n=await this.loadData(Bt)||[];mt.set(n),console.log(`${n.length} conversations loaded.`)}async saveConversations(n){await this.saveData(Bt,n),mt.set(n),console.log(`Conversations saved (${n.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=ve;
