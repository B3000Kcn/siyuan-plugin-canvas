"use strict";var Lt=Object.defineProperty;var Pt=(n,e,t)=>e in n?Lt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var de=(n,e,t)=>Pt(n,typeof e!="symbol"?e+"":e,t);const ze=require("siyuan");function Q(){}function St(n){return n()}function lt(){return Object.create(null)}function re(n){n.forEach(St)}function Et(n){return typeof n=="function"}function Ae(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function qt(n){return Object.keys(n).length===0}function At(n,...e){if(n==null){for(const o of e)o(void 0);return Q}const t=n.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function N(n){let e;return At(n,t=>e=t)(),e}function Ft(n,e,t){n.$$.on_destroy.push(At(e,t))}const Ut=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function h(n,e){n.appendChild(e)}function B(n,e,t){n.insertBefore(e,t||null)}function T(n){n.parentNode&&n.parentNode.removeChild(n)}function y(n){return document.createElement(n)}function oe(n){return document.createTextNode(n)}function I(){return oe(" ")}function xe(){return oe("")}function P(n,e,t,o){return n.addEventListener(e,t,o),()=>n.removeEventListener(e,t,o)}function g(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function zt(n){return Array.from(n.childNodes)}function Me(n,e){e=""+e,n.data!==e&&(n.data=e)}function le(n,e){n.value=e??""}function rt(n,e,t){n.classList.toggle(e,!!t)}function jt(n,e,{bubbles:t=!1,cancelable:o=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:o})}let Ee;function Se(n){Ee=n}function We(){if(!Ee)throw new Error("Function called outside component initialization");return Ee}function Ge(n){We().$$.on_mount.push(n)}function Ht(n){We().$$.on_destroy.push(n)}function Tt(){const n=We();return(e,t,{cancelable:o=!1}={})=>{const s=n.$$.callbacks[e];if(s){const l=jt(e,t,{cancelable:o});return s.slice().forEach(i=>{i.call(n,l)}),!l.defaultPrevented}return!0}}const ke=[],He=[];let _e=[];const it=[],Bt=Promise.resolve();let Ke=!1;function $t(){Ke||(Ke=!0,Bt.then(Rt))}function be(){return $t(),Bt}function Je(n){_e.push(n)}const je=new Set;let we=0;function Rt(){if(we!==0)return;const n=Ee;do{try{for(;we<ke.length;){const e=ke[we];we++,Se(e),Kt(e.$$)}}catch(e){throw ke.length=0,we=0,e}for(Se(null),ke.length=0,we=0;He.length;)He.pop()();for(let e=0;e<_e.length;e+=1){const t=_e[e];je.has(t)||(je.add(t),t())}_e.length=0}while(ke.length);for(;it.length;)it.pop()();Ke=!1,je.clear(),Se(n)}function Kt(n){if(n.fragment!==null){n.update(),re(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(Je)}}function Jt(n){const e=[],t=[];_e.forEach(o=>n.indexOf(o)===-1?e.push(o):t.push(o)),t.forEach(o=>o()),_e=e}const Be=new Set;let fe;function Yt(){fe={r:0,c:[],p:fe}}function Wt(){fe.r||re(fe.c),fe=fe.p}function ge(n,e){n&&n.i&&(Be.delete(n),n.i(e))}function Ne(n,e,t,o){if(n&&n.o){if(Be.has(n))return;Be.add(n),fe.c.push(()=>{Be.delete(n),o&&(t&&n.d(1),o())}),n.o(e)}else o&&o()}function ve(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function Qe(n,e){n.d(1),e.delete(n.key)}function Ve(n,e,t,o,s,l,i,r,a,u,f,d){let p=n.length,w=l.length,m=p;const k={};for(;m--;)k[n[m].key]=m;const _=[],S=new Map,E=new Map,M=[];for(m=w;m--;){const D=d(s,l,m),q=t(D);let F=i.get(q);F?M.push(()=>F.p(D,e)):(F=u(q,D),F.c()),S.set(q,_[m]=F),q in k&&E.set(q,Math.abs(m-k[q]))}const H=new Set,U=new Set;function z(D){ge(D,1),D.m(r,f),i.set(D.key,D),f=D.first,w--}for(;p&&w;){const D=_[w-1],q=n[p-1],F=D.key,J=q.key;D===q?(f=D.first,p--,w--):S.has(J)?!i.has(F)||H.has(F)?z(D):U.has(J)?p--:E.get(F)>E.get(J)?(U.add(F),z(D)):(H.add(J),p--):(a(q,i),p--)}for(;p--;){const D=n[p];S.has(D.key)||a(D,i)}for(;w;)z(_[w-1]);return re(M),_}function xt(n){n&&n.c()}function Xe(n,e,t){const{fragment:o,after_update:s}=n.$$;o&&o.m(e,t),Je(()=>{const l=n.$$.on_mount.map(St).filter(Et);n.$$.on_destroy?n.$$.on_destroy.push(...l):re(l),n.$$.on_mount=[]}),s.forEach(Je)}function Ze(n,e){const t=n.$$;t.fragment!==null&&(Jt(t.after_update),re(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Gt(n,e){n.$$.dirty[0]===-1&&(ke.push(n),$t(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function Le(n,e,t,o,s,l,i=null,r=[-1]){const a=Ee;Se(n);const u=n.$$={fragment:null,ctx:[],props:l,update:Q,not_equal:s,bound:lt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:lt(),dirty:r,skip_bound:!1,root:e.target||a.$$.root};i&&i(u.root);let f=!1;if(u.ctx=t?t(n,e.props||{},(d,p,...w)=>{const m=w.length?w[0]:p;return u.ctx&&s(u.ctx[d],u.ctx[d]=m)&&(!u.skip_bound&&u.bound[d]&&u.bound[d](m),f&&Gt(n,d)),p}):[],u.update(),f=!0,re(u.before_update),u.fragment=o?o(u.ctx):!1,e.target){if(e.hydrate){const d=zt(e.target);u.fragment&&u.fragment.l(d),d.forEach(T)}else u.fragment&&u.fragment.c();e.intro&&ge(n.$$.fragment),Xe(n,e.target,e.anchor),Rt()}Se(a)}class Pe{constructor(){de(this,"$$");de(this,"$$set")}$destroy(){Ze(this,1),this.$destroy=Q}$on(e,t){if(!Et(t))return Q;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(t),()=>{const s=o.indexOf(t);s!==-1&&o.splice(s,1)}}$set(e){this.$$set&&!qt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const Qt="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Qt);const ye=[];function De(n,e=Q){let t;const o=new Set;function s(r){if(Ae(n,r)&&(n=r,t)){const a=!ye.length;for(const u of o)u[1](),ye.push(u,n);if(a){for(let u=0;u<ye.length;u+=2)ye[u][0](ye[u+1]);ye.length=0}}}function l(r){s(r(n))}function i(r,a=Q){const u=[r,a];return o.add(u),o.size===1&&(t=e(s,l)||Q),r(n),()=>{o.delete(u),o.size===0&&t&&(t(),t=null)}}return{set:s,update:l,subscribe:i}}const Oe=De({apiKey:"",modelName:"deepseek-chat"}),Ye=De([]),$e=De(null),Re=De(null),ne=De([]);async function Vt(n){const e=N(Oe);if(!e.apiKey||!e.apiUrl)throw new Error("API Key Êàñ API URL Êú™ÈÖçÁΩÆ");const t=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:n,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!t.ok){const s=await t.text();throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${t.status} ${s}`)}const o=await t.json();if(!o.choices||o.choices.length===0)throw new Error("API ËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØ");return o.choices[0].message.content}function se(n){return window.Lute.New().Md2HTML(n)}function Xt(n){let e;return{c(){e=oe("Ê∑ªÂä†")},m(t,o){B(t,e,o)},d(t){t&&T(e)}}}function Zt(n){let e;return{c(){e=oe("Ê≠£Âú®Ëé∑Âèñ...")},m(t,o){B(t,e,o)},d(t){t&&T(e)}}}function ct(n){let e,t=se(n[2])+"";return{c(){e=y("div"),g(e,"class","error-message svelte-f3rpt"),g(e,"role","alert")},m(o,s){B(o,e,s),e.innerHTML=t},p(o,s){s&4&&t!==(t=se(o[2])+"")&&(e.innerHTML=t)},d(o){o&&T(e)}}}function en(n){let e,t,o,s,l,i,r,a,u,f,d;function p(_,S){return _[1]?Zt:Xt}let w=p(n),m=w(n),k=n[2]&&ct(n);return{c(){e=y("div"),t=y("input"),o=I(),s=y("button"),m.c(),i=I(),r=y("button"),a=oe("ÂèñÊ∂à"),u=I(),k&&k.c(),g(t,"type","text"),g(t,"id","doc-id-input-field"),g(t,"placeholder","ËæìÂÖ•Ë¶ÅÂºïÁî®ÁöÑÊñáÊ°£ ID..."),t.disabled=n[1],g(t,"class","svelte-f3rpt"),s.disabled=l=!n[0].trim()||n[1],g(s,"class","svelte-f3rpt"),r.disabled=n[1],g(r,"class","cancel-button svelte-f3rpt"),g(e,"class","add-document-input-container svelte-f3rpt")},m(_,S){B(_,e,S),h(e,t),le(t,n[0]),h(e,o),h(e,s),m.m(s,null),h(e,i),h(e,r),h(r,a),h(e,u),k&&k.m(e,null),f||(d=[P(t,"input",n[5]),P(t,"keydown",n[6]),P(s,"click",n[3]),P(r,"click",n[4])],f=!0)},p(_,[S]){S&2&&(t.disabled=_[1]),S&1&&t.value!==_[0]&&le(t,_[0]),w!==(w=p(_))&&(m.d(1),m=w(_),m&&(m.c(),m.m(s,null))),S&3&&l!==(l=!_[0].trim()||_[1])&&(s.disabled=l),S&2&&(r.disabled=_[1]),_[2]?k?k.p(_,S):(k=ct(_),k.c(),k.m(e,null)):k&&(k.d(1),k=null)},i:Q,o:Q,d(_){_&&T(e),m.d(),k&&k.d(),f=!1,re(d)}}}function tn(n,e,t){const o=Tt();let s="",l=!1,i="";async function r(p){var w,m,k,_;console.log(`[AddDocumentInput] Fetching title for docId: ${p}`),t(2,i=""),t(1,l=!0);try{const S=await fetch("/api/block/getBlockInfo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:p})});if(!S.ok){const H=await S.text();throw new Error(`API getBlockInfo failed (${S.status}): ${H}`)}const E=await S.json();if(E.code!==0)throw new Error(`API getBlockInfo returned error code ${E.code}: ${E.msg}`);let M=null;if((w=E.data)!=null&&w.rootTitle?M=E.data.rootTitle:(m=E.data)!=null&&m.title?M=E.data.title:(k=E.data)!=null&&k.content?M=E.data.content:(_=E.data)!=null&&_.name&&(M=E.data.name),M)return console.log(`[AddDocumentInput] Fetched title: '${M}' for ID: ${p}`),M;throw console.warn(`[AddDocumentInput] Title field (rootTitle, title, content or name) not found in getBlockInfo response for ID: ${p}. Data:`,E.data),new Error("Êú™ËÉΩ‰ªé API ÂìçÂ∫î‰∏≠ÊâæÂà∞ÊñáÊ°£Ê†áÈ¢ò„ÄÇ")}catch(S){return console.error(`[AddDocumentInput] Error fetching title for ${p}:`,S),t(2,i=`Ëé∑ÂèñÊñáÊ°£Ê†áÈ¢òÂ§±Ë¥• (ID: ${p}): ${S.message}`),null}finally{t(1,l=!1)}}async function a(){const p=s.trim();if(!p||l)return;const w=await r(p);w!==null?(o("addDocumentReference",{docId:p,title:w}),t(0,s="")):console.error("[AddDocumentInput] Title fetch failed, not dispatching event.")}function u(){o("cancel"),t(0,s=""),t(2,i="")}Ge(()=>{const p=document.getElementById("doc-id-input-field");p==null||p.focus()});function f(){s=this.value,t(0,s)}return[s,l,i,a,u,f,p=>{p.key==="Enter"&&a(),p.key==="Escape"&&u()}]}class nn extends Pe{constructor(e){super(),Le(this,e,tn,en,Ae,{})}}function at(n,e,t){const o=n.slice();return o[8]=e[t],o}function ut(n){let e,t,o,s,l,i=[],r=new Map,a=ve(n[1]);const u=f=>f[8].id;for(let f=0;f<a.length;f+=1){let d=at(n,a,f),p=u(d);r.set(p,i[f]=dt(p,d))}return{c(){e=y("span"),e.textContent="|",t=I(),o=y("span"),o.textContent="ÂºïÁî®ÂÜÖÂÆπ:",s=I(),l=y("div");for(let f=0;f<i.length;f+=1)i[f].c();g(e,"class","separator svelte-iusdx0"),g(o,"class","svelte-iusdx0"),g(l,"class","reference-tags svelte-iusdx0")},m(f,d){B(f,e,d),B(f,t,d),B(f,o,d),B(f,s,d),B(f,l,d);for(let p=0;p<i.length;p+=1)i[p]&&i[p].m(l,null)},p(f,d){d&6&&(a=ve(f[1]),i=Ve(i,d,u,1,f,a,r,l,Qe,dt,null,at))},d(f){f&&(T(e),T(t),T(o),T(s),T(l));for(let d=0;d<i.length;d+=1)i[d].d()}}}function dt(n,e){let t,o,s=e[8].label+"",l,i,r,a,u,f,d;function p(){return e[6](e[8])}return{key:n,first:null,c(){t=y("span"),o=y("span"),l=oe(s),i=I(),r=y("button"),r.textContent="√ó",a=I(),g(o,"class","tag-label svelte-iusdx0"),g(r,"class","remove-tag-button svelte-iusdx0"),g(r,"title","ÁßªÈô§ÂºïÁî®"),g(t,"class","reference-tag svelte-iusdx0"),g(t,"title",u=e[8].label),rt(t,"document-reference",e[8].type==="document"),this.first=t},m(w,m){B(w,t,m),h(t,o),h(o,l),h(t,i),h(t,r),h(t,a),f||(d=P(r,"click",p),f=!0)},p(w,m){e=w,m&2&&s!==(s=e[8].label+"")&&Me(l,s),m&2&&u!==(u=e[8].label)&&g(t,"title",u),m&2&&rt(t,"document-reference",e[8].type==="document")},d(w){w&&T(t),f=!1,d()}}}function ft(n){let e,t,o;return t=new nn({}),t.$on("addDocumentReference",n[4]),t.$on("cancel",n[5]),{c(){e=I(),xt(t.$$.fragment)},m(s,l){B(s,e,l),Xe(t,s,l),o=!0},p:Q,i(s){o||(ge(t.$$.fragment,s),o=!0)},o(s){Ne(t.$$.fragment,s),o=!1},d(s){s&&T(e),Ze(t,s)}}}function on(n){let e,t,o,s,l,i,r,a,u=n[1].length>0&&ut(n),f=n[0]&&ft(n);return{c(){e=y("div"),t=y("button"),t.textContent="@",o=I(),u&&u.c(),s=I(),f&&f.c(),l=xe(),g(t,"class","add-doc-ref-button svelte-iusdx0"),g(t,"title","ÈÄöËøáÊñáÊ°£ ID Ê∑ªÂä†ÂºïÁî®"),g(e,"class","reference-context-bar svelte-iusdx0")},m(d,p){B(d,e,p),h(e,t),h(e,o),u&&u.m(e,null),B(d,s,p),f&&f.m(d,p),B(d,l,p),i=!0,r||(a=P(t,"click",n[3]),r=!0)},p(d,[p]){d[1].length>0?u?u.p(d,p):(u=ut(d),u.c(),u.m(e,null)):u&&(u.d(1),u=null),d[0]?f?(f.p(d,p),p&1&&ge(f,1)):(f=ft(d),f.c(),ge(f,1),f.m(l.parentNode,l)):f&&(Yt(),Ne(f,1,1,()=>{f=null}),Wt())},i(d){i||(ge(f),i=!0)},o(d){Ne(f),i=!1},d(d){d&&(T(e),T(s),T(l)),u&&u.d(),f&&f.d(d),r=!1,a()}}}function sn(n,e,t){let o;Ft(n,ne,d=>t(1,o=d));const s=Tt();let l=!1;function i(d){ne.update(p=>p.filter(w=>w.id!==d))}function r(){console.log("[ReferenceContext] toggleAddDocInput called. Current showAddDocInput:",l),t(0,l=!l),console.log("[ReferenceContext] New showAddDocInput:",l)}function a(d){t(0,l=!1),s("addDocumentReference",d.detail)}function u(){t(0,l=!1)}return[l,o,i,r,a,u,d=>i(d.id)]}class ln extends Pe{constructor(e){super(),Le(this,e,sn,on,Ae,{})}}const{Map:Nt}=Ut;function gt(n,e,t){const o=n.slice();return o[41]=e[t],o}function pt(n,e,t){const o=n.slice();return o[44]=e[t],o}function ht(n){let e,t,o;return{c(){e=y("button"),e.textContent="‰øùÂ≠òÂΩìÂâçÂØπËØù",g(e,"class","b3-button b3-button--outline svelte-nuvzqg")},m(s,l){B(s,e,l),t||(o=P(e,"click",n[10]),t=!0)},p:Q,d(s){s&&T(e),t=!1,o()}}}function mt(n){let e;function t(l,i){return l[3].length>0?cn:rn}let o=t(n),s=o(n);return{c(){e=y("div"),s.c(),g(e,"class","history-list svelte-nuvzqg")},m(l,i){B(l,e,i),s.m(e,null)},p(l,i){o===(o=t(l))&&s?s.p(l,i):(s.d(1),s=o(l),s&&(s.c(),s.m(e,null)))},d(l){l&&T(e),s.d()}}}function rn(n){let e;return{c(){e=y("div"),e.textContent="Ê≤°ÊúâÂ∑≤‰øùÂ≠òÁöÑÂØπËØù",g(e,"class","history-item-empty svelte-nuvzqg")},m(t,o){B(t,e,o)},p:Q,d(t){t&&T(e)}}}function cn(n){let e=[],t=new Nt,o,s=ve(n[3]);const l=r=>r[44].id;for(let r=0;r<s.length;r+=1){let a=pt(n,s,r),u=l(a);t.set(u,e[r]=wt(u,a))}let i=null;return s.length||(i=bt()),{c(){for(let r=0;r<e.length;r+=1)e[r].c();o=xe(),i&&i.c()},m(r,a){for(let u=0;u<e.length;u+=1)e[u]&&e[u].m(r,a);B(r,o,a),i&&i.m(r,a)},p(r,a){a[0]&6216&&(s=ve(r[3]),e=Ve(e,a,l,1,r,s,t,o.parentNode,Qe,wt,o,pt),!s.length&&i?i.p(r,a):s.length?i&&(i.d(1),i=null):(i=bt(),i.c(),i.m(o.parentNode,o)))},d(r){r&&T(o);for(let a=0;a<e.length;a+=1)e[a].d(r);i&&i.d(r)}}}function bt(n){let e;return{c(){e=y("div"),e.textContent="Ê≤°ÊúâÂ∑≤‰øùÂ≠òÁöÑÂØπËØù",g(e,"class","history-item-empty svelte-nuvzqg")},m(t,o){B(t,e,o)},p:Q,d(t){t&&T(e)}}}function wt(n,e){let t,o,s=e[44].name+"",l,i,r,a,u,f;function d(){return e[18](e[44])}function p(...w){return e[19](e[44],...w)}return{key:n,first:null,c(){t=y("div"),o=y("span"),l=oe(s),i=I(),r=y("button"),r.textContent="√ó",a=I(),g(o,"class","history-item-name svelte-nuvzqg"),g(o,"title","Âä†ËΩΩÊ≠§ÂØπËØù"),g(r,"class","history-item-delete svelte-nuvzqg"),g(r,"title","Âà†Èô§Ê≠§ÂØπËØù"),g(t,"class","history-item svelte-nuvzqg"),this.first=t},m(w,m){B(w,t,m),h(t,o),h(o,l),h(t,i),h(t,r),h(t,a),u||(f=[P(o,"click",d),P(r,"click",p)],u=!0)},p(w,m){e=w,m[0]&8&&s!==(s=e[44].name+"")&&Me(l,s)},d(w){w&&T(t),u=!1,re(f)}}}function yt(n){let e,t,o;return{c(){e=y("button"),e.textContent="Âà†Èô§ÂΩìÂâç",g(e,"class","b3-button b3-button--error svelte-nuvzqg"),g(e,"title","Âà†Èô§ÂΩìÂâçÂØπËØù")},m(s,l){B(s,e,l),t||(o=P(e,"click",n[20]),t=!0)},p:Q,d(s){s&&T(e),t=!1,o()}}}function an(n){let e,t=(n[41].html||n[41].content)+"";return{c(){e=y("div"),g(e,"class","message ai svelte-nuvzqg")},m(o,s){B(o,e,s),e.innerHTML=t},p(o,s){s[0]&128&&t!==(t=(o[41].html||o[41].content)+"")&&(e.innerHTML=t)},d(o){o&&T(e)}}}function un(n){let e,t,o=n[41].content.replace(/\n/g,"<br/>")+"";return{c(){e=y("div"),t=y("div"),g(e,"class","message user svelte-nuvzqg")},m(s,l){B(s,e,l),h(e,t),t.innerHTML=o},p(s,l){l[0]&128&&o!==(o=s[41].content.replace(/\n/g,"<br/>")+"")&&(t.innerHTML=o)},d(s){s&&T(e)}}}function kt(n,e){let t,o;function s(r,a){if(r[41].role==="user")return un;if(r[41].role==="assistant")return an}let l=s(e),i=l&&l(e);return{key:n,first:null,c(){t=xe(),i&&i.c(),o=xe(),this.first=t},m(r,a){B(r,t,a),i&&i.m(r,a),B(r,o,a)},p(r,a){e=r,l===(l=s(e))&&i?i.p(e,a):(i&&i.d(1),i=l&&l(e),i&&(i.c(),i.m(o.parentNode,o)))},d(r){r&&(T(t),T(o)),i&&i.d(r)}}}function _t(n){let e;return{c(){e=y("div"),e.innerHTML='<p class="svelte-nuvzqg">AI Ê≠£Âú®ÊÄùËÄÉ...</p>',g(e,"class","message ai loading svelte-nuvzqg")},m(t,o){B(t,e,o)},d(t){t&&T(e)}}}function dn(n){let e,t,o,s,l=N(n[8]).length>1&&!n[4]&&!n[2],i,r,a,u,f=n[6]?"‚ñ≤":"‚ñº",d,p,w,m,k,_=[],S=new Nt,E,M,H,U,z,D,q,F,J,ie,ce,Z,$,L,j,Ce,Fe,Y=l&&ht(n),W=n[6]&&mt(n),G=n[4]&&yt(n),pe=ve(n[7]);const Te=c=>c[41].id;for(let c=0;c<pe.length;c+=1){let b=gt(n,pe,c),v=Te(b);S.set(v,_[c]=kt(v,b))}let V=n[2]&&_t();return H=new ln({}),H.$on("addDocumentReference",n[14]),{c(){e=y("div"),t=y("div"),o=y("button"),o.textContent="Êñ∞Âª∫ÂØπËØù",s=I(),Y&&Y.c(),i=I(),r=y("div"),a=y("button"),u=oe("üìú Âä†ËΩΩÂéÜÂè≤ÂØπËØù "),d=oe(f),p=I(),W&&W.c(),w=I(),G&&G.c(),m=I(),k=y("div");for(let c=0;c<_.length;c+=1)_[c].c();E=I(),V&&V.c(),M=I(),xt(H.$$.fragment),U=I(),z=y("div"),D=y("textarea"),q=I(),F=y("button"),J=oe("ÂèëÈÄÅ"),ce=I(),Z=y("button"),$=oe("ÂºïÁî®ÈÄâÂå∫"),g(o,"class","b3-button svelte-nuvzqg"),g(a,"title","Âä†ËΩΩÊàñÂà†Èô§ÂéÜÂè≤ÂØπËØù"),g(a,"class","svelte-nuvzqg"),g(r,"class","history-dropdown svelte-nuvzqg"),g(t,"class","conversation-controls svelte-nuvzqg"),g(k,"class","chat-history svelte-nuvzqg"),g(D,"placeholder","Âú®Ê≠§ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢òÊàñÊåá‰ª§..."),g(D,"rows","3"),D.disabled=n[2],g(D,"class","svelte-nuvzqg"),F.disabled=ie=!n[0].trim()||n[2],g(F,"class","svelte-nuvzqg"),g(Z,"class","add-reference-button svelte-nuvzqg"),g(Z,"title","Ê∑ªÂä†ÂΩìÂâçÈÄâ‰∏≠ÊñáÊú¨‰Ωú‰∏∫ÂºïÁî®"),Z.disabled=L=!n[5]||n[2],g(z,"class","input-area svelte-nuvzqg"),g(e,"class","ai-chat-panel svelte-nuvzqg")},m(c,b){B(c,e,b),h(e,t),h(t,o),h(t,s),Y&&Y.m(t,null),h(t,i),h(t,r),h(r,a),h(a,u),h(a,d),h(r,p),W&&W.m(r,null),h(t,w),G&&G.m(t,null),h(e,m),h(e,k);for(let v=0;v<_.length;v+=1)_[v]&&_[v].m(k,null);h(k,E),V&&V.m(k,null),n[21](k),h(e,M),Xe(H,e,null),h(e,U),h(e,z),h(z,D),le(D,n[0]),h(z,q),h(z,F),h(F,J),h(z,ce),h(z,Z),h(Z,$),j=!0,Ce||(Fe=[P(o,"click",n[9]),P(a,"click",n[16]),P(D,"input",n[22]),P(D,"keydown",n[23]),P(F,"click",n[13]),P(Z,"click",n[15])],Ce=!0)},p(c,b){b[0]&20&&(l=N(c[8]).length>1&&!c[4]&&!c[2]),l?Y?Y.p(c,b):(Y=ht(c),Y.c(),Y.m(t,i)):Y&&(Y.d(1),Y=null),(!j||b[0]&64)&&f!==(f=c[6]?"‚ñ≤":"‚ñº")&&Me(d,f),c[6]?W?W.p(c,b):(W=mt(c),W.c(),W.m(r,null)):W&&(W.d(1),W=null),c[4]?G?G.p(c,b):(G=yt(c),G.c(),G.m(t,null)):G&&(G.d(1),G=null),b[0]&128&&(pe=ve(c[7]),_=Ve(_,b,Te,1,c,pe,S,k,Qe,kt,E,gt)),c[2]?V||(V=_t(),V.c(),V.m(k,null)):V&&(V.d(1),V=null),(!j||b[0]&4)&&(D.disabled=c[2]),b[0]&1&&le(D,c[0]),(!j||b[0]&5&&ie!==(ie=!c[0].trim()||c[2]))&&(F.disabled=ie),(!j||b[0]&36&&L!==(L=!c[5]||c[2]))&&(Z.disabled=L)},i(c){j||(ge(H.$$.fragment,c),j=!0)},o(c){Ne(H.$$.fragment,c),j=!1},d(c){c&&T(e),Y&&Y.d(),W&&W.d(),G&&G.d();for(let b=0;b<_.length;b+=1)_[b].d();V&&V.d(),n[21](null),Ze(H),Ce=!1,re(Fe)}}}async function fn(n){if(!n)return console.log("No docId provided for structured context fetch."),"";console.log(`Fetching structured context for document ID: ${n}`);try{const e=`SELECT id, type, markdown FROM blocks WHERE parent_id = '${n}' ORDER BY sort ASC`,t=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:e})});if(!t.ok){const l=await t.text();throw new Error(`SQL query failed with status ${t.status}: ${l}`)}const o=await t.json();if(o.code!==0)throw new Error(`API returned error code ${o.code}: ${o.msg}`);if(console.log("Raw SQL query result data:",o.data),!o.data||!Array.isArray(o.data))return console.log("No block data returned from SQL query or data is not an array."),"Document is empty or contains no text blocks.";let s=`Current document context (Blocks ordered by position):
`;return o.data.forEach((l,i)=>{s+=`--- Block ${i+1} (ID: ${l.id}, Type: ${l.type}) ---
${l.markdown||"[Block content not directly in markdown field]"}

`}),s+="--- End of Blocks ---",console.log("Formatted structured context length:",s.length),s}catch(e){return console.error("Error fetching or processing structured document context:",e),`Error retrieving document structure: ${e.message}`}}async function gn(n){if(!n||n.length===0)return"";console.log(`[getReferencedBlocksContext] Fetching context for specific block IDs: ${n.join(", ")}`);try{const t=`SELECT id, type, markdown FROM blocks WHERE id IN (${n.map(a=>`'${a}'`).join(", ")})`;console.log(`[getReferencedBlocksContext] Executing SQL: ${t}`);const o=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:t})});if(!o.ok){const a=await o.text();throw new Error(`SQL query for references failed with status ${o.status}: ${a}`)}const s=await o.json();if(s.code!==0)throw new Error(`API returned error code ${s.code} for references: ${s.msg}`);if(!s.data||!Array.isArray(s.data))return console.log("No block data returned for referenced IDs."),"Could not retrieve content for referenced blocks.";console.log("[getReferencedBlocksContext] Raw SQL query result data for references:",s.data);const l=new Map(s.data.map(a=>[a.id,a])),i=n.map(a=>l.get(a)).filter(Boolean);let r=`Referenced content:
`;return i.forEach((a,u)=>{r+=`--- Referenced Block ${u+1} (ID: ${a.id}, Type: ${a.type}) ---
${a.markdown||"[Block content not directly in markdown field]"}

`}),r+="--- End of Referenced Blocks ---",console.log("[getReferencedBlocksContext] Formatted referenced context string:",r),r}catch(e){return console.error("[getReferencedBlocksContext] Error fetching or processing referenced block context:",e),`Error retrieving referenced content: ${e.message}`}}async function pn(n){var e,t;console.log(`[Context Fetch] Attempting to get Markdown for referenced document ID: ${n}`);try{console.log(`[Context Fetch] Trying /api/block/getBlockMarkdown for ${n}...`);const o=await fetch("/api/block/getBlockMarkdown",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n})});if(o.ok){const s=await o.json();if(s.code===0&&((e=s.data)!=null&&e.markdown))return console.log(`[Context Fetch] Success via /api/block/getBlockMarkdown for doc ID ${n}. Length: ${s.data.markdown.length}`),s.data.markdown;console.warn(`[Context Fetch] /api/block/getBlockMarkdown returned success code but no markdown data for doc ID ${n}. Result:`,s)}else console.warn(`[Context Fetch] /api/block/getBlockMarkdown failed (${o.status}) for doc ID ${n}.`)}catch(o){console.error(`[Context Fetch] Error calling /api/block/getBlockMarkdown for ${n}:`,o)}console.log(`[Context Fetch] Fallback: Trying /api/export/exportMdContent for ${n}...`);try{const o=await fetch("/api/export/exportMdContent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n})});if(!o.ok){const l=await o.text();throw new Error(`Fallback API /api/export/exportMdContent failed (${o.status}): ${l}`)}const s=await o.json();if(s.code===0&&((t=s.data)!=null&&t.content))return console.log(`[Context Fetch] Success via FALLBACK /api/export/exportMdContent for doc ID ${n}. Length: ${s.data.content.length}`),s.data.content;throw new Error(`Fallback API /api/export/exportMdContent returned error code ${s.code} or no content: ${s.msg||"No content found"}`)}catch(o){return console.error(`[Context Fetch] Error calling FALLBACK /api/export/exportMdContent for ${n}:`,o),null}}function hn(){console.log("Loading messages (ensure format is correct)...")}function vt(n){if(!n)return null;if(n instanceof HTMLElement&&n.dataset.nodeId)return n;const e=n.parentElement;return e instanceof HTMLElement&&e.dataset.nodeId?e:n instanceof Element?n.closest("[data-node-id]"):e==null?void 0:e.closest("[data-node-id]")}function mn(){var p,w,m;console.groupCollapsed("[getSelectedBlockIds] Check");const n=window.getSelection();if(!n||n.rangeCount===0||n.isCollapsed||!n.anchorNode||!n.focusNode)return console.log("No valid selection found."),console.groupEnd(),[];const e=n.getRangeAt(0);console.log("Selection range:",e),console.log("Start Container:",e.startContainer,"Offset:",e.startOffset),console.log("End Container:",e.endContainer,"Offset:",e.endOffset);const t=e.startContainer,o=(p=t instanceof Node&&t.nodeType===Node.ELEMENT_NODE?t:t.parentElement)==null?void 0:p.closest(".protyle-wysiwyg");if(!o)return console.log("Selection is not inside a protyle editor."),console.groupEnd(),[];console.log("Selection is inside editor:",o);const s=vt(e.startContainer),l=vt(e.endContainer);if(console.log("Found start block node:",(w=s==null?void 0:s.dataset)==null?void 0:w.nodeId,s),console.log("Found end block node:",(m=l==null?void 0:l.dataset)==null?void 0:m.nodeId,l),!s&&!l)return console.log("Neither start nor end of selection is inside a block."),console.groupEnd(),[];if(s&&s===l)return console.log("Selection within single block:",s.dataset.nodeId),console.groupEnd(),[s.dataset.nodeId];const i=Array.from(o.querySelectorAll("[data-node-id]"));console.log("All blocks in editor:",i.map(k=>k.dataset.nodeId));const r=[],a=s,u=l;let f=a?i.findIndex(k=>k===a):-1,d=u?i.findIndex(k=>k===u):-1;if(console.log(`Calculated indices: Start=${f}, End=${d}`),f===-1||d===-1)return console.warn("Could not reliably determine selection range indices within editor blocks. Returning found blocks only."),s!=null&&s.dataset.nodeId&&r.push(s.dataset.nodeId),l!=null&&l.dataset.nodeId&&l!==s&&r.push(l.dataset.nodeId),console.log("Final selected block IDs (fallback):",r),console.groupEnd(),Array.from(new Set(r));f>d&&([f,d]=[d,f],console.log("Swapped indices"));for(let k=f;k<=d;k++){const _=i[k];_!=null&&_.dataset.nodeId&&r.push(_.dataset.nodeId)}return console.log("Final selected block IDs:",r),console.groupEnd(),Array.from(new Set(r))}function bn(n,e,t){let o,{pluginData:s}=e,l=De([]);Ft(n,l,c=>t(7,o=c));let i="",r,a=!1,u,f=[],d=null,p=null,w="",m=[],k=!1,_=null,S=!1;const E=Oe.subscribe(c=>{u=c}),M=Ye.subscribe(c=>{t(3,f=c.sort((b,v)=>v.timestamp-b.timestamp))}),H=$e.subscribe(c=>{p=c}),U=Re.subscribe(c=>{});ne.subscribe(c=>{}),Ge(async()=>{const c="Êúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®Ôºü";l.set([{id:Date.now().toString()+"init",role:"assistant",content:c,html:se(c)}]),hn(),await be(),$(),document.addEventListener("selectionchange",j)}),Ht(()=>{E(),M(),H(),U(),document.removeEventListener("selectionchange",j)});async function z(){N(l).length>1&&!d&&!a&&(console.log("Auto-saving previous conversation..."),await D());const c="Êñ∞ÂØπËØùÂ∑≤ÂºÄÂßãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®Ôºü",b=se(c);l.set([{id:Date.now().toString()+"init-new",role:"assistant",content:c,html:b}]),t(4,d=null),t(0,i=""),await be(),$()}async function D(){if(a||N(l).length<=1||d)return;const c=Date.now(),b=c.toString(),v=`ÂØπËØù ${new Date(c).toLocaleString()}`,O=[{id:b,name:v,timestamp:c,messages:N(l).filter(K=>K.role==="user"||K.role==="assistant").map(({role:K,content:ae})=>({role:K,content:ae}))},...f];await s.saveConversations(O),t(4,d=b),console.log("Conversation saved with ID:",b)}function q(c){const b=f.find(v=>v.id===c);b&&(l.update(v=>b.messages.map((R,O)=>({...R,id:O,html:R.role==="assistant"?se(R.content):void 0}))),t(4,d=b.id),N(l).length,t(0,i=""),be().then($),console.log("Conversation loaded:",c))}async function F(c,b){if(b.stopPropagation(),confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂØπËØùÂêóÔºü")){const v=f.filter(R=>R.id!==c);await s.saveConversations(v),d===c&&z(),console.log("Conversation deleted:",c)}}async function J(c){console.log(`Attempting to delete block: ${c}`);try{const b=await fetch("/api/block/deleteBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c})});if(!b.ok){const R=await b.text();throw new Error(`API deleteBlock failed (${b.status}): ${R}`)}const v=await b.json();if(v.code!==0)throw new Error(`API deleteBlock returned error code ${v.code}: ${v.msg}`);console.log(`Block ${c} deleted successfully.`)}catch(b){throw console.error(`Error executing deleteBlock for ${c}:`,b),w=`Âà†Èô§Âùó ${c} Â§±Ë¥•: ${b.message}`,b}}async function ie(c,b){console.log(`Attempting to update block ${c} with new markdown:`,b);try{const v=await fetch("/api/block/updateBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c,dataType:"markdown",data:b})});if(!v.ok){const O=await v.text();throw new Error(`API updateBlock failed (${v.status}): ${O}`)}const R=await v.json();if(R.code!==0)throw new Error(`API updateBlock returned error code ${R.code}: ${R.msg}`);console.log(`Block ${c} updated successfully.`)}catch(v){throw console.error(`Error executing updateBlock for ${c}:`,v),w=`Êõ¥Êñ∞Âùó ${c} Â§±Ë¥•: ${v.message}`,v}}async function ce(c,b,v){console.log(`Attempting to insert block after ${c||"start"} with parent ${v||"unknown"}, content:
${b}`);const R={dataType:"markdown",data:b};c!==null?R.previousID=c:(v!==null&&(R.parentID=v),R.previousID="");try{console.log("Executing insert with payload:",R);const O=await fetch("/api/block/insertBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(R)});if(!O.ok){const ae=await O.text();throw new Error(`API Error (${O.status}): ${ae}`)}const K=await O.json();if(K.code!==0)throw new Error(`API returned error code ${K.code}: ${K.msg}`);console.log(`Block inserted successfully after ${c||"start"}.`)}catch(O){throw console.error("Error executing insert block command:",O),w=`ÊèíÂÖ•ÂùóÂ§±Ë¥•: ${O.message}`,O}}async function Z(){const c=i.trim();if(!c||a)return;w="",t(2,a=!0);const b=c.match(/^(Âà†Èô§|‰øÆÊîπ)ÈÄâÂå∫(\d+)$/i);let v=!1;if(b){const A=b[1],x=parseInt(b[2],10);console.log(`[Frontend Command] Matched: action=${A}, index=${x}`);const te=N(ne);console.log("[Frontend Command] Current references in store:",JSON.stringify(te,null,2));const C=te.filter(X=>X.type==="selection");if(console.log("[Frontend Command] Filtered selection references:",JSON.stringify(C,null,2)),x>0&&x<=C.length){const X=C[x-1];console.log(`[Frontend Command] Target reference (at index ${x-1}):`,JSON.stringify(X,null,2));const ee=X.blockIds;if(console.log(`[Frontend Command] Target Block IDs for ${A}:`,JSON.stringify(ee)),A.toLowerCase()==="Âà†Èô§")try{for(const ue of ee)await J(ue);const me=Date.now().toString()+"fe-del";l.update(ue=>[...ue,{id:me,role:"assistant",content:`Â∑≤ÊâßË°åÂà†Èô§ÈÄâÂå∫ ${x} (Âùó: ${ee.join(", ")}) ÁöÑÊìç‰Ωú„ÄÇ`,html:se(`Â∑≤ÊâßË°åÂà†Èô§ÈÄâÂå∫ **${x}** (Âùó: ${ee.join(", ")}) ÁöÑÊìç‰Ωú„ÄÇ`)}]),l.set([...N(l)]);const Ie=X.id;console.log(`[Frontend Command] Removing reference with ID: ${Ie}`),ne.update(ue=>{const st=ue.filter(Mt=>Mt.id!==Ie);return console.log("[Frontend Command] References after removal:",JSON.stringify(st,null,2)),st}),v=!0}catch(me){console.error("[Frontend Command] Error executing frontend delete command:",me),w=`ÊâßË°åÂà†Èô§ÈÄâÂå∫ ${x} Â§±Ë¥•: ${me.message}`,v=!0}else A.toLowerCase()==="‰øÆÊîπ"&&(console.log("Frontend modification command recognized, but not fully implemented."),w='ÈÄöËøá "‰øÆÊîπÈÄâÂå∫N" Êåá‰ª§‰øÆÊîπÂÜÖÂÆπÁöÑÂäüËÉΩÂ∞öÊú™ÂÆåÂÖ®ÂÆûÁé∞„ÄÇËØ∑Â∞ùËØïÈÄâ‰∏≠ÂÜÖÂÆπÂêéÔºåÁõ¥Êé•Âêë AI ÊèêÂá∫‰øÆÊîπË¶ÅÊ±Ç„ÄÇ',v=!0)}else console.warn(`[Frontend Command] Invalid index ${x} for ${C.length} selection references.`),w=`Êó†ÊïàÁöÑÈÄâÂå∫ÁºñÂè∑: ${x}„ÄÇËØ∑Á°Æ‰øùÁºñÂè∑Âú® 1 Âà∞ ${C.length} ‰πãÈó¥„ÄÇ`,v=!0}if(v){t(0,i=""),t(2,a=!1),await be(),$();return}const O={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:c};l.update(A=>[...A,O]),l.set([...N(l)]),console.log("User message added to store:",N(l)),t(0,i=""),await be(),$();let K=await fn(p),ae="",qe="";const et=N(ne),Ue=et.filter(A=>A.type==="selection");if(Ue.length>0){const A=Ue.flatMap(x=>x.blockIds);ae=await gn(A)}const tt=et.filter(A=>A.type==="document");if(tt.length>0){let A=`

--- Referenced Documents ---
`;for(const x of tt){const te=x.blockIds[0],C=await pn(te);C?A+=`
--- Document: ${x.label} (ID: ${te}) ---
${C}
---;
`:A+=`
--- Document: ${x.label} (ID: ${te}) --- (Content not available) ---;
`}qe=A}let he=K?`--- Current Document Context ---
${K}`:"No current document context available.";ae&&(he+=ae),qe&&(he+=qe),console.log("Combined context string prepared for system prompt (length:",he.length,"):",he.substring(0,500)+"...");const Ot=N(l).filter(A=>A.role==="user"||A.role==="assistant").slice(-20).map(A=>({role:A.role,content:A.content}));let nt=`You are a helpful AI assistant integrated into Siyuan Note.\\nYou can interact with the document content based on the provided context.\\n\\n**Understanding the Context:**\\nThe context below shows the structure and content of the current document or specific blocks selected by the user.\\nEach block is listed with its sequential number, unique ID, and type, like this:\\n--- Block N (ID: yyyy-mmdd-xxxxxx, Type: p) ---\\n[Markdown content of the block]\\n---\\n+(Referenced blocks, if any, will be listed under \\"Referenced content:\\")\\n\\n**Performing Actions (Delete/Update):**\\nWhen the user asks you to modify the document (e.g., \\"delete the second paragraph\\", \\"update the list item with ID xxx\\"):\\n1. Carefully identify the **exact block ID** (e.g., yyyy-mmdd-xxxxxx) from the context that corresponds to the user\\'s request.\\n2. Output **only** a single JSON command block using one of the following formats. **You MUST use the specific block ID found in the context.**\\n\\n   *   To delete a block: \\\`\\\`\\\`json {\\"action\\": \\"delete\\", \\"block_id\\": \\"TARGET_BLOCK_ID_FROM_CONTEXT\\"} \\\`\\\`\\\`\\
   *   To update a block: \\\`\\\`\\\`json {\\"action\\": \\"update\\", \\"block_id\\": \\"TARGET_BLOCK_ID_FROM_CONTEXT\\", \\"new_markdown\\": \\"NEW_MARKDOWN_CONTENT\\"} \\\`\\\`\\\`\\
   *   To insert a block: \\\`\\\`\\\`json {\\"action\\": \\"insert\\", \\"previousID\\": \\"ID_OF_BLOCK_BEFORE\\", \\"parentID\\": null, \\"markdown\\": \\"NEW_MARKDOWN_CONTENT\\"} \\\`\\\`\\\` (Note: parentID is usually null for insertions relative to existing blocks)\\
\\n**IMPORTANT RULES:**\\n*   **Action Intent:** Determine the user\\'s core goal:\\
    *   \\'update\\': User wants to *modify, update, or replace* content of an *existing* block.\\
    *   \\'delete\\': User wants to *remove or delete* an *existing* block.\\
    *   \\'insert\\': User wants to *add, insert, create, or write* *new* content/blocks.\\
    *   **If unsure about intent, ASK the user.**\\
*   **Handling Multi-Block References (CRITICAL - READ CAREFULLY!):** When a reference label (e.g., "Selection 1") points to multiple block IDs in the \\\`Referenced content\\\`:\\n    *   **Information Requests:** If asked for information (e.g., "What is in Selection 1?", "Summarize Selection 1"), you **MUST** address or summarize the content of **ALL** associated blocks in your response.\\n    *   **Action Requests (e.g., "delete", "update", "insert after Selection 1"):** \\n        1.  You **MUST NOT** generate multiple commands for this single user request.\\n        2.  You **MUST NOT** guess which block to act upon.\\n        3.  You **MUST ALWAYS ask the user for clarification FIRST**. \\n        4.  **Your clarification response MUST be ONLY natural language**, asking which specific block ID they want the action performed on. Example: \\"Selection 1 includes Block ID xxx and Block ID yyy. Which one do you want to [action]?\\" **DO NOT include any JSON command block in your clarification response.**\\n        5.  **Only AFTER** the user responds specifying a single ID, you can then generate a **single** command targeting that user-specified ID.\\n*   **Insert Command - How to Set IDs (ONLY relative to specific Block IDs):**\\
    *   **Goal: Insert AFTER Block A?** (e.g., \\"add below Block A\\", \\"insert after selection 1\\")\\
        *   Find Block A\\'s ID in the context (\\'BLOCK_A_ID\\').\\
        *   Set \\'previousID\\' = \\'BLOCK_A_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Goal: Insert BEFORE Block B?** (e.g., \\"insert before Block B\\", \\"add above selection 1\\")\\
        *   Find the ID of the block *immediately preceding* Block B in the context (\\'BLOCK_B_minus_1_ID\\'). **There MUST be a preceding block.**\\
        *   Set \\'previousID\\' = \\'BLOCK_B_minus_1_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Goal: Insert BETWEEN Block A and Block B?** (e.g., \\"put this between block 1 and 2\\")\\
        *   Treat this as \\"Insert AFTER Block A\\".\\
        *   Find Block A\\'s ID (\\'BLOCK_A_ID\\').\\
        *   Set \\'previousID\\' = \\'BLOCK_A_ID\\'.\\
        *   Set \\'parentID\\' = null (or omit).\\
    *   **Content:** The \\'markdown\\' field must contain the complete Markdown content for the new block(s).\\
*   **NO Fuzzy Locations:** Requests like \\"insert at the beginning\\", \\"insert at the end\\", or \\"insert here\\" are **NOT SUPPORTED** for direct action. See \\"Ask If Unsure\\".\\
*   **Referenced Context First:** If \\'Referenced content\\' is provided and the user\\'s request mentions the selection/reference (e.g., \\"update selection 1\\", \\"insert after the selected paragraph\\"), **MUST** use the block ID(s) from the \\'Referenced content\\' section for targeting.\\
*   **Use Exact IDs:** Always use the exact block IDs shown in parentheses (ID: ...) from the context. Never guess IDs or use block numbers like \\"Block 3\\".\\
*   **Ask If Unsure (CRITICAL):** If the user\\'s request is ambiguous about the action (update/delete/insert), the target block/location, or if you cannot confidently find the necessary IDs in the context according to these rules (including the multi-block clarification rule), **you MUST ask the user for clarification**. \\
    *   **Specifically:** If the user asks to insert at the beginning, end, or uses vague terms without specifying a block ID, you MUST reply asking them to provide the **ID of the block** they want to insert **before** or **after**.\\
    *   Example clarifying question: \\"To insert the content, please tell me the ID of the block you want to insert it before or after.\\"\\
    *   Do NOT guess or make assumptions.\\
*   **Normal Chat:** For general questions, summaries, or explanations that don\\'t involve changing the document, respond normally in natural language without any JSON command block.\\
\\
--- Context Starts Below:`;he&&(nt+=`

${he}`);const ot=[{role:"system",content:nt},...Ot];console.log("Messages being sent to API (final format):",ot);try{const A=await Vt(ot,u);let x=!1;const te=A.match(/```json\n({.*?})\n```/s);if(te&&te[1])try{const C=JSON.parse(te[1]);if(console.log("Parsed AI command:",C),C.action==="delete"&&C.block_id){await J(C.block_id),x=!0;const X=Date.now().toString()+"cmd-del";l.update(ee=>[...ee,{id:X,role:"assistant",content:`Â∑≤ÊâßË°åÂà†Èô§Âùó ${C.block_id} ÁöÑÊìç‰Ωú„ÄÇ`,html:se(`Â∑≤ÊâßË°åÂà†Èô§Âùó **${C.block_id}** ÁöÑÊìç‰Ωú„ÄÇ`)}]),l.set([...N(l)])}else if(C.action==="update"&&C.block_id&&typeof C.new_markdown=="string"){await ie(C.block_id,C.new_markdown),x=!0;const X=Date.now().toString()+"cmd-upd";l.update(ee=>[...ee,{id:X,role:"assistant",content:`Â∑≤ÊâßË°åÊõ¥Êñ∞Âùó ${C.block_id} ÁöÑÊìç‰Ωú„ÄÇ`,html:se(`Â∑≤ÊâßË°åÊõ¥Êñ∞Âùó **${C.block_id}** ÁöÑÊìç‰Ωú„ÄÇ`)}]),l.set([...N(l)])}else if(C.action==="insert"&&typeof C.markdown=="string"&&(typeof C.previousID=="string"||typeof C.parentID=="string"&&C.parentID!=="")){const X=C.previousID===""?null:C.previousID,ee=C.parentID||null;await ce(X,C.markdown,ee),x=!0;const me=Date.now().toString()+"cmd-ins",Ie=X?`Âùó ${X} ‰πãÂêé`:ee?`ÊñáÊ°£ ${ee} ÂºÄÂ§¥`:"ÊñáÊ°£ÂºÄÂ§¥";l.update(ue=>[...ue,{id:me,role:"assistant",content:`Â∑≤Âú® ${Ie} ÊèíÂÖ•Êñ∞Âùó„ÄÇ`,html:se(`Â∑≤Âú® **${Ie}** ÊèíÂÖ•Êñ∞Âùó„ÄÇ`)}]),l.set([...N(l)])}else console.warn("Parsed command JSON has invalid action or missing/invalid parameters:",C)}catch(C){console.error("Failed to parse command JSON:",C,"Raw content:",te[1])}if(!x){const X={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:A,html:se(A)};l.update(ee=>[...ee,X]),l.set([...N(l)]),console.log("Assistant message added to store:",N(l))}}catch(A){console.error("Error fetching chat completion:",A),w=`AI ËØ∑Ê±ÇÂ§±Ë¥•: ${A.message}`;const te={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`Êä±Ê≠âÔºåËØ∑Ê±ÇÂá∫Èîô: ${w}`,html:se(`Êä±Ê≠âÔºåËØ∑Ê±ÇÂá∫Èîô: ${w}`)};l.update(C=>[...C,te]),l.set([...N(l)]),console.log("Error message added to store:",N(l))}finally{t(2,a=!1),!v&&Ue.length>0&&(console.log("Clearing selection references after AI call."),ne.update(A=>A.filter(x=>x.type!=="selection"))),await be(),$()}}function $(){r&&requestAnimationFrame(()=>{t(1,r.scrollTop=r.scrollHeight,r)})}async function L(c){const{docId:b,title:v}=c.detail;if(!b||!v)return;const O={id:`doc-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,label:v,blockIds:[b],type:"document"};ne.update(K=>[...K,O]),console.log("Added document reference via event:",O)}function j(){_&&clearTimeout(_),_=window.setTimeout(()=>{const c=mn();c.length>0?(m=c,t(5,k=!0),console.log("Selection changed (debounced), FOUND blocks, Enabling button. IDs:",m)):console.log("Selection changed (debounced), NO valid blocks found, button state remains:",k)},150)}function Ce(){var O;if(!k||m.length===0)return;const c=`sel-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,v=`ÈÄâÂå∫ ${N(ne).filter(K=>K.type==="selection").length+1}`,R={id:c,label:v,blockIds:[...m],type:"selection"};console.log("[addSelectionReference] About to update referenceStore. Current state:",N(ne)),console.log("[addSelectionReference] Adding new reference:",R),ne.update(K=>[...K,R]),console.log("[addSelectionReference] Updated referenceStore state:",N(ne)),m=[],t(5,k=!1),(O=window.getSelection())==null||O.removeAllRanges()}function Fe(){t(6,S=!S)}const Y=c=>{q(c.id),t(6,S=!1)},W=(c,b)=>F(c.id,b),G=c=>F(d,c);function pe(c){He[c?"unshift":"push"](()=>{r=c,t(1,r)})}function Te(){i=this.value,t(0,i)}const V=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),Z())};return n.$$set=c=>{"pluginData"in c&&t(17,s=c.pluginData)},[i,r,a,f,d,k,S,o,l,z,D,q,F,Z,L,Ce,Fe,s,Y,W,G,pe,Te,V]}class wn extends Pe{constructor(e){super(),Le(this,e,bn,dn,Ae,{pluginData:17},null,[-1,-1])}}function Dt(n){let e,t;return{c(){e=y("span"),t=oe(n[3]),g(e,"class","status-message svelte-136cw2s")},m(o,s){B(o,e,s),h(e,t)},p(o,s){s&8&&Me(t,o[3])},d(o){o&&T(e)}}}function yn(n){let e,t,o,s,l,i,r,a,u,f,d,p,w,m,k,_,S,E,M,H,U,z,D,q,F,J,ie,ce,Z,$=n[3]&&Dt(n);return{c(){e=y("div"),t=y("h2"),t.textContent="AI Âä©ÊâãËÆæÁΩÆ",o=I(),s=y("div"),l=y("label"),l.textContent="AI API Endpoint URL:",i=I(),r=y("input"),a=I(),u=y("p"),u.textContent="ËØ∑ËæìÂÖ•ÊÇ®Ë¶Å‰ΩøÁî®ÁöÑ AI ÊúçÂä°ÁöÑÂÆåÊï¥ URL„ÄÇ",f=I(),d=y("div"),p=y("label"),p.textContent="API Key:",w=I(),m=y("input"),k=I(),_=y("p"),_.textContent="ÊÇ®ÁöÑ API Key Â∞ÜË¢´‰øùÂ≠òÂú®Êú¨Âú∞ÈÖçÁΩÆÊñá‰ª∂‰∏≠„ÄÇ",S=I(),E=y("div"),M=y("label"),M.textContent="Ê®°ÂûãÂêçÁß∞:",H=I(),U=y("input"),z=I(),D=y("p"),D.textContent="ËØ∑ËæìÂÖ•Ë¶ÅË∞ÉÁî®ÁöÑÂÖ∑‰ΩìÊ®°ÂûãÂêçÁß∞„ÄÇ",q=I(),F=y("div"),J=y("button"),J.textContent="‰øùÂ≠òËÆæÁΩÆ",ie=I(),$&&$.c(),g(t,"class","svelte-136cw2s"),g(l,"for","api-url"),g(l,"class","svelte-136cw2s"),g(r,"id","api-url"),g(r,"type","text"),g(r,"placeholder","‰æãÂ¶Ç: https://api.openai.com/v1/chat/completions"),g(r,"class","b3-text-field svelte-136cw2s"),g(u,"class","description svelte-136cw2s"),g(s,"class","form-item svelte-136cw2s"),g(p,"for","api-key"),g(p,"class","svelte-136cw2s"),g(m,"id","api-key"),g(m,"type","password"),g(m,"placeholder","ËØ∑ËæìÂÖ•ÊÇ®ÁöÑ API Key"),g(m,"class","b3-text-field svelte-136cw2s"),g(_,"class","description svelte-136cw2s"),g(d,"class","form-item svelte-136cw2s"),g(M,"for","model-name"),g(M,"class","svelte-136cw2s"),g(U,"id","model-name"),g(U,"type","text"),g(U,"placeholder","‰æãÂ¶Ç: deepseek-chat, gpt-4o, ..."),g(U,"class","b3-text-field svelte-136cw2s"),g(D,"class","description svelte-136cw2s"),g(E,"class","form-item svelte-136cw2s"),g(J,"class","b3-button b3-button--primary"),g(F,"class","actions svelte-136cw2s"),g(e,"class","settings-panel svelte-136cw2s")},m(L,j){B(L,e,j),h(e,t),h(e,o),h(e,s),h(s,l),h(s,i),h(s,r),le(r,n[0]),h(s,a),h(s,u),h(e,f),h(e,d),h(d,p),h(d,w),h(d,m),le(m,n[1]),h(d,k),h(d,_),h(e,S),h(e,E),h(E,M),h(E,H),h(E,U),le(U,n[2]),h(E,z),h(E,D),h(e,q),h(e,F),h(F,J),h(F,ie),$&&$.m(F,null),ce||(Z=[P(r,"input",n[8]),P(m,"input",n[9]),P(U,"input",n[10]),P(J,"click",n[4])],ce=!0)},p(L,[j]){j&1&&r.value!==L[0]&&le(r,L[0]),j&2&&m.value!==L[1]&&le(m,L[1]),j&4&&U.value!==L[2]&&le(U,L[2]),L[3]?$?$.p(L,j):($=Dt(L),$.c(),$.m(F,null)):$&&($.d(1),$=null)},i:Q,o:Q,d(L){L&&T(e),$&&$.d(),ce=!1,re(Z)}}}function kn(n,e,t){let{loadSettings:o}=e,{saveSettings:s}=e,{currentSettings:l}=e,i="",r="",a="",u="";Ge(async()=>{if(l)t(0,i=l.apiUrl||""),t(1,r=l.apiKey||""),t(2,a=l.modelName||"deepseek-chat");else{const m=await o();t(0,i=m.apiUrl||""),t(1,r=m.apiKey||""),t(2,a=m.modelName||"deepseek-chat")}});async function f(){try{await s({apiUrl:i,apiKey:r,modelName:a}),t(3,u="ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ"),setTimeout(()=>t(3,u=""),3e3)}catch(m){t(3,u=`‰øùÂ≠òÂ§±Ë¥•: ${m.message}`)}}function d(){i=this.value,t(0,i)}function p(){r=this.value,t(1,r)}function w(){a=this.value,t(2,a)}return n.$$set=m=>{"loadSettings"in m&&t(5,o=m.loadSettings),"saveSettings"in m&&t(6,s=m.saveSettings),"currentSettings"in m&&t(7,l=m.currentSettings)},[i,r,a,u,f,o,s,l,d,p,w]}class _n extends Pe{constructor(e){super(),Le(this,e,kn,yn,Ae,{loadSettings:5,saveSettings:6,currentSettings:7})}}const Ct="ai-assistant-config",It="ai-assistant-conversations",vn={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},Dn="ai_assistant_dock";class Cn extends ze.Plugin{constructor(){super(...arguments);de(this,"isMobile");de(this,"settings");de(this,"settingsDialog",null);de(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const t=ze.getFrontend();this.isMobile=t==="mobile"||t==="browser-mobile",await this.loadSettings(),await this.loadConversations(),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AIÂä©Êâã":`AIÂä©Êâã(${this.name})`,hotkey:"‚å•‚åòA"},data:{plugin:this,saveConversations:this.saveConversations.bind(this)},type:Dn,init(o){new wn({target:o.element,props:{pluginData:o.data}}),console.log("AI Assistant Dock initialized with Svelte component")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:t}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",t),t&&t.protyle&&t.protyle.block&&t.protyle.block.rootID){const o=t.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${o}`),$e.set(o),console.log(`Current document ID updated via switch-protyle: ${o}`),t.protyle.path){const s=t.protyle.path;console.log(`Doc Path found in protyle.path: ${s}`),Re.set(s),console.log(`Current document Path updated via switch-protyle: ${s}`)}else console.warn("Doc Path not found in protyle detail."),Re.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),$e.set(null),Re.set(null)}updateCurrentDocIdFromActiveTab(){var t;console.log("Attempting to get doc ID from active tab...");try{const o=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(o){console.log("Active protyle tab element found.");let s=o,l=s==null?void 0:s.protyle;for(;s&&!l;)l=s==null?void 0:s.protyle,s=s.parentElement;if((t=l==null?void 0:l.block)!=null&&t.rootID){const i=l.block.rootID;$e.set(i),console.log(`Updated doc ID from active tab in onLayoutReady: ${i}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:l});const i=o.getAttribute("data-node-id");i&&console.log(`Found node-id on active tab: ${i}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(o){console.error("Error getting doc ID from active tab:",o)}}openSetting(){this.settingsDialog||(this.settingsDialog=new ze.Dialog({title:"AI Âä©ÊâãËÆæÁΩÆ",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new _n({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const t=await this.loadData(Ct);return this.settings=Object.assign({},vn,t),Oe.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(t){this.settings=t,await this.saveData(Ct,this.settings),Oe.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const t=await this.loadData(It)||[];Ye.set(t),console.log(`${t.length} conversations loaded.`)}async saveConversations(t){await this.saveData(It,t),Ye.set(t),console.log(`Conversations saved (${t.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=Cn;
