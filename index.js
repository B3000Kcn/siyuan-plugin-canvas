"use strict";var sn=Object.defineProperty;var ln=(n,e,t)=>e in n?sn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _e=(n,e,t)=>ln(n,typeof e!="symbol"?e+"":e,t);const lt=require("siyuan");function Z(){}function jt(n){return n()}function yt(){return Object.create(null)}function fe(n){n.forEach(jt)}function Ut(n){return typeof n=="function"}function Ke(n,e){return n!=n?e==e:n!==e||n&&typeof n=="object"||typeof n=="function"}function rn(n){return Object.keys(n).length===0}function Ht(n,...e){if(n==null){for(const s of e)s(void 0);return Z}const t=n.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function x(n){let e;return Ht(n,t=>e=t)(),e}function qt(n,e,t){n.$$.on_destroy.push(Ht(e,t))}const cn=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global;function h(n,e){n.appendChild(e)}function R(n,e,t){n.insertBefore(e,t||null)}function T(n){n.parentNode&&n.parentNode.removeChild(n)}function y(n){return document.createElement(n)}function ae(n){return document.createTextNode(n)}function S(){return ae(" ")}function We(){return ae("")}function P(n,e,t,s){return n.addEventListener(e,t,s),()=>n.removeEventListener(e,t,s)}function d(n,e,t){t==null?n.removeAttribute(e):n.getAttribute(e)!==t&&n.setAttribute(e,t)}function an(n){return Array.from(n.childNodes)}function et(n,e){e=""+e,n.data!==e&&(n.data=e)}function me(n,e){n.value=e??""}function Ve(n,e,t,s){t==null?n.style.removeProperty(e):n.style.setProperty(e,t,"")}function wt(n,e,t){n.classList.toggle(e,!!t)}function un(n,e,{bubbles:t=!1,cancelable:s=!1}={}){return new CustomEvent(n,{detail:e,bubbles:t,cancelable:s})}let Je;function qe(n){Je=n}function dt(){if(!Je)throw new Error("Function called outside component initialization");return Je}function ft(n){dt().$$.on_mount.push(n)}function dn(n){dt().$$.on_destroy.push(n)}function Jt(){const n=dt();return(e,t,{cancelable:s=!1}={})=>{const o=n.$$.callbacks[e];if(o){const i=un(e,t,{cancelable:s});return o.slice().forEach(l=>{l.call(n,i)}),!i.defaultPrevented}return!0}}const $e=[],ct=[];let Ne=[];const vt=[],Kt=Promise.resolve();let at=!1;function Gt(){at||(at=!0,Kt.then(Vt))}function Me(){return Gt(),Kt}function ut(n){Ne.push(n)}const it=new Set;let Re=0;function Vt(){if(Re!==0)return;const n=Je;do{try{for(;Re<$e.length;){const e=$e[Re];Re++,qe(e),fn(e.$$)}}catch(e){throw $e.length=0,Re=0,e}for(qe(null),$e.length=0,Re=0;ct.length;)ct.pop()();for(let e=0;e<Ne.length;e+=1){const t=Ne[e];it.has(t)||(it.add(t),t())}Ne.length=0}while($e.length);for(;vt.length;)vt.pop()();at=!1,it.clear(),qe(n)}function fn(n){if(n.fragment!==null){n.update(),fe(n.before_update);const e=n.dirty;n.dirty=[-1],n.fragment&&n.fragment.p(n.ctx,e),n.after_update.forEach(ut)}}function gn(n){const e=[],t=[];Ne.forEach(s=>n.indexOf(s)===-1?e.push(s):t.push(s)),t.forEach(s=>s()),Ne=e}const Ye=new Set;let Ae;function pn(){Ae={r:0,c:[],p:Ae}}function mn(){Ae.r||fe(Ae.c),Ae=Ae.p}function Se(n,e){n&&n.i&&(Ye.delete(n),n.i(e))}function Xe(n,e,t,s){if(n&&n.o){if(Ye.has(n))return;Ye.add(n),Ae.c.push(()=>{Ye.delete(n),s&&(t&&n.d(1),s())}),n.o(e)}else s&&s()}function Le(n){return(n==null?void 0:n.length)!==void 0?n:Array.from(n)}function gt(n,e){n.d(1),e.delete(n.key)}function pt(n,e,t,s,o,i,l,r,a,u,p,f){let g=n.length,v=i.length,m=g;const k={};for(;m--;)k[n[m].key]=m;const w=[],B=new Map,F=new Map,O=[];for(m=v;m--;){const _=f(o,i,m),V=t(_);let $=l.get(V);$?O.push(()=>$.p(_,e)):($=u(V,_),$.c()),B.set(V,w[m]=$),V in k&&F.set(V,Math.abs(m-k[V]))}const q=new Set,J=new Set;function G(_){Se(_,1),_.m(r,p),l.set(_.key,_),p=_.first,v--}for(;g&&v;){const _=w[v-1],V=n[g-1],$=_.key,ee=V.key;_===V?(p=_.first,g--,v--):B.has(ee)?!l.has($)||q.has($)?G(_):J.has(ee)?g--:F.get($)>F.get(ee)?(J.add($),G(_)):(q.add(ee),g--):(a(V,l),g--)}for(;g--;){const _=n[g];B.has(_.key)||a(_,l)}for(;v;)G(w[v-1]);return fe(O),w}function Yt(n){n&&n.c()}function mt(n,e,t){const{fragment:s,after_update:o}=n.$$;s&&s.m(e,t),ut(()=>{const i=n.$$.on_mount.map(jt).filter(Ut);n.$$.on_destroy?n.$$.on_destroy.push(...i):fe(i),n.$$.on_mount=[]}),o.forEach(ut)}function ht(n,e){const t=n.$$;t.fragment!==null&&(gn(t.after_update),fe(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function hn(n,e){n.$$.dirty[0]===-1&&($e.push(n),Gt(),n.$$.dirty.fill(0)),n.$$.dirty[e/31|0]|=1<<e%31}function tt(n,e,t,s,o,i,l=null,r=[-1]){const a=Je;qe(n);const u=n.$$={fragment:null,ctx:[],props:i,update:Z,not_equal:o,bound:yt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(a?a.$$.context:[])),callbacks:yt(),dirty:r,skip_bound:!1,root:e.target||a.$$.root};l&&l(u.root);let p=!1;if(u.ctx=t?t(n,e.props||{},(f,g,...v)=>{const m=v.length?v[0]:g;return u.ctx&&o(u.ctx[f],u.ctx[f]=m)&&(!u.skip_bound&&u.bound[f]&&u.bound[f](m),p&&hn(n,f)),g}):[],u.update(),p=!0,fe(u.before_update),u.fragment=s?s(u.ctx):!1,e.target){if(e.hydrate){const f=an(e.target);u.fragment&&u.fragment.l(f),f.forEach(T)}else u.fragment&&u.fragment.c();e.intro&&Se(n.$$.fragment),mt(n,e.target,e.anchor),Vt()}qe(a)}class nt{constructor(){_e(this,"$$");_e(this,"$$set")}$destroy(){ht(this,1),this.$destroy=Z}$on(e,t){if(!Ut(t))return Z;const s=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return s.push(t),()=>{const o=s.indexOf(t);o!==-1&&s.splice(o,1)}}$set(e){this.$$set&&!rn(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}const bn="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(bn);const xe=[];function Pe(n,e=Z){let t;const s=new Set;function o(r){if(Ke(n,r)&&(n=r,t)){const a=!xe.length;for(const u of s)u[1](),xe.push(u,n);if(a){for(let u=0;u<xe.length;u+=2)xe[u][0](xe[u+1]);xe.length=0}}}function i(r){o(r(n))}function l(r,a=Z){const u=[r,a];return s.add(u),s.size===1&&(t=e(o,i)||Z),r(n),()=>{s.delete(u),s.size===0&&t&&(t(),t=null)}}return{set:o,update:i,subscribe:l}}const Ze=Pe({apiKey:"",modelName:"deepseek-chat"}),Oe=Pe([]),ze=Pe(null),Qe=Pe(null),re=Pe([]);async function yn(n){const e=x(Ze);if(!e.apiKey||!e.apiUrl)throw new Error("API Key 或 API URL 未配置");const t=await fetch(e.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.apiKey}`},body:JSON.stringify({model:e.modelName||"deepseek-chat",messages:n,temperature:e.temperature||.7,max_tokens:e.maxTokens||2e3})});if(!t.ok){const o=await t.text();throw new Error(`API 请求失败: ${t.status} ${o}`)}const s=await t.json();if(!s.choices||s.choices.length===0)throw new Error("API 返回数据格式错误");return s.choices[0].message.content}function ce(n){return window.Lute.New().Md2HTML(n)}function wn(n){let e;return{c(){e=ae("添加")},m(t,s){R(t,e,s)},d(t){t&&T(e)}}}function vn(n){let e;return{c(){e=ae("正在获取...")},m(t,s){R(t,e,s)},d(t){t&&T(e)}}}function kt(n){let e,t=ce(n[2])+"";return{c(){e=y("div"),d(e,"class","error-message svelte-f3rpt"),d(e,"role","alert")},m(s,o){R(s,e,o),e.innerHTML=t},p(s,o){o&4&&t!==(t=ce(s[2])+"")&&(e.innerHTML=t)},d(s){s&&T(e)}}}function kn(n){let e,t,s,o,i,l,r,a,u,p,f;function g(w,B){return w[1]?vn:wn}let v=g(n),m=v(n),k=n[2]&&kt(n);return{c(){e=y("div"),t=y("input"),s=S(),o=y("button"),m.c(),l=S(),r=y("button"),a=ae("取消"),u=S(),k&&k.c(),d(t,"type","text"),d(t,"id","doc-id-input-field"),d(t,"placeholder","输入要引用的文档 ID..."),t.disabled=n[1],d(t,"class","svelte-f3rpt"),o.disabled=i=!n[0].trim()||n[1],d(o,"class","svelte-f3rpt"),r.disabled=n[1],d(r,"class","cancel-button svelte-f3rpt"),d(e,"class","add-document-input-container svelte-f3rpt")},m(w,B){R(w,e,B),h(e,t),me(t,n[0]),h(e,s),h(e,o),m.m(o,null),h(e,l),h(e,r),h(r,a),h(e,u),k&&k.m(e,null),p||(f=[P(t,"input",n[5]),P(t,"keydown",n[6]),P(o,"click",n[3]),P(r,"click",n[4])],p=!0)},p(w,[B]){B&2&&(t.disabled=w[1]),B&1&&t.value!==w[0]&&me(t,w[0]),v!==(v=g(w))&&(m.d(1),m=v(w),m&&(m.c(),m.m(o,null))),B&3&&i!==(i=!w[0].trim()||w[1])&&(o.disabled=i),B&2&&(r.disabled=w[1]),w[2]?k?k.p(w,B):(k=kt(w),k.c(),k.m(e,null)):k&&(k.d(1),k=null)},i:Z,o:Z,d(w){w&&T(e),m.d(),k&&k.d(),p=!1,fe(f)}}}function Dn(n,e,t){const s=Jt();let o="",i=!1,l="";async function r(g){var v,m,k,w;console.log(`[AddDocumentInput] Fetching title for docId: ${g}`),t(2,l=""),t(1,i=!0);try{const B=await fetch("/api/block/getBlockInfo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:g})});if(!B.ok){const q=await B.text();throw new Error(`API getBlockInfo failed (${B.status}): ${q}`)}const F=await B.json();if(F.code!==0)throw new Error(`API getBlockInfo returned error code ${F.code}: ${F.msg}`);let O=null;if((v=F.data)!=null&&v.rootTitle?O=F.data.rootTitle:(m=F.data)!=null&&m.title?O=F.data.title:(k=F.data)!=null&&k.content?O=F.data.content:(w=F.data)!=null&&w.name&&(O=F.data.name),O)return console.log(`[AddDocumentInput] Fetched title: '${O}' for ID: ${g}`),O;throw console.warn(`[AddDocumentInput] Title field (rootTitle, title, content or name) not found in getBlockInfo response for ID: ${g}. Data:`,F.data),new Error("未能从 API 响应中找到文档标题。")}catch(B){return console.error(`[AddDocumentInput] Error fetching title for ${g}:`,B),t(2,l=`获取文档标题失败 (ID: ${g}): ${B.message}`),null}finally{t(1,i=!1)}}async function a(){const g=o.trim();if(!g||i)return;const v=await r(g);v!==null?(s("addDocumentReference",{docId:g,title:v}),t(0,o="")):console.error("[AddDocumentInput] Title fetch failed, not dispatching event.")}function u(){s("cancel"),t(0,o=""),t(2,l="")}ft(()=>{const g=document.getElementById("doc-id-input-field");g==null||g.focus()});function p(){o=this.value,t(0,o)}return[o,i,l,a,u,p,g=>{g.key==="Enter"&&a(),g.key==="Escape"&&u()}]}class Cn extends nt{constructor(e){super(),tt(this,e,Dn,kn,Ke,{})}}function Dt(n,e,t){const s=n.slice();return s[8]=e[t],s}function Ct(n){let e,t,s,o,i,l=[],r=new Map,a=Le(n[1]);const u=p=>p[8].id;for(let p=0;p<a.length;p+=1){let f=Dt(n,a,p),g=u(f);r.set(g,l[p]=_t(g,f))}return{c(){e=y("span"),e.textContent="|",t=S(),s=y("span"),s.textContent="引用内容:",o=S(),i=y("div");for(let p=0;p<l.length;p+=1)l[p].c();d(e,"class","separator svelte-iusdx0"),d(s,"class","svelte-iusdx0"),d(i,"class","reference-tags svelte-iusdx0")},m(p,f){R(p,e,f),R(p,t,f),R(p,s,f),R(p,o,f),R(p,i,f);for(let g=0;g<l.length;g+=1)l[g]&&l[g].m(i,null)},p(p,f){f&6&&(a=Le(p[1]),l=pt(l,f,u,1,p,a,r,i,gt,_t,null,Dt))},d(p){p&&(T(e),T(t),T(s),T(o),T(i));for(let f=0;f<l.length;f+=1)l[f].d()}}}function _t(n,e){let t,s,o=e[8].label+"",i,l,r,a,u,p,f;function g(){return e[6](e[8])}return{key:n,first:null,c(){t=y("span"),s=y("span"),i=ae(o),l=S(),r=y("button"),r.textContent="×",a=S(),d(s,"class","tag-label svelte-iusdx0"),d(r,"class","remove-tag-button svelte-iusdx0"),d(r,"title","移除引用"),d(t,"class","reference-tag svelte-iusdx0"),d(t,"title",u=e[8].label),wt(t,"document-reference",e[8].type==="document"),this.first=t},m(v,m){R(v,t,m),h(t,s),h(s,i),h(t,l),h(t,r),h(t,a),p||(f=P(r,"click",g),p=!0)},p(v,m){e=v,m&2&&o!==(o=e[8].label+"")&&et(i,o),m&2&&u!==(u=e[8].label)&&d(t,"title",u),m&2&&wt(t,"document-reference",e[8].type==="document")},d(v){v&&T(t),p=!1,f()}}}function It(n){let e,t,s;return t=new Cn({}),t.$on("addDocumentReference",n[4]),t.$on("cancel",n[5]),{c(){e=S(),Yt(t.$$.fragment)},m(o,i){R(o,e,i),mt(t,o,i),s=!0},p:Z,i(o){s||(Se(t.$$.fragment,o),s=!0)},o(o){Xe(t.$$.fragment,o),s=!1},d(o){o&&T(e),ht(t,o)}}}function _n(n){let e,t,s,o,i,l,r,a,u=n[1].length>0&&Ct(n),p=n[0]&&It(n);return{c(){e=y("div"),t=y("button"),t.textContent="@",s=S(),u&&u.c(),o=S(),p&&p.c(),i=We(),d(t,"class","add-doc-ref-button svelte-iusdx0"),d(t,"title","通过文档 ID 添加引用"),d(e,"class","reference-context-bar svelte-iusdx0")},m(f,g){R(f,e,g),h(e,t),h(e,s),u&&u.m(e,null),R(f,o,g),p&&p.m(f,g),R(f,i,g),l=!0,r||(a=P(t,"click",n[3]),r=!0)},p(f,[g]){f[1].length>0?u?u.p(f,g):(u=Ct(f),u.c(),u.m(e,null)):u&&(u.d(1),u=null),f[0]?p?(p.p(f,g),g&1&&Se(p,1)):(p=It(f),p.c(),Se(p,1),p.m(i.parentNode,i)):p&&(pn(),Xe(p,1,1,()=>{p=null}),mn())},i(f){l||(Se(p),l=!0)},o(f){Xe(p),l=!1},d(f){f&&(T(e),T(o),T(i)),u&&u.d(),p&&p.d(f),r=!1,a()}}}function In(n,e,t){let s;qt(n,re,f=>t(1,s=f));const o=Jt();let i=!1;function l(f){re.update(g=>g.filter(v=>v.id!==f))}function r(){console.log("[ReferenceContext] toggleAddDocInput called. Current showAddDocInput:",i),t(0,i=!i),console.log("[ReferenceContext] New showAddDocInput:",i)}function a(f){t(0,i=!1),o("addDocumentReference",f.detail)}function u(){t(0,i=!1)}return[i,s,l,r,a,u,f=>l(f.id)]}class En extends nt{constructor(e){super(),tt(this,e,In,_n,Ke,{})}}const{Map:zt}=cn;function Et(n,e,t){const s=n.slice();return s[54]=e[t],s}function At(n,e,t){const s=n.slice();return s[57]=e[t],s}function St(n){let e,t,s;return{c(){e=y("button"),e.textContent="保存当前对话",d(e,"class","b3-button b3-button--outline svelte-6byjk")},m(o,i){R(o,e,i),t||(s=P(e,"click",n[13]),t=!0)},p:Z,d(o){o&&T(e),t=!1,s()}}}function Ft(n){let e;function t(i,l){return i[5].length>0?Sn:An}let s=t(n),o=s(n);return{c(){e=y("div"),o.c(),d(e,"class","history-list svelte-6byjk")},m(i,l){R(i,e,l),o.m(e,null)},p(i,l){s===(s=t(i))&&o?o.p(i,l):(o.d(1),o=s(i),o&&(o.c(),o.m(e,null)))},d(i){i&&T(e),o.d()}}}function An(n){let e;return{c(){e=y("div"),e.textContent="没有已保存的对话",d(e,"class","history-item-empty svelte-6byjk")},m(t,s){R(t,e,s)},p:Z,d(t){t&&T(e)}}}function Sn(n){let e=[],t=new zt,s,o=Le(n[5]);const i=r=>r[57].id;for(let r=0;r<o.length;r+=1){let a=At(n,o,r),u=i(a);t.set(u,e[r]=Bt(u,a))}let l=null;return o.length||(l=Tt()),{c(){for(let r=0;r<e.length;r+=1)e[r].c();s=We(),l&&l.c()},m(r,a){for(let u=0;u<e.length;u+=1)e[u]&&e[u].m(r,a);R(r,s,a),l&&l.m(r,a)},p(r,a){a[0]&49312&&(o=Le(r[5]),e=pt(e,a,i,1,r,o,t,s.parentNode,gt,Bt,s,At),!o.length&&l?l.p(r,a):o.length?l&&(l.d(1),l=null):(l=Tt(),l.c(),l.m(s.parentNode,s)))},d(r){r&&T(s);for(let a=0;a<e.length;a+=1)e[a].d(r);l&&l.d(r)}}}function Tt(n){let e;return{c(){e=y("div"),e.textContent="没有已保存的对话",d(e,"class","history-item-empty svelte-6byjk")},m(t,s){R(t,e,s)},p:Z,d(t){t&&T(e)}}}function Bt(n,e){let t,s,o=e[57].name+"",i,l,r,a,u,p;function f(){return e[26](e[57])}function g(...v){return e[27](e[57],...v)}return{key:n,first:null,c(){t=y("div"),s=y("span"),i=ae(o),l=S(),r=y("button"),r.textContent="×",a=S(),d(s,"class","history-item-name svelte-6byjk"),d(s,"title","加载此对话"),d(r,"class","history-item-delete svelte-6byjk"),d(r,"title","删除此对话"),d(t,"class","history-item svelte-6byjk"),this.first=t},m(v,m){R(v,t,m),h(t,s),h(s,i),h(t,l),h(t,r),h(t,a),u||(p=[P(s,"click",f),P(r,"click",g)],u=!0)},p(v,m){e=v,m[0]&32&&o!==(o=e[57].name+"")&&et(i,o)},d(v){v&&T(t),u=!1,fe(p)}}}function Mt(n){let e,t,s;return{c(){e=y("button"),e.textContent="删除当前",d(e,"class","b3-button b3-button--error svelte-6byjk"),d(e,"title","删除当前对话")},m(o,i){R(o,e,i),t||(s=P(e,"click",n[28]),t=!0)},p:Z,d(o){o&&T(e),t=!1,s()}}}function Fn(n){let e,t=(n[54].html||n[54].content)+"",s;return{c(){e=y("div"),d(e,"class","message ai svelte-6byjk"),d(e,"data-message-id",s=n[54].id)},m(o,i){R(o,e,i),e.innerHTML=t},p(o,i){i[0]&2&&t!==(t=(o[54].html||o[54].content)+"")&&(e.innerHTML=t),i[0]&2&&s!==(s=o[54].id)&&d(e,"data-message-id",s)},d(o){o&&T(e)}}}function Tn(n){let e,t,s=n[54].content.replace(/\n/g,"<br/>")+"",o;return{c(){e=y("div"),t=y("div"),d(t,"class","svelte-6byjk"),d(e,"class","message user svelte-6byjk"),d(e,"data-message-id",o=n[54].id)},m(i,l){R(i,e,l),h(e,t),t.innerHTML=s},p(i,l){l[0]&2&&s!==(s=i[54].content.replace(/\n/g,"<br/>")+"")&&(t.innerHTML=s),l[0]&2&&o!==(o=i[54].id)&&d(e,"data-message-id",o)},d(i){i&&T(e)}}}function Rt(n,e){let t,s;function o(r,a){if(r[54].role==="user")return Tn;if(r[54].role==="assistant")return Fn}let i=o(e),l=i&&i(e);return{key:n,first:null,c(){t=We(),l&&l.c(),s=We(),this.first=t},m(r,a){R(r,t,a),l&&l.m(r,a),R(r,s,a)},p(r,a){e=r,i===(i=o(e))&&l?l.p(e,a):(l&&l.d(1),l=i&&i(e),l&&(l.c(),l.m(s.parentNode,s)))},d(r){r&&(T(t),T(s)),l&&l.d(r)}}}function xt(n){let e;return{c(){e=y("div"),e.innerHTML='<p class="svelte-6byjk">AI 正在思考...</p>',d(e,"class","message ai loading svelte-6byjk")},m(t,s){R(t,e,s)},d(t){t&&T(e)}}}function $t(n){let e,t,s,o,i,l,r;return{c(){e=y("div"),t=y("ul"),s=y("li"),s.textContent="复制",o=S(),i=y("li"),i.textContent="删除",d(s,"class","svelte-6byjk"),d(i,"class","svelte-6byjk"),d(t,"class","svelte-6byjk"),d(e,"class","context-menu svelte-6byjk"),Ve(e,"top",n[9]+"px"),Ve(e,"left",n[10]+"px")},m(a,u){R(a,e,u),h(e,t),h(t,s),h(t,o),h(t,i),l||(r=[P(s,"click",n[21]),P(i,"click",n[22])],l=!0)},p(a,u){u[0]&512&&Ve(e,"top",a[9]+"px"),u[0]&1024&&Ve(e,"left",a[10]+"px")},d(a){a&&T(e),l=!1,fe(r)}}}function Bn(n){let e,t,s,o,i=x(n[11]).length>1&&!n[0]&&!n[4],l,r,a,u,p=n[7]?"▲":"▼",f,g,v,m,k,w=[],B=new zt,F,O,q,J,G,_,V,$,ee,he,be,te,K,j,ue,de,je,Ue,U=i&&St(n),Q=n[7]&&Ft(n),Y=n[0]&&Mt(n),Fe=Le(n[1]);const Ge=D=>D[54].id;for(let D=0;D<Fe.length;D+=1){let L=Et(n,Fe,D),ye=Ge(L);B.set(ye,w[D]=Rt(ye,L))}let ne=n[4]&&xt();q=new En({}),q.$on("addDocumentReference",n[17]);let H=n[8]&&$t(n);return{c(){e=y("div"),t=y("div"),s=y("button"),s.textContent="新建对话",o=S(),U&&U.c(),l=S(),r=y("div"),a=y("button"),u=ae("📜 加载历史对话 "),f=ae(p),g=S(),Q&&Q.c(),v=S(),Y&&Y.c(),m=S(),k=y("div");for(let D=0;D<w.length;D+=1)w[D].c();F=S(),ne&&ne.c(),O=S(),Yt(q.$$.fragment),J=S(),G=y("div"),_=y("textarea"),V=S(),$=y("button"),ee=ae("发送"),be=S(),te=y("button"),K=ae("引用选区"),ue=S(),H&&H.c(),d(s,"class","b3-button svelte-6byjk"),d(a,"title","加载或删除历史对话"),d(a,"class","svelte-6byjk"),d(r,"class","history-dropdown svelte-6byjk"),d(t,"class","conversation-controls svelte-6byjk"),d(k,"class","chat-history svelte-6byjk"),d(_,"placeholder","在此输入您的问题或指令..."),d(_,"rows","3"),_.disabled=n[4],d(_,"class","svelte-6byjk"),$.disabled=he=!n[2].trim()||n[4],d($,"class","svelte-6byjk"),d(te,"class","add-reference-button svelte-6byjk"),d(te,"title","添加当前选中文本作为引用"),te.disabled=j=!n[6]||n[4],d(G,"class","input-area svelte-6byjk"),d(e,"class","ai-chat-panel svelte-6byjk")},m(D,L){R(D,e,L),h(e,t),h(t,s),h(t,o),U&&U.m(t,null),h(t,l),h(t,r),h(r,a),h(a,u),h(a,f),h(r,g),Q&&Q.m(r,null),h(t,v),Y&&Y.m(t,null),h(e,m),h(e,k);for(let ye=0;ye<w.length;ye+=1)w[ye]&&w[ye].m(k,null);h(k,F),ne&&ne.m(k,null),n[29](k),h(e,O),mt(q,e,null),h(e,J),h(e,G),h(G,_),me(_,n[2]),h(G,V),h(G,$),h($,ee),h(G,be),h(G,te),h(te,K),h(e,ue),H&&H.m(e,null),de=!0,je||(Ue=[P(s,"click",n[12]),P(a,"click",n[19]),P(k,"contextmenu",n[20]),P(_,"input",n[30]),P(_,"keydown",n[31]),P($,"click",n[16]),P(te,"click",n[18])],je=!0)},p(D,L){L[0]&17&&(i=x(D[11]).length>1&&!D[0]&&!D[4]),i?U?U.p(D,L):(U=St(D),U.c(),U.m(t,l)):U&&(U.d(1),U=null),(!de||L[0]&128)&&p!==(p=D[7]?"▲":"▼")&&et(f,p),D[7]?Q?Q.p(D,L):(Q=Ft(D),Q.c(),Q.m(r,null)):Q&&(Q.d(1),Q=null),D[0]?Y?Y.p(D,L):(Y=Mt(D),Y.c(),Y.m(t,null)):Y&&(Y.d(1),Y=null),L[0]&2&&(Fe=Le(D[1]),w=pt(w,L,Ge,1,D,Fe,B,k,gt,Rt,F,Et)),D[4]?ne||(ne=xt(),ne.c(),ne.m(k,null)):ne&&(ne.d(1),ne=null),(!de||L[0]&16)&&(_.disabled=D[4]),L[0]&4&&me(_,D[2]),(!de||L[0]&20&&he!==(he=!D[2].trim()||D[4]))&&($.disabled=he),(!de||L[0]&80&&j!==(j=!D[6]||D[4]))&&(te.disabled=j),D[8]?H?H.p(D,L):(H=$t(D),H.c(),H.m(e,null)):H&&(H.d(1),H=null)},i(D){de||(Se(q.$$.fragment,D),de=!0)},o(D){Xe(q.$$.fragment,D),de=!1},d(D){D&&T(e),U&&U.d(),Q&&Q.d(),Y&&Y.d();for(let L=0;L<w.length;L+=1)w[L].d();ne&&ne.d(),n[29](null),ht(q),H&&H.d(),je=!1,fe(Ue)}}}const Ee="activeUnsavedConversation",Mn=1500;function Rn(n){console.log("DEBUG: Blocks received by formatBlocksForAI (after deep copy):"),console.table(n);const e=n.filter(o=>o.depth>0);if(e.length===0)return console.log("No content blocks (depth > 0) found after filtering."),`Current Document Context (Structured with IDs and Hierarchy):
[No content blocks found]
--- End of Document Context ---`;const t=e.map(o=>{const i="  ".repeat(o.depth-1);let l="";o.type==="i"&&o.content?l=o.content:l=o.markdown||o.content||"";const r=l.replace(/\s*$/,"");let a=`${i}--- Block (ID: ${o.id}, Type: ${o.type}) ---
`;return r?a+=r.split(`
`).map(u=>`${i}${u}`).join(`
`)+`
`:a+=`${i}[Empty Block Content]
`,a});let s=`Current Document Context (Structured with IDs and Hierarchy):
`;return s+=t.join(""),s+="--- End of Document Context ---",console.log("DEBUG: Formatted context string JUST BEFORE RETURN from formatBlocksForAI (using map/join):"),console.log(s.substring(0,500)+"..."),s}async function xn(n){if(!n||n.length===0)return"";console.log(`[getReferencedBlocksContext] Fetching context for specific block IDs: ${n.join(", ")}`);try{const t=`SELECT id, type, markdown FROM blocks WHERE id IN (${n.map(a=>`'${a}'`).join(", ")})`;console.log(`[getReferencedBlocksContext] Executing SQL: ${t}`);const s=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:t})});if(!s.ok){const a=await s.text();throw new Error(`SQL query for references failed with status ${s.status}: ${a}`)}const o=await s.json();if(o.code!==0)throw new Error(`API returned error code ${o.code} for references: ${o.msg}`);if(!o.data||!Array.isArray(o.data))return console.log("No block data returned for referenced IDs."),"Could not retrieve content for referenced blocks.";console.log("[getReferencedBlocksContext] Raw SQL query result data for references:",o.data);const i=new Map(o.data.map(a=>[a.id,a])),l=n.map(a=>i.get(a)).filter(Boolean);let r=`Referenced content:
`;return l.forEach((a,u)=>{r+=`--- Referenced Block ${u+1} (ID: ${a.id}, Type: ${a.type}) ---
${a.markdown||"[Block content not directly in markdown field]"}

`}),r+="--- End of Referenced Blocks ---",console.log("[getReferencedBlocksContext] Formatted referenced context string:",r),r}catch(e){return console.error("[getReferencedBlocksContext] Error fetching or processing referenced block context:",e),`Error retrieving referenced content: ${e.message}`}}async function $n(n){var e,t;console.log(`[Context Fetch] Attempting to get Markdown for referenced document ID: ${n}`);try{console.log(`[Context Fetch] Trying /api/block/getBlockMarkdown for ${n}...`);const s=await fetch("/api/block/getBlockMarkdown",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n})});if(s.ok){const o=await s.json();if(o.code===0&&((e=o.data)!=null&&e.markdown))return console.log(`[Context Fetch] Success via /api/block/getBlockMarkdown for doc ID ${n}. Length: ${o.data.markdown.length}`),o.data.markdown;console.warn(`[Context Fetch] /api/block/getBlockMarkdown returned success code but no markdown data for doc ID ${n}. Result:`,o)}else console.warn(`[Context Fetch] /api/block/getBlockMarkdown failed (${s.status}) for doc ID ${n}.`)}catch(s){console.error(`[Context Fetch] Error calling /api/block/getBlockMarkdown for ${n}:`,s)}console.log(`[Context Fetch] Fallback: Trying /api/export/exportMdContent for ${n}...`);try{const s=await fetch("/api/export/exportMdContent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:n})});if(!s.ok){const i=await s.text();throw new Error(`Fallback API /api/export/exportMdContent failed (${s.status}): ${i}`)}const o=await s.json();if(o.code===0&&((t=o.data)!=null&&t.content))return console.log(`[Context Fetch] Success via FALLBACK /api/export/exportMdContent for doc ID ${n}. Length: ${o.data.content.length}`),o.data.content;throw new Error(`Fallback API /api/export/exportMdContent returned error code ${o.code} or no content: ${o.msg||"No content found"}`)}catch(s){return console.error(`[Context Fetch] Error calling FALLBACK /api/export/exportMdContent for ${n}:`,s),null}}function Nt(n){if(!n)return null;if(n instanceof HTMLElement&&n.dataset.nodeId)return n;const e=n.parentElement;return e instanceof HTMLElement&&e.dataset.nodeId?e:n instanceof Element?n.closest("[data-node-id]"):e==null?void 0:e.closest("[data-node-id]")}function Nn(){var g,v,m;console.groupCollapsed("[getSelectedBlockIds] Check");const n=window.getSelection();if(!n||n.rangeCount===0||n.isCollapsed||!n.anchorNode||!n.focusNode)return console.log("No valid selection found."),console.groupEnd(),[];const e=n.getRangeAt(0);console.log("Selection range:",e),console.log("Start Container:",e.startContainer,"Offset:",e.startOffset),console.log("End Container:",e.endContainer,"Offset:",e.endOffset);const t=e.startContainer,s=(g=t instanceof Node&&t.nodeType===Node.ELEMENT_NODE?t:t.parentElement)==null?void 0:g.closest(".protyle-wysiwyg");if(!s)return console.log("Selection is not inside a protyle editor."),console.groupEnd(),[];console.log("Selection is inside editor:",s);const o=Nt(e.startContainer),i=Nt(e.endContainer);if(console.log("Found start block node:",(v=o==null?void 0:o.dataset)==null?void 0:v.nodeId,o),console.log("Found end block node:",(m=i==null?void 0:i.dataset)==null?void 0:m.nodeId,i),!o&&!i)return console.log("Neither start nor end of selection is inside a block."),console.groupEnd(),[];if(o&&o===i)return console.log("Selection within single block:",o.dataset.nodeId),console.groupEnd(),[o.dataset.nodeId];const l=Array.from(s.querySelectorAll("[data-node-id]"));console.log("All blocks in editor:",l.map(k=>k.dataset.nodeId));const r=[],a=o,u=i;let p=a?l.findIndex(k=>k===a):-1,f=u?l.findIndex(k=>k===u):-1;if(console.log(`Calculated indices: Start=${p}, End=${f}`),p===-1||f===-1)return console.warn("Could not reliably determine selection range indices within editor blocks. Returning found blocks only."),o!=null&&o.dataset.nodeId&&r.push(o.dataset.nodeId),i!=null&&i.dataset.nodeId&&i!==o&&r.push(i.dataset.nodeId),console.log("Final selected block IDs (fallback):",r),console.groupEnd(),Array.from(new Set(r));p>f&&([p,f]=[f,p],console.log("Swapped indices"));for(let k=p;k<=f;k++){const w=l[k];w!=null&&w.dataset.nodeId&&r.push(w.dataset.nodeId)}return console.log("Final selected block IDs:",r),console.groupEnd(),Array.from(new Set(r))}function On(n,e,t){let s,{pluginData:o}=e,{initialActiveMessages:i=null}=e,l=Pe([]);qt(n,l,c=>t(1,s=c));let r="",a,u=!1,p,f=[],g=null,v=null,m="",k=[],w=!1,B=null,F=!1,O=null,q=!1,J=0,G=0,_=null;const V=Ze.subscribe(c=>{p=c}),$=Oe.subscribe(c=>{t(5,f=c.sort((b,C)=>C.timestamp-b.timestamp))}),ee=ze.subscribe(c=>{v=c}),he=Qe.subscribe(c=>{});re.subscribe(c=>{}),ft(async()=>{if(console.log("[onMount] Component mounted. Initial active messages prop:",JSON.stringify(i)),i&&i.length>1)console.log("[onMount] Loading persisted active conversation state."),l.set(i.map(c=>({...c,html:c.role==="assistant"?ce(c.content):void 0}))),t(0,g=null),i.length;else{console.log("[onMount] No persisted active state found or invalid, starting fresh.");const c="有什么可以帮您？";l.set([{id:Date.now().toString()+"init",role:"assistant",content:c,html:ce(c)}]),t(0,g=null)}await Me(),U(),document.addEventListener("selectionchange",Y)}),dn(()=>{if(O&&(clearTimeout(O),console.log("[onDestroy] Cleared pending debounced active state save.")),g===null&&x(l).length>1){console.log("[onDestroy] Attempting final save of active conversation state...");const c=x(l);console.log(`[onDestroy] Final save data (${c.length} messages):`,JSON.stringify(c)),o.saveData(Ee,c).then(()=>console.log("[onDestroy] Final active state save attempt finished.")).catch(b=>console.error("[onDestroy] Error during final active state save:",b))}else console.log("[onDestroy] Clearing active conversation state as it was saved or empty."),o.saveData(Ee,null).catch(c=>console.error("[onDestroy] Error clearing active state on destroy:",c));!g&&x(l).length>1&&(console.log("[onDestroy] Auto-saving current unsaved conversation..."),te()),V(),$(),ee(),he(),document.removeEventListener("selectionchange",Y),H()});async function be(){console.log("[newConversation] Starting new conversation.");const c="新对话已开始，有什么可以帮您？",b=ce(c);l.set([{id:Date.now().toString()+"init-new",role:"assistant",content:c,html:b}]),t(0,g=null),t(2,r=""),await ot(),t(4,u=!1),m="",t(6,w=!1),console.log("[newConversation] Reset isLoading to false."),await Me(),U()}async function te(){if(u||x(l).length<=1||g){console.log("[saveCurrent] Conditions not met (loading, empty, or already saved). Skipping.");return}console.log("[saveCurrent] Saving current conversation...");const c=Date.now(),b=c.toString(),C=`对话 ${new Date(c).toLocaleString()}`,E={id:b,name:C,timestamp:c,messages:x(l).filter(N=>N.role==="user"||N.role==="assistant").map(({role:N,content:z})=>({role:N,content:z}))};Oe.update(N=>[E,...N.sort((z,ke)=>ke.timestamp-z.timestamp)]),t(0,g=b),await ot(),console.log("[saveCurrent] Conversation saved with ID:",b,"and active state cleared.")}async function K(c){if(g===null&&x(l).length>1&&!u){console.log("[loadConversation] Current conversation is unsaved. Auto-saving before loading...");try{await te(),console.log("[loadConversation] Auto-save successful.")}catch(C){console.error("[loadConversation] Error auto-saving current conversation:",C),m="自动保存当前对话失败，但仍将尝试加载历史对话。"}}const b=x(Oe).find(C=>C.id===c);b?(console.log("[loadConversation] Loading conversation:",c),l.set(b.messages.map((C,E)=>({...C,id:`${c}-${E}`,html:C.role==="assistant"?ce(C.content):void 0}))),t(0,g=b.id),x(l).length,t(2,r=""),ot(),Me().then(U),console.log("[loadConversation] Conversation loaded, active state cleared."),t(4,u=!1),m="",t(6,w=!1),console.log("[loadConversation] Reset isLoading to false after load.")):(console.error("[loadConversation] Conversation with ID not found:",c),t(4,u=!1),m=`加载对话失败：未找到 ID ${c}`)}async function j(c,b){if(b.stopPropagation(),confirm("确定要删除这个对话吗？")){const C=f.filter(E=>E.id!==c);await o.saveConversations(C),g===c&&be(),console.log("Conversation deleted:",c)}}async function ue(c){if(!c)return console.warn("getStructuredDocumentContext called with no docId."),null;console.log(`Attempting to get visual structure using /api/filetree/getDoc for ID: ${c}`);try{let b=function(W,le){for(const ie of Array.from(W.children)){const I=ie.getAttribute("data-node-id");I&&ie.tagName==="DIV"&&ie.hasAttribute("data-type")&&(De.push({id:I,depth:le}),b(ie,le+1))}};const C=await fetch("/api/filetree/getDoc",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c})});if(!C.ok){console.error(`Error fetching /api/filetree/getDoc: ${C.status} ${C.statusText}`);const W=await C.text();return console.error("Error response body:",W),null}const E=await C.json();if(console.log("DEBUG: Full response data from /api/filetree/getDoc:"),console.dir(E.data,{depth:null}),!E||E.code!==0||!E.data)return console.error("API call /api/filetree/getDoc did not return successful data:",E),null;const N=E.data.content;if(!N||typeof N!="string")return console.error("/api/filetree/getDoc response data.content is missing or not a string."),null;const He=new DOMParser().parseFromString(N,"text/html").body,De=[];if(b(He,1),console.log("DEBUG: Extracted visual block info (ID and Depth):"),console.table(De),De.length===0)return console.warn("No block IDs extracted from the parsed HTML."),"[Context Generation Failed: Could not extract block info from HTML]";const Te=De.map(W=>W.id);let Be={};if(Te.length>0)try{const le=`SELECT id, markdown, type FROM blocks WHERE id IN (${Te.map(A=>`'${A}'`).join(", ")})`;console.log(`Executing SQL to fetch block content: ${le}`);const ie=await fetch("/api/query/sql",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stmt:le})});if(!ie.ok){const A=await ie.text();throw new Error(`SQL query for content failed (${ie.status}): ${A}`)}const I=await ie.json();if(I.code!==0)throw new Error(`API returned error code ${I.code}: ${I.msg}`);I.data&&Array.isArray(I.data)&&I.data.forEach(A=>{Be[A.id]={markdown:A.markdown||"",type:A.type||"unknown"}}),console.log("Fetched block content data map:",Be)}catch(W){console.error("Error fetching block content:",W),m=`获取块内容时出错: ${W.message}`}const Ce=De.map(W=>{const le=Be[W.id]||{markdown:`[Content Fetch Failed for ${W.id}]`,type:"[fetch failed]"};return{id:W.id,markdown:le.markdown,type:le.type,depth:W.depth}}),st=Rn(Ce);return console.log("Formatted context using visual order (placeholder content):",st.substring(0,500)+"..."),st}catch(b){return console.error("Error in getStructuredDocumentContext processing /api/filetree/getDoc response:",b),null}}async function de(c){console.log(`Attempting to delete block: ${c}`);try{const b=await fetch("/api/block/deleteBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:c})});if(!b.ok){const E=await b.text();throw new Error(`API deleteBlock failed (${b.status}): ${E}`)}const C=await b.json();if(C.code!==0)throw new Error(`API deleteBlock returned error code ${C.code}: ${C.msg}`);console.log(`Block ${c} deleted successfully.`)}catch(b){throw console.error(`Error executing deleteBlock for ${c}:`,b),m=`删除块 ${c} 失败: ${b.message}`,b}}async function je(c,b,C){console.log(`Attempting to insert block after ${c||"start"} with parent ${C||"unknown"}, content:
${b}`);const E={dataType:"markdown",data:b};c!==null?E.previousID=c:(C!==null&&(E.parentID=C),E.previousID="");try{console.log("Executing insert with payload:",E);const N=await fetch("/api/block/insertBlock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(E)});if(!N.ok){const ke=await N.text();throw new Error(`API Error (${N.status}): ${ke}`)}const z=await N.json();if(z.code!==0)throw new Error(`API returned error code ${z.code}: ${z.msg}`);console.log(`Block inserted successfully after ${c||"start"}.`)}catch(N){throw console.error("Error executing insert block command:",N),m=`插入块失败: ${N.message}`,N}}async function Ue(){const c=r.trim();if(!c||u)return;m="",t(4,u=!0),console.log("[sendMessage] Set isLoading to true.");const b=c.match(/^(删除|修改)选区(\d+)$/i);let C=!1;if(b){const I=b[1],A=parseInt(b[2],10);console.log(`[Frontend Command] Matched: action=${I}, index=${A}`);const ge=x(re);console.log("[Frontend Command] Current references in store:",JSON.stringify(ge,null,2));const se=ge.filter(pe=>pe.type==="selection");if(console.log("[Frontend Command] Filtered selection references:",JSON.stringify(se,null,2)),A>0&&A<=se.length){const pe=se[A-1];console.log(`[Frontend Command] Target reference (at index ${A-1}):`,JSON.stringify(pe,null,2));const we=pe.blockIds;if(console.log(`[Frontend Command] Target Block IDs for ${I}:`,JSON.stringify(we)),I.toLowerCase()==="删除")try{for(const M of we)await de(M);const Ie=Date.now().toString()+"fe-del";l.update(M=>[...M,{id:Ie,role:"assistant",content:`已执行删除选区 ${A} (块: ${we.join(", ")}) 的操作。`,html:ce(`已执行删除选区 **${A}** (块: ${we.join(", ")}) 的操作。`)}]),l.set([...x(l)]);const X=pe.id;console.log(`[Frontend Command] Removing reference with ID: ${X}`),re.update(M=>{const oe=M.filter(ve=>ve.id!==X);return console.log("[Frontend Command] References after removal:",JSON.stringify(oe,null,2)),oe}),C=!0}catch(Ie){console.error("[Frontend Command] Error executing frontend delete command:",Ie),m=`执行删除选区 ${A} 失败: ${Ie.message}`,C=!0}else I.toLowerCase()==="修改"&&(console.log("Frontend modification command recognized, but not fully implemented."),m='通过 "修改选区N" 指令修改内容的功能尚未完全实现。请尝试选中内容后，直接向 AI 提出修改要求。',C=!0)}else console.warn(`[Frontend Command] Invalid index ${A} for ${se.length} selection references.`),m=`无效的选区编号: ${A}。请确保编号在 1 到 ${se.length} 之间。`,C=!0}if(C){t(2,r=""),t(4,u=!1),await Me(),U();return}const N={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"user",content:c};l.update(I=>[...I,N]),l.set([...x(l)]),console.log("User message added to store:",x(l)),t(2,r=""),await Me(),U();let z=await ue(v),ke="",He="";const De=x(re),Te=De.filter(I=>I.type==="selection");if(Te.length>0){const I=Te.flatMap(A=>A.blockIds);ke=await xn(I)}const Be=De.filter(I=>I.type==="document");if(Be.length>0){let I=`

--- Referenced Documents ---
`;for(const A of Be){const ge=A.blockIds[0],se=await $n(ge);se?I+=`
--- Document: ${A.label} (ID: ${ge}) ---
${se}
---;
`:I+=`
--- Document: ${A.label} (ID: ${ge}) --- (Content not available) ---;
`}He=I}let Ce=z?`--- Current Document Context ---
${z}`:"No current document context available.";ke&&(Ce+=ke),He&&(Ce+=He),console.log("Combined context string prepared for system prompt (length:",Ce.length,"):",Ce.substring(0,500)+"...");const W=x(l).filter(I=>I.role==="user"||I.role==="assistant").slice(-20).map(I=>({role:I.role,content:I.content}));let le='You are a helpful AI assistant integrated into Siyuan Note.\\n\\nYou can interact with the document content based on the provided context.\\n\\n**Understanding the Context:**\\nThe context below shows the structure and content of the current document or specific blocks selected by the user.\\n\\n**CRITICAL: The blocks are presented in their exact hierarchical order as they appear in the document. Indentation signifies nesting depth. You MUST rely SOLELY on this order and indentation to understand the document structure. DO NOT infer order from block IDs or timestamps.**\\n\\nEach block is clearly marked like this:\\n--- Block (ID: yyyy-mmdd-xxxxxx, Type: p) ---\\n[Markdown content of the block]\\n---\\n(Referenced blocks, if any, will be listed under \\"Referenced content:\\")\\n\\n**Performing Actions (Delete/Insert):**\\nWhen the user asks you to modify the document:\\n1. Carefully identify the **exact block ID(s)** from the context that corresponds to the user\'s request, using the provided order and structure.\\n2. Output **one or more** JSON command blocks using ONLY the following formats. **You MUST use the specific block ID(s) found in the context.**\\n\n   *   To delete a block: \\`\\`\\`json\\n{\\"action\\": \\"delete\\", \\"block_id\\": \\"TARGET_BLOCK_ID_FROM_CONTEXT\\"}\\n\\`\\`\\`\\n   *   To insert a new block: \\`\\`\\`json\\n{\\"action\\": \\"insert\\", \\"previousID\\": \\"ID_OF_BLOCK_TO_INSERT_AFTER\\", \\"parentID\\": null, \\"markdown\\": \\"NEW_MARKDOWN_CONTENT\\"}\\n\\`\\`\\` (Use the ID of the block you want to insert *after* as previousID. parentID is usually null.)\\n\\n**IMPORTANT RULES:**\\n*   **Multiple Commands:** You CAN output multiple \\`delete\\` and \\`insert\\` commands in a single response.\\n*   **Action Intent:** Determine the user\'s core goal: delete or insert new content.\\n*   **Handling Multi-Block References (e.g., \\"Selection 1\\"):**\\n    *   **Information Requests:** Summarize/address ALL associated blocks.\\n    *   **Action Requests (Delete):** Issue one \\`delete\\` command for **EACH** block ID in the reference.\\n    *   **Action Requests (Modify):** \\n        1. Issue one \\`delete\\` command for **EACH** block ID in the reference.\\n        2. Issue **ONE** \\`insert\\` command containing the **ENTIRE** modified content.\\n        3. The \\`previousID\\` for this insert command **MUST** be the ID of the block immediately **PRECEDING** the **FIRST** block of the selection (use context order). If the selection starts at the very beginning, \\`previousID\\` might be empty or require parent ID handling (ask if unsure about this specific edge case).\\n    *   **Action Requests (Insert AFTER selection):** \\n        1. Issue **ONE** \\`insert\\` command containing the **ENTIRE** new content.\\n        2. The \\`previousID\\` for this insert command **MUST** be the ID of the **LAST** block in the selection (use context order).\\n    *   **Action Requests (Insert BEFORE selection):** \\n        1. Issue **ONE** \\`insert\\` command containing the **ENTIRE** new content.\\n        2. The \\`previousID\\` for this insert command **MUST** be the ID of the block immediately **PRECEDING** the **FIRST** block of the selection (use context order).\\n*   **Single Block Modification:** Still performed as delete-then-insert. The \\`previousID\\` for the insert is the ID of the block preceding the deleted one.\\n*   **Insert Command - Target Location Rules (Single Block Relative):**\\n    *   **Goal: Insert AFTER Block A?** Set \\\'previousID\\\' = \\\'BLOCK_A_ID\\\'.\\n    *   **Goal: Insert BEFORE Block B?** Find Block B-1 preceding Block B using context order. Set \\\'previousID\\\' = \\\'BLOCK_B_minus_1_ID\\\'.\\n    *   **NO FUZZY LOCATIONS:** \\"insert at beginning/end/here\\" are NOT directly supported *unless* clearly referring to the start/end of a known multi-block selection (handled above) or the entire document. If ambiguous for single block, ask for relative ID.\\n*   **Referenced Context Priority:** If \\\'Referenced content\\\' exists and the user refers to it, use IDs from THAT section.\\n*   **Use Exact IDs:** Always use the exact \\`ID: yyyy-mmdd-xxxxxx\\` from the context.\\n*   **Ask If Unsure (Ambiguity):** If ambiguous about the **target block(s)** (e.g., \\"that paragraph\\") or the **exact insertion point relative to a single block** (e.g., \\"insert near the start\\"), or if required preceding IDs cannot be found, MUST ask user for clarification. **Do NOT ask just because a target is a known multi-block selection.**\\n*   **Normal Chat:** For non-modification requests, respond normally without JSON command blocks.\\n\\n--- Context Starts Below:';Ce&&(le+=`

${Ce}`);const ie=[{role:"system",content:le},...W];console.log(`DEBUG: Final System Prompt Content Sent to AI:
`,le),console.log("Messages being sent to API (final format):",ie);try{const I=await yn(ie,p);let A=0,ge=I;const se=/```json\n({.*?})\n```/gs;let pe;const we=[];for(;(pe=se.exec(I))!==null;)if(pe[1])try{const X=pe[1],M=JSON.parse(X);we.push(M)}catch(X){console.error("Failed to parse command JSON:",X,"Raw content:",pe[1])}if(console.log("Found commands to execute:",we),we.length>0){let X=[];for(const M of we)try{if(console.log("Executing command:",M),M.action==="delete"&&M.block_id){await de(M.block_id),A++;const oe=Date.now().toString()+`cmd-del-${A}`;X.push({id:oe,role:"assistant",content:`已执行删除块 ${M.block_id} 的操作。`,html:ce(`已执行删除块 **${M.block_id}** 的操作。`)})}else if(M.action==="insert"&&typeof M.markdown=="string"&&(typeof M.previousID=="string"||typeof M.parentID=="string"&&M.parentID!=="")){const oe=M.previousID===""?null:M.previousID,ve=M.parentID||null;await je(oe,M.markdown,ve),A++;const on=Date.now().toString()+`cmd-ins-${A}`,bt=oe?`块 ${oe} 之后`:ve?`文档 ${ve} 开头`:"文档开头";X.push({id:on,role:"assistant",content:`已在 ${bt} 插入新块。`,html:ce(`已在 **${bt}** 插入新块。`)})}else console.warn("Parsed command JSON has invalid action (only delete/insert supported) or missing/invalid parameters:",M)}catch(oe){console.error(`Error executing command: ${JSON.stringify(M)}`,oe);const ve=Date.now().toString()+`cmd-err-${A}`;X.push({id:ve,role:"assistant",content:`执行命令 ${M.action} 失败: ${oe.message}`,html:ce(`执行命令 **${M.action}** 失败: ${oe.message}`)})}X.length>0&&(l.update(M=>[...M,...X]),l.set([...x(l)]))}const Ie=I.replace(se,"").trim();if(A===0||Ie.length>0){const X=A>0?Ie:ge;if(X.length>0){const oe={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:X,html:ce(X)};l.update(ve=>[...ve,oe]),l.set([...x(l)]),console.log("Assistant message (non-command part or original) added to store:",x(l))}}}catch(I){console.error("Error fetching chat completion:",I),m=`AI 请求失败: ${I.message}`;const ge={id:Date.now().toString()+Math.random().toString(36).substring(2,9),role:"assistant",content:`抱歉，请求出错: ${m}`,html:ce(`抱歉，请求出错: ${m}`)};l.update(se=>[...se,ge]),l.set([...x(l)]),console.log("Error message added to store:",x(l))}finally{t(4,u=!1),+console.log("[sendMessage] Set isLoading to false in finally block."),!C&&Te.length>0&&(console.log("Clearing selection references after AI call."),re.update(I=>I.filter(A=>A.type!=="selection"))),await Me(),U()}}function U(){a&&requestAnimationFrame(()=>{t(3,a.scrollTop=a.scrollHeight,a)})}async function Q(c){const{docId:b,title:C}=c.detail;if(!b||!C)return;const N={id:`doc-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,label:C,blockIds:[b],type:"document"};re.update(z=>[...z,N]),console.log("Added document reference via event:",N)}function Y(){B&&clearTimeout(B),B=window.setTimeout(()=>{const c=Nn();c.length>0?(k=c,t(6,w=!0),console.log("Selection changed (debounced), FOUND blocks, Enabling button. IDs:",k)):console.log("Selection changed (debounced), NO valid blocks found, button state remains:",w)},150)}function Fe(){var N;if(!w||k.length===0)return;const c=`sel-${Date.now()}-${Math.random().toString(36).substring(2,7)}`,C=`选区 ${x(re).filter(z=>z.type==="selection").length+1}`,E={id:c,label:C,blockIds:[...k],type:"selection"};console.log("[addSelectionReference] About to update referenceStore. Current state:",x(re)),console.log("[addSelectionReference] Adding new reference:",E),re.update(z=>[...z,E]),console.log("[addSelectionReference] Updated referenceStore state:",x(re)),k=[],t(6,w=!1),(N=window.getSelection())==null||N.removeAllRanges()}function Ge(){t(7,F=!F)}function ne(c){console.log("[ContextMenu] handleContextMenu triggered.");const C=c.target.closest(".message");if(console.log("[ContextMenu] Closest message element:",C),C){c.preventDefault(),c.stopPropagation();const E=C.dataset.messageId;if(console.log("[ContextMenu] Attempting to get message ID:",E),!E){console.warn("[ContextMenu] Could not find data-message-id attribute."),H();return}_=E,t(10,G=c.clientX),t(9,J=c.clientY),console.log(`[ContextMenu] Setting state: show=true, targetId=${_}, pos=(${G}, ${J})`),t(8,q=!0),console.log(`[ContextMenu] State set. showContextMenu is now: ${q}`),setTimeout(()=>{window.addEventListener("click",D,{once:!0}),window.addEventListener("contextmenu",D,{once:!0}),console.log("[ContextMenu] Added BOTH hide listeners inside setTimeout")},0)}else console.log("[ContextMenu] Right-click was not inside a .message element."),H()}function H(){t(8,q=!1),_=null,console.log("[ContextMenu] hideContextMenu called")}function D(c){H()}async function L(){if(console.log(`[ContextMenu] copyMessage called. contextTargetMessageId: ${_}`),!_)return;const c=x(l).find(b=>b.id===_);if(console.log("[Copy] Found message object:",c),c&&typeof c.content=="string")try{const b=c.content;console.log("[Copy] Attempting to write to clipboard:",b),await navigator.clipboard.writeText(b),console.log("[Copy] Successfully wrote to clipboard.")}catch(b){console.error("[Copy] Failed to copy message content:",b),m="复制失败: "+b.message}else console.warn("[Copy] Message not found or content is not a string.",_),m="无法复制：未找到消息或消息无有效内容。";H(),window.removeEventListener("click",D),window.removeEventListener("contextmenu",D)}function ye(){if(console.log(`[ContextMenu] deleteMessageHandler called. contextTargetMessageId: ${_}`),!_)return;const c=_;console.log(`[Delete] Target ID for deletion: ${c}`);const b=x(l);console.log("[Delete] Message IDs BEFORE filtering:",b.map(E=>E.id));const C=b.filter(E=>E.id!==c);console.log("[Delete] Message IDs AFTER filtering (before set):",C.map(E=>E.id)),b.length===C.length?console.warn(`[Delete] Message with ID ${c} not found in current messages array. Filter had no effect.`):(console.log("[Delete] Filter successful. Calling messages.set()..."),l.set(C),console.log("[Delete] messages.set() called. Current IDs in store:",x(l).map(E=>E.id))),H(),window.removeEventListener("click",D),window.removeEventListener("contextmenu",D)}async function Qt(){try{const c=x(l);console.log(`[saveActiveState] Attempting to save ${c.length} messages to ${Ee}. Data:`,JSON.stringify(c)),await o.saveData(Ee,c),console.log(`[saveActiveState] Save attempt finished for ${Ee}`)}catch(c){console.error("[saveActiveState] Error saving active conversation state:",c)}}async function ot(){try{console.log(`[clearActiveState] Clearing persisted state in ${Ee}`),await o.saveData(Ee,null)}catch(c){console.error("[clearActiveState] Error clearing active conversation state:",c)}}const Wt=c=>{K(c.id),t(7,F=!1)},Xt=(c,b)=>j(c.id,b),Zt=c=>j(g,c);function en(c){ct[c?"unshift":"push"](()=>{a=c,t(3,a)})}function tn(){r=this.value,t(2,r)}const nn=c=>{c.key==="Enter"&&!c.shiftKey&&(c.preventDefault(),Ue())};return n.$$set=c=>{"pluginData"in c&&t(23,o=c.pluginData),"initialActiveMessages"in c&&t(24,i=c.initialActiveMessages)},n.$$.update=()=>{if(n.$$.dirty[0]&33554435){const c=s;O&&clearTimeout(O),t(25,O=window.setTimeout(()=>{g===null&&c.length>1&&(console.log("[Debounced Save] Conditions met, calling saveActiveConversationState..."),Qt())},Mn))}},[g,s,r,a,u,f,w,F,q,J,G,l,be,te,K,j,Ue,Q,Fe,Ge,ne,L,ye,o,i,O,Wt,Xt,Zt,en,tn,nn]}class Ln extends nt{constructor(e){super(),tt(this,e,On,Bn,Ke,{pluginData:23,initialActiveMessages:24},null,[-1,-1])}}function Ot(n){let e,t;return{c(){e=y("span"),t=ae(n[3]),d(e,"class","status-message svelte-136cw2s")},m(s,o){R(s,e,o),h(e,t)},p(s,o){o&8&&et(t,s[3])},d(s){s&&T(e)}}}function Pn(n){let e,t,s,o,i,l,r,a,u,p,f,g,v,m,k,w,B,F,O,q,J,G,_,V,$,ee,he,be,te,K=n[3]&&Ot(n);return{c(){e=y("div"),t=y("h2"),t.textContent="AI 助手设置",s=S(),o=y("div"),i=y("label"),i.textContent="AI API Endpoint URL:",l=S(),r=y("input"),a=S(),u=y("p"),u.textContent="请输入您要使用的 AI 服务的完整 URL。",p=S(),f=y("div"),g=y("label"),g.textContent="API Key:",v=S(),m=y("input"),k=S(),w=y("p"),w.textContent="您的 API Key 将被保存在本地配置文件中。",B=S(),F=y("div"),O=y("label"),O.textContent="模型名称:",q=S(),J=y("input"),G=S(),_=y("p"),_.textContent="请输入要调用的具体模型名称。",V=S(),$=y("div"),ee=y("button"),ee.textContent="保存设置",he=S(),K&&K.c(),d(t,"class","svelte-136cw2s"),d(i,"for","api-url"),d(i,"class","svelte-136cw2s"),d(r,"id","api-url"),d(r,"type","text"),d(r,"placeholder","例如: https://api.openai.com/v1/chat/completions"),d(r,"class","b3-text-field svelte-136cw2s"),d(u,"class","description svelte-136cw2s"),d(o,"class","form-item svelte-136cw2s"),d(g,"for","api-key"),d(g,"class","svelte-136cw2s"),d(m,"id","api-key"),d(m,"type","password"),d(m,"placeholder","请输入您的 API Key"),d(m,"class","b3-text-field svelte-136cw2s"),d(w,"class","description svelte-136cw2s"),d(f,"class","form-item svelte-136cw2s"),d(O,"for","model-name"),d(O,"class","svelte-136cw2s"),d(J,"id","model-name"),d(J,"type","text"),d(J,"placeholder","例如: deepseek-chat, gpt-4o, ..."),d(J,"class","b3-text-field svelte-136cw2s"),d(_,"class","description svelte-136cw2s"),d(F,"class","form-item svelte-136cw2s"),d(ee,"class","b3-button b3-button--primary"),d($,"class","actions svelte-136cw2s"),d(e,"class","settings-panel svelte-136cw2s")},m(j,ue){R(j,e,ue),h(e,t),h(e,s),h(e,o),h(o,i),h(o,l),h(o,r),me(r,n[0]),h(o,a),h(o,u),h(e,p),h(e,f),h(f,g),h(f,v),h(f,m),me(m,n[1]),h(f,k),h(f,w),h(e,B),h(e,F),h(F,O),h(F,q),h(F,J),me(J,n[2]),h(F,G),h(F,_),h(e,V),h(e,$),h($,ee),h($,he),K&&K.m($,null),be||(te=[P(r,"input",n[8]),P(m,"input",n[9]),P(J,"input",n[10]),P(ee,"click",n[4])],be=!0)},p(j,[ue]){ue&1&&r.value!==j[0]&&me(r,j[0]),ue&2&&m.value!==j[1]&&me(m,j[1]),ue&4&&J.value!==j[2]&&me(J,j[2]),j[3]?K?K.p(j,ue):(K=Ot(j),K.c(),K.m($,null)):K&&(K.d(1),K=null)},i:Z,o:Z,d(j){j&&T(e),K&&K.d(),be=!1,fe(te)}}}function jn(n,e,t){let{loadSettings:s}=e,{saveSettings:o}=e,{currentSettings:i}=e,l="",r="",a="",u="";ft(async()=>{if(i)t(0,l=i.apiUrl||""),t(1,r=i.apiKey||""),t(2,a=i.modelName||"deepseek-chat");else{const m=await s();t(0,l=m.apiUrl||""),t(1,r=m.apiKey||""),t(2,a=m.modelName||"deepseek-chat")}});async function p(){try{await o({apiUrl:l,apiKey:r,modelName:a}),t(3,u="设置已保存！"),setTimeout(()=>t(3,u=""),3e3)}catch(m){t(3,u=`保存失败: ${m.message}`)}}function f(){l=this.value,t(0,l)}function g(){r=this.value,t(1,r)}function v(){a=this.value,t(2,a)}return n.$$set=m=>{"loadSettings"in m&&t(5,s=m.loadSettings),"saveSettings"in m&&t(6,o=m.saveSettings),"currentSettings"in m&&t(7,i=m.currentSettings)},[l,r,a,u,p,s,o,i,f,g,v]}class Un extends nt{constructor(e){super(),tt(this,e,jn,Pn,Ke,{loadSettings:5,saveSettings:6,currentSettings:7})}}const Lt="ai-assistant-config",rt="ai-assistant-conversations",Pt="activeUnsavedConversation",Hn={apiUrl:"",apiKey:"",modelName:"deepseek-chat"},qn="ai_assistant_dock";class Jn extends lt.Plugin{constructor(){super(...arguments);_e(this,"isMobile");_e(this,"settings");_e(this,"settingsDialog",null);_e(this,"conversationsUnsubscribe");_e(this,"switchProtyleCallback",this.handleSwitchProtyle.bind(this))}async onload(){console.log("--- siyuan-plugin-canvas onload --- Fired");const t=lt.getFrontend();this.isMobile=t==="mobile"||t==="browser-mobile",await this.loadSettings(),await this.loadConversations();const s=await this.loadData(Pt);console.log(`[Index.onload] Loaded initial active messages from ${Pt}:`,JSON.stringify(s)),this.conversationsUnsubscribe=Oe.subscribe(async o=>{!o||o.length,await this.saveData(rt,o)}),console.log("Subscribed to conversationsStore for auto-saving."),this.eventBus.on("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' added."),this.addIcons('<symbol id="iconComment" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M896 128H128C83.8 128 48 163.8 48 208v448c0 44.2 35.8 80 80 80h176v128l237.6-128H896c44.2 0 80-35.8 80-80V208c0-44.2-35.8-80-80-80z m-48 480H581.8L512 651.7V608H176V256h672v352z" fill="#515151"></path></symbol>'),this.addDock({config:{position:"RightTop",size:{width:300,height:0},icon:"iconComment",title:this.isMobile?"AI助手":`AI助手(${this.name})`,hotkey:"⌥⌘A"},data:{plugin:this,saveData:this.saveData.bind(this),loadData:this.loadData.bind(this),initialActiveMessages:s,saveConversations:this.saveConversations.bind(this)},type:qn,init(o){new Ln({target:o.element,props:{pluginData:o.data,initialActiveMessages:o.data.initialActiveMessages}}),console.log("AI Assistant Dock initialized with Svelte component and required data.")},destroy(){console.log("AI Assistant Dock destroyed")}}),console.log("Icons and Dock added.")}onLayoutReady(){console.log("--- siyuan-plugin-canvas onLayoutReady --- Fired"),setTimeout(()=>{console.log("Executing updateCurrentDocIdFromActiveTab after 500ms delay..."),this.updateCurrentDocIdFromActiveTab()},500)}handleSwitchProtyle({detail:t}){if(console.log("--- handleSwitchProtyle --- Fired"),console.log("Switch Protyle Event detail:",t),t&&t.protyle&&t.protyle.block&&t.protyle.block.rootID){const s=t.protyle.block.rootID;if(console.log(`Doc ID found in protyle.block.rootID: ${s}`),ze.set(s),console.log(`Current document ID updated via switch-protyle: ${s}`),t.protyle.path){const o=t.protyle.path;console.log(`Doc Path found in protyle.path: ${o}`),Qe.set(o),console.log(`Current document Path updated via switch-protyle: ${o}`)}else console.warn("Doc Path not found in protyle detail."),Qe.set(null)}else console.warn("Could not find document ID (rootID) in switch-protyle event detail."),ze.set(null),Qe.set(null)}updateCurrentDocIdFromActiveTab(){var t;console.log("Attempting to get doc ID from active tab...");try{const s=document.querySelector(".layout__tab--active .protyle:not(.fn__none)");if(s){console.log("Active protyle tab element found.");let o=s,i=o==null?void 0:o.protyle;for(;o&&!i;)i=o==null?void 0:o.protyle,o=o.parentElement;if((t=i==null?void 0:i.block)!=null&&t.rootID){const l=i.block.rootID;ze.set(l),console.log(`Updated doc ID from active tab in onLayoutReady: ${l}`)}else{console.log("Found active protyle tab, but failed to get instance or rootID.",{protyleInstance:i});const l=s.getAttribute("data-node-id");l&&console.log(`Found node-id on active tab: ${l}. Attempting to get root via API.`)}}else console.log("No active protyle tab element found in onLayoutReady.")}catch(s){console.error("Error getting doc ID from active tab:",s)}}openSetting(){this.settingsDialog||(this.settingsDialog=new lt.Dialog({title:"AI 助手设置",content:'<div id="ai-assistant-settings" style="height: 100%;"></div>',width:this.isMobile?"92vw":"600px",destroyCallback:()=>{this.settingsDialog=null}}),new Un({target:this.settingsDialog.element.querySelector("#ai-assistant-settings"),props:{loadSettings:this.loadSettings.bind(this),saveSettings:this.saveSettings.bind(this),currentSettings:this.settings}}))}async loadSettings(){const t=await this.loadData(Lt);return this.settings=Object.assign({},Hn,t),Ze.set(this.settings),console.log("AI Assistant settings loaded and store updated:",this.settings),this.settings}async saveSettings(t){this.settings=t,await this.saveData(Lt,this.settings),Ze.set(this.settings),console.log("AI Assistant settings saved and store updated.")}async loadConversations(){const t=await this.loadData(rt)||[];Oe.set(t),console.log(`${t.length} conversations loaded.`)}async saveConversations(t){await this.saveData(rt,t),Oe.set(t),console.log(`Conversations saved via explicit call (${t.length} total).`)}onunload(){console.log("--- siyuan-plugin-canvas onunload --- Fired"),this.eventBus.off("switch-protyle",this.switchProtyleCallback),console.log("Event listener for 'switch-protyle' removed."),this.conversationsUnsubscribe&&(this.conversationsUnsubscribe(),console.log("Unsubscribed from conversationsStore.")),this.settingsDialog&&this.settingsDialog.destroy()}}module.exports=Jn;
