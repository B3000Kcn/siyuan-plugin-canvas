# 思源笔记画布插件 - 项目计划

## 1. 项目目标与愿景

创建一个名为 "siyuan-plugin-canvas" 的思源笔记插件，其核心目标是在思源笔记界面中集成一个类似 Cursor IDE 或 ChatGPT 的交互式 AI 助手体验。用户可以通过一个专门的界面（如侧边栏）与 AI 对话，让 AI 理解当前笔记上下文并直接对笔记内容进行智能操作（增删改查、总结、翻译等），从而提升笔记处理和创作效率。

## 2. 核心功能

*   **集成式 AI 交互界面：**
    *   在思源笔记 UI 中添加一个新的、持久化的区域（可能是侧边栏、底部面板或悬浮窗），用于展示与 AI 的对话历史和输入框。
    *   **上下文引用栏 (Context Reference Bar):**
        *   在 AI 交互界面中增加一个专门区域，用于清晰展示当前操作或讨论的上下文引用。
        *   **引用单位 (选中内容):** 以包含用户选中文本的**整个块**作为引用单位。
        *   **标签格式:** 引用标签应指示块在当前文档中的序号范围（例如，"块 3-5"）。
        *   **多标签支持:** 允许添加和管理多个选中文本的块范围引用标签。
        *   **标签生命周期:**
            *   **选中内容标签:** 发送消息后自动清除。
            *   **文档引用标签 (未来):** 不会自动清除，需持久化。
*   **上下文感知：**
    *   插件能够获取当前活跃的思源编辑器（Protyle）上下文，包括但不限于：
        *   当前打开的文档 ID。
        *   用户选中的文本内容或块 ID。
        *   光标所在位置。
    *   将这些上下文信息连同用户的指令一起发送给 AI。
*   **内容直接操作：**
    *   AI 助手根据用户的自然语言指令，能够调用思源的 API 对笔记内容执行具体操作：
        *   **增加：** 在指定位置（如选中文本后、某块之后）插入新的文本块、标题、列表、代码块等。
        *   **删除：** 移除用户指定的文本或块。
        *   **修改：** 编辑现有块的内容，如修正错别字、调整措辞、改变块格式。
        *   **查询/分析：** 对选定内容或整个文档进行总结、提取关键信息、翻译、解释概念、生成大纲等。
*   **多轮对话支持：**
    *   支持在一个连续的会话中进行多轮问答和指令下达，AI 能够理解之前的对话历史。

## 3. 技术实现思路

*   **前端界面：**
    *   使用 Siyuan 插件 API（如 `addDock`, `addTab`, 或自定义对话框 `Dialog`）创建交互界面。
    *   推荐使用 Svelte 框架（结合 Vite 模板）构建 UI 组件，实现聊天记录展示、用户输入等。
*   **上下文获取：**
    *   利用 Siyuan 插件 API 和 DOM 查询（谨慎使用）来获取编辑器状态、选中内容 (`window.getSelection`)、当前文档/块信息（如通过 `eventBus` 监听 `click-blockicon` 事件或检查 `protyle` 对象的属性）。
*   **AI 模型集成：**
    *   通过 `fetch` API 调用外部大语言模型（LLM）的 API（例如 OpenAI GPT 系列、Google Gemini API 或其他可用的服务）。
    *   需要在插件设置中允许用户配置 API Key 和选择模型。
    *   设计合适的 Prompt Engineering 策略，将用户指令、笔记上下文有效传递给 AI。
*   **指令解析与执行：**
    *   接收 AI 返回的结果（通常是文本或结构化数据）。
    *   解析 AI 的意图，将其转换为对思源内核 API (通过 `fetch` 调用后端 `/api/...` 接口) 的具体调用请求。例如：
        *   调用 `/api/block/insertBlock` 插入块。
        *   调用 `/api/block/updateBlock` 更新块。
        *   调用 `/api/block/deleteBlock` 删除块。
        *   可能需要组合多个 API 调用来完成复杂任务。
*   **状态管理与反馈：**
    *   管理 AI 请求的状态（等待、处理中、完成、失败）。
    *   在交互界面中向用户提供清晰的操作反馈。
    *   处理 API 调用错误和网络问题。

## 4. 潜在挑战

*   **上下文准确性：** 如何精确、高效地获取用户意图相关的笔记上下文。
*   **AI 指令理解与转换：** 如何让 AI 稳定地理解用户模糊的指令，并将其可靠地转换为具体的 Siyuan API 调用序列。这可能需要复杂的 Prompt 设计和对 AI 输出的后处理。
*   **API 限制与成本：** 外部 AI API 的调用频率限制和费用问题。
*   **用户体验：** 如何设计流畅自然的交互流程，避免 AI 操作带来的干扰或误操作。
*   **思源 API 变动：** 依赖的（尤其是非开放）内核 API 可能在思源版本更新中发生变化。